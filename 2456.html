<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 2456: Incorrect exception specifications for 'swap' throughout library</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<p>Revised 2016-11-16 at 09:11:53 UTC</p>
<hr>
<h3><a name="2456" href="2456">2456.</a> Incorrect exception specifications for '<tt>swap</tt>' throughout library</h3>
<p><b>Section:</b> 20.2 [utility], 20.4.2 [pairs.pair], 20.5 [tuple], 23.3.7 [array], 23.6.4 [queue], 23.6.5 [priority.queue], 23.6.6 [stack] <b>Status:</b> <a href="lwg-active.html#Resolved">Resolved</a>
 <b>Submitter:</b> Richard Smith <b>Opened:</b> 2014-11-14 <b>Last modified:</b> 2016-11-16</p>
<p><b>Priority: </b>1
</p>
<p><b>View all other</b> <a href="lwg-index.html#utility">issues</a> in [utility].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Resolved">Resolved</a> status.</p>
<p><b>Discussion:</b></p>
<p>
We have this antipattern in various library classes:
</p>
<blockquote><pre>
void swap(priority_queue&amp; q) noexcept(
    noexcept(swap(c, q.c)) &amp;&amp; noexcept(swap(comp, q.comp)))
</pre></blockquote>
<p>
This doesn't work. The unqualified lookup for 'swap' finds the member named 'swap', and that suppresses ADL, 
so the exception specification is always ill-formed because you can't call the member 'swap' with two arguments.
<p/>
Relevant history on the core language side:
<p/>
This used to be ill-formed due to 3.3.7 [basic.scope.class] p1 rule 2: "A name <tt>N</tt> used in a class 
<tt>S</tt> shall refer to the same declaration in its context and when re-evaluated in the completed scope of <tt>S</tt>. 
No diagnostic is required for a violation of this rule."
<p/>
Core issue 1330 introduced delay-parsing for exception specifications. Due to the 3.3.7 [basic.scope.class] rules, 
this shouldn't have changed the behavior of any conforming programs. But it changes the behavior in the non-conforming 
case from "no diagnostic required" to "diagnostic required", so implementations that implement core issue 1330 are now 
required to diagnose the ill-formed declarations in the standard library.
<p/>
Suggested resolution:
<p/>
Add an <tt>is_nothrow_swappable</tt> trait, and use it throughout the library in place of these <tt>noexcept</tt> expressions.
</p>

<p><i>[2015-02, Cologne]</i></p>

<p>
No action for now; we intend to have papers for Lenexa.
</p>

<p><i>[2015-05, Lenexa]</i></p>

<p>
Move to Open.
<p/>
Daniel: A first paper (<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/n4426.html">N4426</a>) exists 
to suggest some ways of solving this issue.
</p>

<p><i>[2015-10, Kona, Daniel comments]</i></p>

<p>
A revised paper (<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/n4511.html">N4511</a>) has been provided 
</p>

<p><i>[2015-12-16, Daniel comments]</i></p>

<p>
Revision 2 (<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2016/p0185r0.html">P0185R0</a>) will available for the
mid February 2016 mailing.
</p>

<p><i>[2016-03, Jacksonville]</i></p>

<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2016/p0185r1.html">P0185R1</a> was adopted in Jacksonville.


<p><b>Proposed resolution:</b></p>





</body>
</html>
