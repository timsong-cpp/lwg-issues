<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3789: Precondition of (not replaced) operator delete[]</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3789" href="lwg-active.html#3789">3789.</a> Precondition of (not replaced) <tt>operator delete[]</tt></h3>
<p><b>Section:</b> 17.7.3.3 <a href="https://timsong-cpp.github.io/cppwp/new.delete.array">[new.delete.array]</a> <b>Status:</b> <a href="lwg-active.html#NAD">Tentatively NAD</a>
 <b>Submitter:</b> blacktea hamburger <b>Opened:</b> 2022-09-25 <b>Last modified:</b> 2022-10-10 10:43:23 UTC</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#new.delete.array">issues</a> in [new.delete.array].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Tentatively NAD">Tentatively NAD</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Consider (<tt>operator delete[](std::size_t)</tt> and <tt>operator new(std::size_t)</tt> is not replaced):
</p>
<blockquote><pre>
operator delete[](operator new(1));
</pre></blockquote>
<p>
(even not replaced) <tt>void* operator new(std::size_t)</tt> does not return 
<tt>void* operator new[](std::size_t)</tt>. So the behavior is undefined according 
to 17.7.3.3 <a href="https://timsong-cpp.github.io/cppwp/new.delete.array">[new.delete.array]</a> paragraph 9:
</p>
<blockquote><p>
<i>Preconditions</i>: <tt>ptr</tt> is a null pointer or its value represents the address of a block of 
memory allocated by an earlier call to a (possibly replaced) <tt>operator new[](std::size_t)</tt> or 
<tt>operator new[](std::size_t, std::align_val_t)</tt> which has not been invalidated by an intervening 
call to <tt>operator delete[]</tt>.
</p></blockquote>
<p>
However, consider (<tt>operator delete(std::size_t)</tt> and <tt>operator new[](std::size_t)</tt> is not replaced):
</p>
<blockquote><pre>
operator delete(operator new[](1));
</pre></blockquote>
<p>
(not replaced) <tt>operator new[](std::size_t)</tt> simply returns <tt>operator new(std::size_t)</tt> 
according to 17.7.3.3 <a href="https://timsong-cpp.github.io/cppwp/new.delete.array">[new.delete.array]</a> paragraph 4:
</p>
<blockquote><p>
<i>Default behavior</i>: Returns <tt>operator new(size)</tt>, or <tt>operator new(size, alignment)</tt>, respectively.
</p></blockquote>
<p>
So it is well-formed according to 17.7.3.2 <a href="https://timsong-cpp.github.io/cppwp/new.delete.single">[new.delete.single]</a> paragraph 10:
</p>
<blockquote><p>
<i>Preconditions</i>: <tt>ptr</tt> is a null pointer or its value represents the address of a block of memory 
allocated by an earlier call to a (possibly replaced) <tt>operator new(std::size_t)</tt> or 
<tt>operator new(std::size_t, std::align_val_t)</tt> which has not been invalidated by an intervening call to 
<tt>operator delete</tt>.
</p></blockquote>
<p>
The behavior should be consistent.
</p>

<p><i>[2022-10-10; Reflector poll]</i></p>

<p>Set status to "Tentatively NAD" after reflector poll.</p>
<p>
"No reason to carve out an exception covering a case on something which canâ€™t
be observed by the program (whether the allocation operators are replaced).
This just makes things more complicated for no good reason."
"This would require changes to sanitizers and other dynamic analyzers,
for zero practical benefit (except allowing bad code to go un-diagnosed)."
</p>



<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N4917">N4917</a>.
</p>

<ol>
<li><p>Modify 17.7.3.3 <a href="https://timsong-cpp.github.io/cppwp/new.delete.array">[new.delete.array]</a> as indicated:</p>

<blockquote>
<pre>
void operator delete[](void* ptr) noexcept;
void operator delete[](void* ptr, std::size_t size) noexcept;
void operator delete[](void* ptr, std::align_val_t alignment) noexcept;
void operator delete[](void* ptr, std::size_t size, std::align_val_t alignment) noexcept;
</pre>
<blockquote>
<p>
-9- <i>Preconditions</i>: <tt>ptr</tt> is a null pointer or its value represents the address 
of a block of memory allocated by an earlier call to a (possibly replaced) 
<tt>operator new[](std::size_t)</tt><ins>,</ins> <del>or</del> 
<tt>operator new[](std::size_t, std::align_val_t)</tt><ins>, (not replaced) 
<tt>operator new(std::size_t)</tt>, or <tt>operator new(std::size_t, std::align_val_t)</tt></ins>
which has not been invalidated by an intervening call to <tt>operator delete[]</tt>.
<p/>
[&hellip;]
</p>
</blockquote>
</blockquote>
</li>
</ol>





</body>
</html>
