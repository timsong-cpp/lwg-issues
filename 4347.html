<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Issue 4347: task's stop source is always created</title>
<meta property="og:title" content="Issue 4347: task's stop source is always created">
<meta property="og:description" content="C++ library issue. Status: New">
<meta property="og:url" content="https://timsong-cpp.github.io/lwg-issues/4347.html">
<meta property="og:type" content="website">
<meta property="og:image" content="http://cplusplus.github.io/LWG/images/cpp_logo.png">
<meta property="og:image:alt" content="C++ logo">
<style>
  p {text-align:justify}
  li {text-align:justify}
  pre code.backtick::before { content: "`" }
  pre code.backtick::after { content: "`" }
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table.issues-index { border: 1px solid; border-collapse: collapse; }
  table.issues-index th { text-align: center; padding: 4px; border: 1px solid; }
  table.issues-index td { padding: 4px; border: 1px solid; }
  table.issues-index td:nth-child(1) { text-align: right; }
  table.issues-index td:nth-child(2) { text-align: left; }
  table.issues-index td:nth-child(3) { text-align: left; }
  table.issues-index td:nth-child(4) { text-align: left; }
  table.issues-index td:nth-child(5) { text-align: center; }
  table.issues-index td:nth-child(6) { text-align: center; }
  table.issues-index td:nth-child(7) { text-align: left; }
  table.issues-index td:nth-child(5) span.no-pr { color: red; }
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3 id="4347"><a href="lwg-active.html#4347">4347</a>. <code>task</code>'s stop source is always created</h3>
<p><b>Section:</b> 33.13.6.5 <a href="https://timsong-cpp.github.io/cppwp/task.promise">[task.promise]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Dietmar KÃ¼hl <b>Opened:</b> 2025-09-01 <b>Last modified:</b> 2025-10-27</p>
<p><b>Priority: </b>2
</p>
<p><b>View other</b> <a href="lwg-index-open.html#task.promise">active issues</a> in [task.promise].</p>
<p><b>View all other</b> <a href="lwg-index.html#task.promise">issues</a> in [task.promise].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<b>Addresses <a href="https://github.com/cplusplus/nbballot/issues/957">US 257-382</a></b>
<p>
The type <code>task&lt;...&gt;::promise_type</code> has exposition-only
members <code><i>source</i></code> and <code><i>token</i></code>.
These can be interpreted as always existing which would be a
performance issue for former and an unnecessary constraints for the
latter (because stop tokens aren't required to be default constructible).
</p>
<p>
The intent is that the stop token obtained from the
<code>get_stop_token</code> query of the receiver's environment is
used. Only if this type is different from the <code>task</code>'s
<code>stop_token_type</code> a stop source of type
<code>stop_source_type</code> needs to be created when the
<code>get_stop_token</code> query is used on the promise type's
environment. The stop token doesn't need to be stored at all: it
can either be obtained from the receiver's environment or from the
stop source. The fix is to show the stop source as an optionally
present member of of the operation state and it should be of type
<code>std::optional&lt;stop_source_type&gt;</code> to imply that
it is only created when accessed.
</p>

<p><i>[2025-10-17; Reflector poll.]</i></p>

<p>
Set priority to 2 after reflector poll.
</p>


<p id="res-4347"><b>Proposed resolution:</b></p>
<p>
</p>





</body>
</html>
