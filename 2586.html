<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 2586: Wrong value category used in scoped_allocator_adaptor::construct()</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="2586" href="lwg-defects.html#2586">2586.</a> Wrong value category used in <tt>scoped_allocator_adaptor::construct()</tt></h3>
<p><b>Section:</b> 19.13.4 <a href="https://timsong-cpp.github.io/cppwp/allocator.adaptor.members">[allocator.adaptor.members]</a>, 19.10.8.2 <a href="https://timsong-cpp.github.io/cppwp/allocator.uses.construction">[allocator.uses.construction]</a> <b>Status:</b> <a href="lwg-active.html#C++17">C++17</a>
 <b>Submitter:</b> Jonathan Wakely <b>Opened:</b> 2016-01-15 <b>Last modified:</b> 2018-08-20 12:41:52 UTC</p>
<p><b>Priority: </b>0
</p>
<p><b>View all other</b> <a href="lwg-index.html#allocator.adaptor.members">issues</a> in [allocator.adaptor.members].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#C++17">C++17</a> status.</p>
<p><b>Discussion:</b></p>
<p>
19.13.4 <a href="https://timsong-cpp.github.io/cppwp/allocator.adaptor.members">[allocator.adaptor.members]</a> p9 says that the <tt>is_constructible</tt>
tests are done using <tt>inner_allocator_type</tt>, which checks for
construction from an rvalue, but then the constructor is passed
<tt>inner_allocator()</tt> which returns a non-<tt>const</tt> lvalue reference. The
value categories should be consistent, otherwise this fails to
compile:
</p>
<blockquote><pre>
#include &lt;memory&gt;
#include &lt;scoped_allocator&gt;

struct X {
  using allocator_type = std::allocator&lt;X&gt;;
  X(std::allocator_arg_t, allocator_type&amp;&amp;) { }
  X(allocator_type&amp;) { }
};

int main() {
  std::scoped_allocator_adaptor&lt;std::allocator&lt;X&gt;&gt; sa;
  sa.construct(sa.allocate(1));
}
</pre></blockquote>
<p>
<tt>uses_allocator&lt;X, decltype(sa)::inner_allocator_type&gt;></tt> is true, because
it can be constructed from an rvalue of the allocator type, so bullet (9.1) doesn't apply.
<p/>
<tt>is_constructible&lt;X, allocator_arg_t, decltype(sa)::inner_allocator_type></tt> 
is true, so bullet (9.2) applies.
That means we try to construct the object passing it
<tt>sa.inner_allocator()</tt> which is an lvalue reference, so it fails.
<p/>
The <tt>is_constructible</tt> checks should use an lvalue reference, as that's
what's actually going to be used.
<p/>
I don't think the same problem exists in the related wording in
19.10.8.2 <a href="https://timsong-cpp.github.io/cppwp/allocator.uses.construction">[allocator.uses.construction]</a> if we assume that the value categories
of <tt>v1, v2, ..., vN</tt> and <tt>alloc</tt> are meant to be preserved, so that the
<tt>is_constructible</tt> traits and the initialization expressions match.
However, it does say "an allocator <tt>alloc</tt> of type <tt>Alloc</tt>" and if <tt>Alloc</tt>
is an reference type then it's not an allocator, so I suggest a small tweak there too.
</p>

<p><i>[2016-02, Issues Telecon]</i></p>

<p>
Strike first paragraph of PR, and move to Tentatively Ready.
</p>

<strong>Original Resolution [SUPERSEDED]:</strong>
<blockquote class="note">
<ol>
<li><p>Change 19.10.8.2 <a href="https://timsong-cpp.github.io/cppwp/allocator.uses.construction">[allocator.uses.construction]</a> p1:</p>
<blockquote>
<p>
-1- Uses-allocator construction with allocator <tt>Alloc</tt> refers to the construction of an object <tt>obj</tt> 
of type <tt>T</tt>, using constructor arguments <tt>v1, v2, ..., vN</tt> of types <tt>V1, V2, ..., VN</tt>, respectively, 
and an allocator <ins>(or reference to an allocator)</ins> <tt>alloc</tt> of type <tt>Alloc</tt>, according to the 
following rules:
</p>
</blockquote>
</li>

<li><p>Change the 2nd and 3rd bullets in 19.13.4 <a href="https://timsong-cpp.github.io/cppwp/allocator.adaptor.members">[allocator.adaptor.members]</a> p9 to add two lvalue-references:</p>

<blockquote>
<ol style="list-style-type: none">
<li><p>(9.2) &mdash; Otherwise, if <tt>uses_allocator&lt;T, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T, allocator_arg_t, inner_allocator_type<ins>&amp;</ins>, Args...&gt;::value</tt> is <tt>true</tt>, calls 
<tt><i>OUTERMOST_ALLOC_TRAITS</i>(*this)::construct(<i>OUTERMOST</i>(*this), p, allocator_arg, inner_allocator(), 
std::forward&lt;Args&gt;(args)...)</tt>.</p></li>
<li><p>(9.3) &mdash; Otherwise, if <tt>uses_allocator&lt;T, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T, Args..., inner_allocator_type<ins>&amp;</ins>&gt;::value</tt> is <tt>true</tt>, calls 
<tt><i>OUTERMOST_ALLOC_TRAITS</i>(*this)::construct(<i>OUTERMOST</i>(*this), p, std::forward&lt;Args&gt;(args)...,
inner_allocator())</tt>.</p></li>
</ol>
</blockquote>
</li>

<li><p>Change the 2nd, 3rd, 6th, and 7th bullets in 19.13.4 <a href="https://timsong-cpp.github.io/cppwp/allocator.adaptor.members">[allocator.adaptor.members]</a> p11 to
add four lvalue-references:</p>

<blockquote>
<ol style="list-style-type: none">
<li><p>(11.2) &mdash; Otherwise, if <tt>uses_allocator&lt;T1, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T1, allocator_arg_t, inner_allocator_type<ins>&amp;</ins>, Args1...&gt;::value</tt> is <tt>true</tt>, 
then <tt>xprime</tt> is <tt>tuple_cat(tuple&lt;allocator_arg_t, inner_allocator_type&amp;&gt;(allocator_arg, 
inner_allocator()), std::move(x))</tt>.</p></li>
<li><p>(11.3) &mdash; Otherwise, if <tt>uses_allocator&lt;T1, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T1, Args1..., inner_allocator_type<ins>&amp;</ins>&gt;::value</tt> is <tt>true</tt>, then 
<tt>xprime</tt> is <tt>tuple_cat(std::move(x), tuple&lt;inner_allocator_type&amp;&gt;(inner_allocator()))</tt>.</p></li>
<li><p>[&hellip;]</p></li>
<li><p>(11.6) &mdash; Otherwise, if <tt>uses_allocator&lt;T2, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T2, allocator_arg_t, inner_allocator_type<ins>&amp;</ins>, Args2...&gt;::value</tt> is <tt>true</tt>, 
then <tt>yprime</tt> is <tt>tuple_cat(tuple&lt;allocator_arg_t, inner_allocator_type&amp;&gt;(allocator_arg, 
inner_allocator()), std::move(y))</tt>.</p></li>
<li><p>(11.7) &mdash; Otherwise, if <tt>uses_allocator&lt;T2, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T2, Args2..., inner_allocator_type<ins>&amp;</ins>&gt;::value</tt> is <tt>true</tt>, then 
<tt>yprime</tt> is <tt>tuple_cat(std::move(y), tuple&lt;inner_allocator_type&amp;&gt;(inner_allocator()))</tt>.</p></li>
</ol>
</blockquote>
</li>
</ol>
</blockquote>

<p><i>[2016-02, Issues Telecon]</i></p>

<p>
P0; move to Tentatively Ready.
</p>


<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to N4567.
</p>

<ol>
<li><p>Change the 2nd and 3rd bullets in 19.13.4 <a href="https://timsong-cpp.github.io/cppwp/allocator.adaptor.members">[allocator.adaptor.members]</a> p9 to add two lvalue-references:</p>

<blockquote>
<ol style="list-style-type: none">
<li><p>(9.2) &mdash; Otherwise, if <tt>uses_allocator&lt;T, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T, allocator_arg_t, inner_allocator_type<ins>&amp;</ins>, Args...&gt;::value</tt> is <tt>true</tt>, calls 
<tt><i>OUTERMOST_ALLOC_TRAITS</i>(*this)::construct(<i>OUTERMOST</i>(*this), p, allocator_arg, inner_allocator(), 
std::forward&lt;Args&gt;(args)...)</tt>.</p></li>
<li><p>(9.3) &mdash; Otherwise, if <tt>uses_allocator&lt;T, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T, Args..., inner_allocator_type<ins>&amp;</ins>&gt;::value</tt> is <tt>true</tt>, calls 
<tt><i>OUTERMOST_ALLOC_TRAITS</i>(*this)::construct(<i>OUTERMOST</i>(*this), p, std::forward&lt;Args&gt;(args)...,
inner_allocator())</tt>.</p></li>
</ol>
</blockquote>
</li>

<li><p>Change the 2nd, 3rd, 6th, and 7th bullets in 19.13.4 <a href="https://timsong-cpp.github.io/cppwp/allocator.adaptor.members">[allocator.adaptor.members]</a> p11 to
add four lvalue-references:</p>

<blockquote>
<ol style="list-style-type: none">
<li><p>(11.2) &mdash; Otherwise, if <tt>uses_allocator&lt;T1, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T1, allocator_arg_t, inner_allocator_type<ins>&amp;</ins>, Args1...&gt;::value</tt> is <tt>true</tt>, 
then <tt>xprime</tt> is <tt>tuple_cat(tuple&lt;allocator_arg_t, inner_allocator_type&amp;&gt;(allocator_arg, 
inner_allocator()), std::move(x))</tt>.</p></li>
<li><p>(11.3) &mdash; Otherwise, if <tt>uses_allocator&lt;T1, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T1, Args1..., inner_allocator_type<ins>&amp;</ins>&gt;::value</tt> is <tt>true</tt>, then 
<tt>xprime</tt> is <tt>tuple_cat(std::move(x), tuple&lt;inner_allocator_type&amp;&gt;(inner_allocator()))</tt>.</p></li>
<li><p>[&hellip;]</p></li>
<li><p>(11.6) &mdash; Otherwise, if <tt>uses_allocator&lt;T2, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T2, allocator_arg_t, inner_allocator_type<ins>&amp;</ins>, Args2...&gt;::value</tt> is <tt>true</tt>, 
then <tt>yprime</tt> is <tt>tuple_cat(tuple&lt;allocator_arg_t, inner_allocator_type&amp;&gt;(allocator_arg, 
inner_allocator()), std::move(y))</tt>.</p></li>
<li><p>(11.7) &mdash; Otherwise, if <tt>uses_allocator&lt;T2, inner_allocator_type&gt;::value</tt> is <tt>true</tt> and 
<tt>is_constructible&lt;T2, Args2..., inner_allocator_type<ins>&amp;</ins>&gt;::value</tt> is <tt>true</tt>, then 
<tt>yprime</tt> is <tt>tuple_cat(std::move(y), tuple&lt;inner_allocator_type&amp;&gt;(inner_allocator()))</tt>.</p></li>
</ol>
</blockquote>
</li>
</ol>





</body>
</html>
