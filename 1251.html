<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 1251: move constructing basic_stringbuf</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<p>Revised 2016-11-22 at 01:11:21 UTC</p>
<hr>
<h3><a name="1251" href="1251">1251.</a> move constructing <tt>basic_stringbuf</tt></h3>
<p><b>Section:</b> 27.8.2.1 [stringbuf.cons] <b>Status:</b> <a href="lwg-active.html#NAD">NAD</a>
 <b>Submitter:</b> Martin Sebor <b>Opened:</b> 2009-10-29 <b>Last modified:</b> 2016-01-28</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#stringbuf.cons">issues</a> in [stringbuf.cons].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#NAD">NAD</a> status.</p>
<p><b>Discussion:</b></p>
<p>
I just came across issue <a href="1204">1204</a> -- Global permission to move, which
seems to address the concern raised by the example in c++std-lib-25030.
</p>
<p>
IIUC, the example violates the permission to assume that arguments
bound to rvalue references are unnamed temporaries granted to
implementations by the resolution of issue <a href="1204">1204</a> - Global permission
to move.
</p>

<p>
I.e., the <tt>ostringstream(ostringstream &amp;&amp;rhs)</tt> ctor can leave the <tt>rhs</tt>
pointers pointing to the newly constructed object's buffer just as
long as the dtor doesn't change or invalidate the buffer. The caller
may not make any assumptions about rhs after the move beyond it being
safe to destroy or reassign.
</p>

<p>
So unless I misunderstood something, I still think the <tt>basic_stringbuf</tt>
move ctor is overspecified. Specifically, I think the third sentence
in the Effects clause and the last 6 bullets in the Postconditions
clause can, and IMO should, be stricken.
</p>

<p><i>[
2010-01-31 Moved to Tentatively NAD after 5 positive votes on c++std-lib.
Rationale added below.
]</i></p>



<p><b>Rationale:</b></p>
<p>
The sense of 1251 appears to be that the <tt>basic_stringbuf</tt> move
constructor offers more guarantees than the minimum.  This is true, and quite
correct.  The additional words guarantee that the internal buffer has genuinely
transferred from one object to another, and further operations on the original
will not affect the buffer of the newly created object.  This is a very
important guarantee, much as we see that a moved-from <tt>unique_ptr</tt> is
guaranteed to be empty.
</p>


<p><b>Proposed resolution:</b></p>
<p>
Strike from 27.8.2.1 [stringbuf.cons]:
</p>

<blockquote><pre>
basic_stringbuf(basic_stringbuf&amp;&amp; rhs);
</pre>
<blockquote>
<p>
<i>Effects:</i> Move constructs from the rvalue <tt>rhs</tt>. It is
implementation-defined whether the sequence pointers in <tt>*this</tt>
(<tt>eback()</tt>, <tt>gptr()</tt>, <tt>egptr()</tt>, <tt>pbase()</tt>,
<tt>pptr()</tt>, <tt>epptr()</tt>) obtain the values which <tt>rhs</tt>
had. <del>Whether they do or not, <tt>*this</tt> and <tt>rhs</tt> reference
separate buffers (if any at all) after the construction.</del> The openmode,
locale and any other state of <tt>rhs</tt> is also copied.
</p>

<p>
<i>Postconditions:</i> Let <tt>rhs_p</tt> refer to the state of
<tt>rhs</tt> just prior to this construction and let <tt>rhs_a</tt>
referto the state of <tt>rhs</tt> just after this construction.
</p>
<ul>
<li>
<tt>str() == rhs_p.str()</tt>
</li>
<li>
<tt>gptr() - eback() == rhs_p.gptr() - rhs_p.eback()</tt>
</li>
<li>
<tt>egptr() - eback() == rhs_p.egptr() - rhs_p.eback()</tt>
</li>
<li>
<tt>pptr() - pbase() == rhs_p.pptr() - rhs_p.pbase()</tt>
</li>
<li>
<tt>epptr() - pbase() == rhs_p.epptr() - rhs_p.pbase()</tt>
</li>
<li><del>
if <tt>(eback()) eback() != rhs_a.eback()</tt>
</del></li>
<li><del>
if <tt>(gptr()) gptr() != rhs_a.gptr()</tt>
</del></li>
<li><del>
if <tt>(egptr()) egptr() != rhs_a.egptr()</tt>
</del></li>
<li><del>
if <tt>(pbase()) pbase() != rhs_a.pbase()</tt>
</del></li>
<li><del>
if <tt>(pptr()) pptr() != rhs_a.pptr()</tt>
</del></li>
<li><del>
if <tt>(epptr()) epptr() != rhs_a.epptr()</tt>
</del></li>
</ul>
</blockquote>
</blockquote>






</body>
</html>
