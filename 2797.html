<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 2797: Trait precondition violations</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<p>Revised 2016-11-15 at 21:11:26 UTC</p>
<hr>
<h3><a name="2797" href="#2797">2797.</a> Trait precondition violations</h3>
<p><b>Section:</b> 20.15.2 [meta.type.synop] <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Jonathan Wakely <b>Opened:</b> 2016-11-09 <b>Last modified:</b> 2016-11-15</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#meta.type.synop">issues</a> in [meta.type.synop].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
<b>Addresses RU 2</b>
<p/>
Failed prerequirement for the type trait must result in ill-formed program. 
Otherwise hard detectable errors will happen:
</p>
<blockquote><pre>
#include &lt;type_traits&gt;

struct foo;

void damage_type_trait() {
  // must be ill-formed
  std::is_constructible&lt;foo, foo&gt;::value;  
} 

struct foo{};

int main() {
  static_assert(
    // produces invalid result
    std::is_constructible&lt;foo, foo&gt;::value,   
    "foo must be constructible from foo"
  ); 
} 
</pre></blockquote>
<p>
Suggested resolution:
<p/>
Add to the end of the [meta.type.synop] section:
</p>
<blockquote><p>
<ins>Program is ill-formed if precondition for the type trait is violated.</ins>
</p></blockquote>

<p><i>[2016-11-09, Jonathan provides wording]</i></p>



<p><b>Proposed resolution:</b></p>
<p>This wording is relative to N4606.</p>

<ol>
<li><p>Add a new paragraph after 20.15.4.3 [meta.unary.prop] paragraph 3:</p>
<blockquote>
<p>
<ins>-?- If an instantiation of any template declared in this subclause fails
to meet the preconditions, the program is ill-formed.</ins>
</p>
</blockquote>
</li>

<li><p>Change the specification for <tt>alignment_of</tt> in Table 39 in 20.15.5 [meta.unary.prop.query]:</p>

<blockquote>
<table border="1">
<caption>Table 39 &mdash; Type property queries</caption>
<tr>
<td>
<tt>template &lt;class T&gt; struct alignment_of;</tt>
</td>
<td>
<tt>alignof(T)</tt>.<br/>
<i>Requires:</i> <tt>alignof(T)</tt> shall be a valid expression (5.3.6)<ins>,
otherwise the program is ill-formed</ins>
</td>
</tr>

</table>
</blockquote>

</li>

<li><p>Change the specification for <tt>is_base_of</tt>, <tt>is_convertible</tt>, <tt>is_callable</tt>, and 
<tt>is_nothrow_callable</tt> in Table 40 in 20.15.6 [meta.rel]:</p>

<blockquote>
<table border="1">
<caption>Table 40 &mdash; Type relationship predicates</caption>

<tr>
<td colspan="3" align="center">
<tt>[&hellip;]</tt>
</td>
</tr>

<tr>
<td>
<tt>template &lt;class Base, class<br/>
Derived&gt;<br/>
struct is_base_of;</tt>
</td>
<td>
[&hellip;]
</td>
<td>
If <tt>Base</tt> and <tt>Derived</tt> are<br/>
non-union class types and are<br/>
different types (ignoring possible<br/>
<i>cv</i>-qualifiers) then <tt>Derived</tt> shall<br/>
be a complete type<ins>, otherwise the program is ill-formed</ins>.<br/>
[<i>Note:</i> Base classes that<br/>
are private, protected, or ambiguous are,<br/>
nonetheless, base classes. &mdash; <i>end note</i>]
</td>
</tr>

<tr>
<td>
<tt>template &lt;class From, class To&gt;<br/> 
struct is_convertible;</tt>
</td>
<td>
<i>see below</i>
</td>
<td>
<tt>From</tt> and <tt>To</tt> shall be complete<br/>
types, arrays of unknown bound,<br/>
or (possibly <i>cv</i>-qualified) <tt>void</tt><br/>
types<ins>, otherwise the program is<br/>
ill-formed</ins>.
</td>
</tr>

<tr>
<td>
<tt>template &lt;class Fn, class...<br/> 
ArgTypes, class R&gt;<br/> 
struct is_callable&lt;<br/> 
Fn(ArgTypes...), R&gt;;</tt>
</td>
<td>
[&hellip;]
</td>
<td>
<tt>Fn</tt>, <tt>R</tt>, and all types in the<br/>
parameter pack <tt>ArgTypes</tt> shall<br/>
be complete types, (possibly<br/>
<i>cv</i>-qualified) <tt>void</tt>, or arrays of<br/>
unknown bound<ins>,<br/>
otherwise the program is ill-formed</ins>.
</td>
</tr>

<tr>
<td>
<tt>template &lt;class Fn, class...<br/> 
ArgTypes, class R&gt;<br/> 
struct is_nothrow_callable&lt;<br/> 
Fn(ArgTypes...), R&gt;;</tt>
</td>
<td>
[&hellip;]
</td>
<td>
<tt>Fn</tt>, <tt>R</tt>, and all types in the<br/>
parameter pack <tt>ArgTypes</tt> shall<br/>
be complete types, (possibly<br/>
<i>cv</i>-qualified) <tt>void</tt>, or arrays of<br/>
unknown bound<ins>,<br/>
otherwise the program is ill-formed</ins>.
</td>
</tr>

</table>
</blockquote>

</li>

<li><p>Add a new paragraph after 20.15.7 [meta.trans] paragraph 2:</p>
<blockquote>
<p>
-2- Each of the templates in this subclause shall be a <tt>TransformationTrait</tt> (20.15.1).
<p/>
<ins>-?- If an instantiation of any template declared in this subclause fails
to meet the <i>Requires:</i> preconditions, the program is ill-formed.</ins>
</p>
</blockquote>
</li>


</ol>





</body>
</html>
