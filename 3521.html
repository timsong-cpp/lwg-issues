<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3521: Overly strict requirements on qsort and bsearch</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3521" href="lwg-defects.html#3521">3521.</a> Overly strict requirements on <tt>qsort</tt> and <tt>bsearch</tt></h3>
<p><b>Section:</b> 25.12 <a href="https://timsong-cpp.github.io/cppwp/alg.c.library">[alg.c.library]</a> <b>Status:</b> <a href="lwg-active.html#WP">WP</a>
 <b>Submitter:</b> Richard Smith <b>Opened:</b> 2021-02-02 <b>Last modified:</b> 2021-06-07 16:58:04 UTC</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#alg.c.library">issues</a> in [alg.c.library].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#WP">WP</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Per 25.12 <a href="https://timsong-cpp.github.io/cppwp/alg.c.library">[alg.c.library]</a>/2, for <tt>qsort</tt> and <tt>bsearch</tt>, we have:
</p>
<blockquote>
<p>
<i>Preconditions:</i> The objects in the array pointed to by <tt>base</tt> are of trivial type.
</p>
</blockquote>
<p>
This seems like an unnecessarily strict requirement. <tt>qsort</tt> only needs the objects to be of a 
trivially-copyable type (because it will use <tt>memcpy</tt> or equivalent to relocate them), and 
<tt>bsearch</tt> doesn't need any particular properties of the array element type. Presumably it 
would be in improvement to specify the more-precise requirements instead.
<p/>
We should also reconsider the other uses of the notion of a trivial type. It's really not a useful or 
meaningful type property by itself, because it doesn't actually require that any operations on the type 
are valid (due to the possibility of them being ambiguous or only some of them being available) and the 
places that consider it very likely actually mean <tt>is_trivially_copyable</tt> plus 
<tt>is_trivially_default_constructible</tt> instead, or perhaps <tt>is_trivially_copy_constructible</tt> 
and <tt>is_trivially_move_constructible</tt> and so on.
<p/>
Other than <tt>qsort</tt> and <tt>bsearch</tt>, the only uses of this type property in the standard are 
to constrain <tt>max_align_t</tt>, <tt>aligned_storage</tt>, <tt>aligned_union</tt>, and the element type 
of <tt>basic_string</tt> (and in the definition of the deprecated <tt>is_pod</tt> trait), all of which 
(other than <tt>is_pod</tt>) I think really mean "is trivially default constructible", not "has at least 
one eligible default constructor and all eligible default constructors are trivial". And in fact I think 
the alignment types are underspecified &mdash; we don't want to require merely that they be 
trivially-copyable, since that doesn't require any particular operation on them to actually be valid &mdash; 
we also want to require that they actually model <tt>semiregular</tt>.
</p>

<p><i>[2021-02-23; Casey Carter provides concrete wording]</i></p>


<p><i>[2021-03-12; Reflector poll]</i></p>

<p>
Set status to Tentatively Ready after five votes in favour during reflector poll.
</p>

<p><i>[2021-06-07 Approved at June 2021 virtual plenary. Status changed: Voting &rarr; WP.]</i></p>



<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/n4878">N4878</a>. 
</p>

<ol>
<li><p>Modify 25.12 <a href="https://timsong-cpp.github.io/cppwp/alg.c.library">[alg.c.library]</a> as indicated:</p>

<blockquote>
<pre>
void* bsearch(const void* key, const void* base, size_t nmemb, size_t size,
             <i>c-compare-pred</i>* compar);
void* bsearch(const void* key, const void* base, size_t nmemb, size_t size,
              <i>compare-pred</i>* compar);
void qsort(void* base, size_t nmemb, size_t size, <i>c-compare-pred</i>* compar);
void qsort(void* base, size_t nmemb, size_t size, <i>compare-pred</i>* compar);
</pre>
<blockquote>
<p>
-2- <i>Preconditions:</i> <ins>For <tt>qsort</tt>, t</ins><del>T</del>he objects in the array pointed to 
by <i>base</i> are of <del>trivial</del><ins>trivially copyable</ins> type.
</p>
</blockquote>
</blockquote>
</li>
</ol>





</body>
</html>
