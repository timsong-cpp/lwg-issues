<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>C++ Standard Library Issues to be moved in [INSERT CURRENT MEETING HERE]</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<h1>C++ Standard Library Issues to be moved in [INSERT CURRENT MEETING HERE]</h1>
<table>
<tr>
<td align="left">Doc. no.</td>
<td align="left">R0165???</td>
</tr>
<tr>
<td align="left">Date:</td>
<td align="left"><p>Revised 2023-06-14 at 20:44:28 UTC</p>
</td>
</tr>
<tr>
<td align="left">Project:</td>
<td align="left">Programming Language C++</td>
</tr>
<tr>
<td align="left">Reply to:</td>
<td align="left">Jonathan Wakely &lt;<a href="mailto:lwgchair@gmail.com">lwgchair@gmail.com</a>&gt;</td>
</tr>
</table>
<h2>Ready Issues</h2>
<hr>
<h3><a name="3203" href="3203">3203.</a> <tt>span</tt> element access invalidation</h3>
<p><b>Section:</b> 24.7.2.2.1 <a href="https://timsong-cpp.github.io/cppwp/span.overview">[span.overview]</a> <b>Status:</b> <a href="lwg-active.html#Ready">Ready</a>
 <b>Submitter:</b> Johel Ernesto Guerrero Pe&ntilde;a <b>Opened:</b> 2019-05-04 <b>Last modified:</b> 2023-06-14 07:41:20 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View other</b> <a href="lwg-index-open.html#span.overview">active issues</a> in [span.overview].</p>
<p><b>View all other</b> <a href="lwg-index.html#span.overview">issues</a> in [span.overview].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Ready">Ready</a> status.</p>
<p><b>Discussion:</b></p>
<p>
<tt>span</tt> doesn't explicitly point out when its accessed elements are invalidated like <tt>string_view</tt> 
does in 23.3.3.4 <a href="https://timsong-cpp.github.io/cppwp/string.view.iterators">[string.view.iterators]</a> p2.
</p>

<p><i>[2019-06-12 Priority set to 2 after reflector discussion]</i></p>


<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">

<p>This wording is relative to <a href="https://wg21.link/N4910">N4910</a>.</p>

<ol>
<li><p>Modify 24.7.2.2.1 <a href="https://timsong-cpp.github.io/cppwp/span.overview">[span.overview]</a> as indicated:</p>

<blockquote>
<p>
-4- <tt>ElementType</tt> is required to be a complete object type that is not an abstract class type.
<p/>
<ins>-?- For a <tt>span s</tt>, any operation that invalidates a pointer in the range 
<tt>[s.data(), s.data() + s.size())</tt> invalidates pointers, iterators, and references other than 
<tt>*this</tt> returned from <tt>s</tt>'s member functions.</ins>
</p>
</blockquote>
</li>
</ol>
</blockquote>


<p><i>[2023-06-13; Varna]</i></p>

<p>
The reference to <a href="https://wg21.link/N4910">N4910</a> 23.3.3.4 <a href="https://timsong-cpp.github.io/cppwp/string.view.iterators">[string.view.iterators]</a> p2 is located now in
<a href="https://wg21.link/N4950">N4950</a> 23.3.3.1 <a href="https://timsong-cpp.github.io/cppwp/string.view.template.general">[string.view.template.general]</a> p2 where its says:
</p>
<blockquote><p>
For a <tt>basic_string_view str</tt>, any operation that invalidates a pointer in the range
</p>
<blockquote><pre>
[str.data(), str.data() + str.size())
</pre></blockquote>
<p>
invalidates pointers, iterators, and references returned from <tt>str</tt>'s member functions.
</p></blockquote>
<p>
The group also suggested to adjust 23.3.3.1 <a href="https://timsong-cpp.github.io/cppwp/string.view.template.general">[string.view.template.general]</a> p2 similarly.
</p>

<p><i>[2023-06-14 Varna; Move to Ready]</i></p>




<p id="res-3203"><b>Proposed resolution:</b></p>
<p>This wording is relative to <a href="https://wg21.link/N4950">N4950</a>.</p>

<ol>
<li><p>Modify 23.3.3.1 <a href="https://timsong-cpp.github.io/cppwp/string.view.template.general">[string.view.template.general]</a> as indicated:</p>

<blockquote class="note">
<p>
[<i>Drafting note:</i> The proposed wording also removes the extra code block that previously
defined the range]
</p>
</blockquote>

<blockquote>
<p>
-2- For a <tt>basic_string_view str</tt>, any operation that invalidates a pointer in the range
<tt>[str.data(), str.data() + str.size())</tt> invalidates pointers, iterators, and references 
<ins>to elements of <tt>str</tt></ins><del>returned from <tt>str</tt>'s member functions</del>.
</p>
</blockquote>
</li>

<li><p>Modify 24.7.2.2.1 <a href="https://timsong-cpp.github.io/cppwp/span.overview">[span.overview]</a> as indicated:</p>

<blockquote>
<p>
-4- <tt>ElementType</tt> is required to be a complete object type that is not an abstract class type.
<p/>
<ins>-?- For a <tt>span s</tt>, any operation that invalidates a pointer in the range 
<tt>[s.data(), s.data() + s.size())</tt> invalidates pointers, iterators, and references to elements 
of <tt>s</tt>.</ins>
</p>
</blockquote>
</li>
</ol>




<hr>
<h3><a name="3305" href="3305">3305.</a> <tt>any_cast&lt;void&gt;</tt></h3>
<p><b>Section:</b> 22.7.5 <a href="https://timsong-cpp.github.io/cppwp/any.nonmembers">[any.nonmembers]</a> <b>Status:</b> <a href="lwg-active.html#Ready">Ready</a>
 <b>Submitter:</b> John Shaw <b>Opened:</b> 2019-10-16 <b>Last modified:</b> 2023-06-14 07:38:05 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View other</b> <a href="lwg-index-open.html#any.nonmembers">active issues</a> in [any.nonmembers].</p>
<p><b>View all other</b> <a href="lwg-index.html#any.nonmembers">issues</a> in [any.nonmembers].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Ready">Ready</a> status.</p>
<p><b>Discussion:</b></p>
<blockquote><pre>
any foo;
void* p = any_cast&lt;void&gt;(&amp;foo);
</pre></blockquote>
<p>
Per 22.7.5 <a href="https://timsong-cpp.github.io/cppwp/any.nonmembers">[any.nonmembers]</a>/9, since the operand isn't <tt>nullptr</tt> and 
<tt>operand-&gt;type() == typeid(T)</tt> (because <tt>T = void</tt> in this case), we should 
return a pointer to the object contained by <tt>operand</tt>. But there is no such object.
<p/>
We need to handle the <tt>T = void</tt> case, probably by just explicitly returning <tt>nullptr</tt>.
</p>

<p><i>[2019-11 Priority to 2 during Monday issue prioritization in Belfast. There is implementation divergence here.]</i></p>

<p><i>[2020-02 LWG discussion in Prague did not reach consensus. Status to Open.]</i></p>

<p>There was discussion about whether or not <tt>any_cast&lt;void&gt;(a)</tt> should be ill-formed, or return <tt>nullptr</tt>.</p>
<p>Poll "should it return nullptr" was 0-4-5-5-1.</p>
<p><i>[2022-02 Currently ill-formed in MSVC ("error C2338: std::any cannot contain void") and returns null pointer in libstdc++ and libc++.]</i></p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">

<p>This wording is relative to <a href="https://wg21.link/n4835">N4835</a>.</p>

<ol>
<li><p>Modify 22.7.5 <a href="https://timsong-cpp.github.io/cppwp/any.nonmembers">[any.nonmembers]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class T&gt;
  const T* any_cast(const any* operand) noexcept;
template&lt;class T&gt;
  T* any_cast(any* operand) noexcept;
</pre>
<blockquote>
<p>
-9- <i>Returns:</i> If <tt>operand != nullptr &amp;&amp; operand-&gt;type() == typeid(T) <ins>&amp;&amp; 
is_object_v&lt;T&gt;</ins></tt>, a pointer to the object contained by <tt>operand</tt>; otherwise, 
<tt>nullptr</tt>.
<p/>
[&hellip;]
</p>
</blockquote>
</blockquote>
</li>
</ol>

</blockquote>


<p><i>[2023-06-14 Varna; Jonathan provides improved wording]</i></p>

<p><i>[2023-06-14 Varna; Move to Ready]</i></p>

<p>Poll: 7-0-1</p>



<p id="res-3305"><b>Proposed resolution:</b></p>

<p>This wording is relative to <a href="https://wg21.link/N4950">N4950</a>.</p>

<ol>
<li><p>Modify 22.7.5 <a href="https://timsong-cpp.github.io/cppwp/any.nonmembers">[any.nonmembers]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class T&gt;
  const T* any_cast(const any* operand) noexcept;
template&lt;class T&gt;
  T* any_cast(any* operand) noexcept;
</pre>
<blockquote>
<p>
<ins>
-8-
<i>Mandates</i>:
<code>is_void_v&lt;T&gt;</code> is <code>false</code>.
</ins>
</p>
<p>
-9-
<i>Returns</i>: If <tt>operand != nullptr &amp;&amp; operand-&gt;type() == typeid(T)</tt> <ins>is <code>true</code></ins>, a pointer to the object contained by <tt>operand</tt>; otherwise,
<tt>nullptr</tt>.
<p/>
[&hellip;]
</p>
</blockquote>
</blockquote>
</li>
</ol>





<hr>
<h3><a name="3749" href="3749">3749.</a> <tt>common_iterator</tt> should handle integer-class difference types</h3>
<p><b>Section:</b> 25.5.5 <a href="https://timsong-cpp.github.io/cppwp/iterators.common">[iterators.common]</a> <b>Status:</b> <a href="lwg-active.html#Ready">Ready</a>
 <b>Submitter:</b> Hewill Kang <b>Opened:</b> 2022-08-01 <b>Last modified:</b> 2023-06-14 07:39:40 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Ready">Ready</a> status.</p>
<p><b>Discussion:</b></p>
<p>
The partial specialization of <tt>iterator_traits</tt> for <tt>common_iterator</tt> is defined in 
25.5.5.1 <a href="https://timsong-cpp.github.io/cppwp/common.iterator">[common.iterator]</a> as
</p>
<pre>
template&lt;input_iterator I, class S&gt;
struct iterator_traits&lt;common_iterator&lt;I, S&gt;&gt; {
  using iterator_concept = <i>see below</i>;
  using iterator_category = <i>see below</i>;
  using value_type = iter_value_t&lt;I&gt;;
  using difference_type = iter_difference_t&lt;I&gt;;
  using pointer = <i>see below</i>;
  using reference = iter_reference_t&lt;I&gt;;
};
</pre>
<p>
where <tt>difference_type</tt> is defined as <tt>iter_difference_t&lt;I&gt;</tt> and <tt>iterator_category</tt> 
is defined as at least <tt>input_iterator_tag</tt>. However, when <tt>difference_type</tt> is an 
integer-class type, <tt>common_iterator</tt> does not satisfy <i>Cpp17InputIterator</i>, which makes 
<tt>iterator_category</tt> incorrectly defined as <tt>input_iterator_tag</tt>.
</p>
<p>
Since the main purpose of <tt>common_iterator</tt> is to be compatible with the legacy iterator system, 
which is reflected in its efforts to try to provide the operations required by C++17 iterators even if 
the underlying iterator does not support it. We should handle this case of difference type incompatibility 
as well.
<p/>
The proposed solution is to provide a C++17 conforming difference type by clamping the integer-class type 
to <tt>ptrdiff_t</tt>.
<p/>
<b>Daniel:</b>
</p>
<blockquote class="note">
<p>
The second part of this issue provides an <em>alternative</em> resolution for the first part of 
LWG <a href="3748">3748</a> and solves the casting problem mentioned in LWG <a href="3748">3748</a> as well.
</p>
</blockquote>

<p><i>[2022-08-23; Reflector poll]</i></p>

<p>
Set priority to 2 after reflector poll.
</p>
<p>
"I think <code>common_iterator</code> should <em>reject</em> iterators with
integer-class difference types since it can't possibly achieve the design intent
of adapting them to <i>Cpp17Iterator</i>s."
</p>
<p>
"I'm not yet convinced that we need to outright reject such uses,
but I'm pretty sure that we shouldn't mess with the difference type
and that the PR is in the wrong direction."
</p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">

<p>
This wording is relative to <a href="https://wg21.link/N4910">N4910</a>.
</p>

<ol>
<li><p>Modify 25.5.5.1 <a href="https://timsong-cpp.github.io/cppwp/common.iterator">[common.iterator]</a> as indicated:</p>

<blockquote class="note">
<p>
[<i>Drafting note:</i> <tt>common_iterator</tt> requires iterator type <tt>I</tt> must model 
<tt>input_or_output_iterator</tt> which ensures that <tt>iter_difference_t&lt;I&gt;</tt> 
is a signed-integer-like type. The modification of <tt>common_iterator::operator-</tt> is to ensure 
that the pair of <tt>common_iterator&lt;I, S&gt;</tt> models <tt>sized_sentinel_for</tt> when 
<tt>sized_sentinel_for&lt;I, S&gt;</tt> is modeled for iterator type <tt>I</tt> with an 
integer-class difference type and its sentinel type <tt>S</tt>.]
</p>
</blockquote>

<blockquote>
<pre>
namespace std {
  <ins>template&lt;class D&gt;
    requires <i>is-signed-integer-like</i>&lt;D&gt;
  using <i>make-cpp17-diff-t</i> = conditional_t&lt;signed_integral&lt;D&gt;, D, ptrdiff_t&gt;;  <i>// exposition only</i></ins>

  template&lt;input_or_output_iterator I, sentinel_for&lt;I&gt; S>
    requires (!same_as&lt;I, S&gt; &amp;&amp; copyable&lt;I&gt;)
  class common_iterator {
  public:
    [&hellip;]
    template&lt;sized_sentinel_for&lt;I&gt; I2, sized_sentinel_for&lt;I&gt; S2>
      requires sized_sentinel_for&lt;S, I2&gt;
    friend constexpr <ins><i>make-cpp17-diff-t</i>&lt;</ins>iter_difference_t&lt;I2&gt;<ins>&gt;</ins> operator-(
      const common_iterator&amp; x, const common_iterator&lt;I2, S2&gt;&amp; y);
    [&hellip;]
  };
  
  template&lt;class I, class S&gt;
  struct incrementable_traits&lt;common_iterator&lt;I, S&gt;&gt; {
    using difference_type = <ins><i>make-cpp17-diff-t</i>&lt;</ins>iter_difference_t&lt;I&gt;<ins>&gt;</ins>;
  };

  template&lt;input_iterator I, class S&gt;
  struct iterator_traits&lt;common_iterator&lt;I, S&gt;&gt; {
    using iterator_concept = <i>see below</i>;
    using iterator_category = <i>see below</i>;
    using value_type = iter_value_t&lt;I&gt;;
    using difference_type = <ins><i>make-cpp17-diff-t</i>&lt;</ins>iter_difference_t&lt;I&gt;<ins>&gt;</ins>;
    using pointer = <i>see below</i>;
    using reference = iter_reference_t&lt;I&gt;;
  };
}
</pre>
</blockquote>
</li>

<li><p>Modify 25.5.5.6 <a href="https://timsong-cpp.github.io/cppwp/common.iter.cmp">[common.iter.cmp]</a> as indicated:</p>

<blockquote class="note">
<p>
[<i>Drafting note:</i> If this issue is voted in at the same time as LWG <a href="3748">3748</a>, the editor
is kindly informed that the changes indicated below supersede those of the before mentioned issues first 
part.]
</p>
</blockquote>

<blockquote>
<pre>
template&lt;sized_sentinel_for&lt;I&gt; I2, sized_sentinel_for&lt;I&gt; S2>
  requires sized_sentinel_for&lt;S, I2&gt;
friend constexpr <ins><i>make-cpp17-diff-t</i>&lt;</ins>iter_difference_t&lt;I2&gt;<ins>&gt;</ins> operator-(
  const common_iterator&amp; x, const common_iterator&lt;I2, S2&gt;&amp; y);
</pre>
<blockquote>
<p>
-5- <i>Preconditions</i>: <tt>x.v_.valueless_by_exception()</tt> and <tt>y.v_.valueless_by_exception()</tt> are 
each <tt>false</tt>.
<p/>
-6- <i>Returns</i>: <tt>0</tt> if <tt><i>i</i></tt> and <tt><i>j</i></tt> are each <tt>1</tt>, and 
otherwise <ins><tt>static_cast&lt;<i>make-cpp17-diff-t</i>&lt;iter_difference_t&lt;I2&gt;&gt;&gt;(</tt></ins><tt>get&lt;<i>i</i>&gt;(x.v_) 
- get&lt;<i>j</i>&gt;(y.v_)</tt><ins><tt>)</tt></ins>, where <tt><i>i</i></tt> is <tt>x.v_.index()</tt> 
and <tt><i>j</i></tt> is <tt>y.v_.index()</tt>.
</p>
</blockquote>
</blockquote>
</li>

</ol>
</blockquote>


<p><i>[2023-06-13; Varna; Tomasz provides wording]</i></p>

<p><i>[2023-06-14 Varna; Move to Ready]</i></p>



<p id="res-3749"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N4950">N4950</a>.
</p>

<ol>
<li><p>Modify 25.5.5.1 <a href="https://timsong-cpp.github.io/cppwp/common.iterator">[common.iterator]</a> as indicated:</p>

<blockquote>
<pre>
namespace std {
  [&hellip;]

  template&lt;input_iterator I, class S&gt;
  struct iterator_traits&lt;common_iterator&lt;I, S&gt;&gt; {
    using iterator_concept = <i>see below</i>;
    using iterator_category = <i>see below</i>; <ins>// <i>not always present</i></ins>
    using value_type = iter_value_t&lt;I&gt;;
    using difference_type = iter_difference_t&lt;I&gt;;
    using pointer = <i>see below</i>;
    using reference = iter_reference_t&lt;I&gt;;
  };
}
</pre>
</blockquote>
</li>

<li><p>Modify 25.5.5.2 <a href="https://timsong-cpp.github.io/cppwp/common.iter.types">[common.iter.types]</a> as indicated:</p>

<blockquote>
<p>
<ins>-?- The nested <i>typedef-name</i> <tt>iterator_category</tt> of the specialization of <tt>iterator_traits</tt> for 
<tt>common_iterator&lt;I, S&gt;</tt> is defined if and only if <tt>iter_difference_t&lt;I&gt;</tt> is an integral type. 
In that case, <tt>iterator_category</tt> denotes <tt>forward_iterator_tag</tt> if the <i>qualified-id</i> 
<tt>iterator_traits&lt;I&gt;::iterator_category</tt> is valid and denotes a type that models 
<tt>derived_from&lt;forward_iterator_tag&gt;</tt>; otherwise it denotes <tt>input_iterator_tag</tt>.</ins>
</p>
<p>
-1- The <ins>remaining</ins> nested <i>typedef-name</i>s of the specialization of <tt>iterator_traits</tt> 
for <tt>common_iterator&lt;I, S&gt;</tt> are defined as follows<del>.</del><ins>:</ins>
</p>
<ol style="list-style-type: none">
<li><p>(1.1) &mdash; <tt>iterator_concept</tt> denotes <tt>forward_iterator_tag</tt> if <tt>I</tt> models 
<tt>forward_iterator</tt>; otherwise it denotes <tt>input_iterator_tag</tt>.</p></li>
<li><p><del>(1.2) &mdash; <tt>iterator_category</tt> denotes 
<tt>forward_iterator_tag</tt> if the <i>qualified-id</i> <tt>iterator_traits&lt;I&gt;::iterator_category</tt> is valid 
and denotes a type that models <tt>derived_from&lt;forward_iterator_tag&gt;</tt>; otherwise it denotes <tt>input_iterator_tag</tt>.</del></p></li>
<li><p>(1.3) &mdash; Let <tt>a</tt> denote an lvalue of type <tt>const common_iterator&lt;I, S&gt;</tt>. 
If the expression <tt>a.operator-&gt;()</tt> is well-formed, then <tt>pointer</tt> denotes <tt>decltype(a.operator->())</tt>. 
Otherwise, <tt>pointer</tt> denotes <tt>void</tt>.</p></li>
</ol>
</blockquote>
</li>

</ol>





</body>
</html>
