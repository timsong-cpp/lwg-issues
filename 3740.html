<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3740: slide_view::size should preserve the signedness of underlying range's size</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3740" href="lwg-closed.html#3740">3740.</a> <tt>slide_view::size</tt> should preserve the signedness of underlying range's size</h3>
<p><b>Section:</b> 26.7.28.2 <a href="https://timsong-cpp.github.io/cppwp/range.slide.view">[range.slide.view]</a> <b>Status:</b> <a href="lwg-active.html#NAD">NAD</a>
 <b>Submitter:</b> Hewill Kang <b>Opened:</b> 2022-07-15 <b>Last modified:</b> 2022-11-30 17:59:24 UTC</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#range.slide.view">issues</a> in [range.slide.view].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#NAD">NAD</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Currently, <tt>slide_view::size const</tt> has the following <i>Effects</i>:
</p>
<pre>
auto sz = ranges::distance(<i>base_</i>) - <i>n_</i> + 1;
if (sz &gt; 0) sz = 0;
return <i>to-unsigned-like</i>(sz);
</pre>
<p>
There are two problems worth noting here. First, as described in LWG <a href="3739">3739</a>, 
<tt>ranges::distance(<i>base_</i>)</tt> and <tt><i>n_</i></tt> may have 
different types, which makes the actual type of <tt>sz</tt> not deterministic.
Also, the return type is unconditionally converted to an unsigned type, even though 
the underlying range may have a signed size type.
</p>
Second, even if <tt>V</tt> has the same <tt>difference_type</tt> as <tt>const V</tt>, 
there may still be integer promotion issues mentioned by LWG <a href="3730">3730</a>
since we add an integer <tt>1</tt> at the end here.
<p>
I think converting <tt>sz</tt> to the size type of the underlying range before 
returning is the appropriate thing to do.
</p>

<p><i>[2022-08-23; Reflector poll: NAD]</i></p>

<p>
Paper author: "I did consider promotion and decided not to care. The code compiles and conforms to all ranges requirements, and that seems entirely sufficient to me." "Even if we don't outlaw those being different types entirely, people playing those games will still get exactly one unsigned-integer-like type back. It's totally deterministic."
</p>

<p><i>[2022-11-30 LWG telecon. Status changed: Tentatively NAD &rarr; NAD.]</i></p>



<p id="res-3740"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N4910">N4910</a>.
</p>

<ol>
<li><p>Modify 26.7.28.2 <a href="https://timsong-cpp.github.io/cppwp/range.slide.view">[range.slide.view]</a> as indicated:</p>

<blockquote>
<pre>
constexpr auto size() requires sized_range&lt;V&gt;;
constexpr auto size() const requires sized_range&lt;const V&gt;;
</pre>
<blockquote>
<p>
-8- <i>Effects:</i> Equivalent to:
<pre>
auto sz = ranges::distance(<i>base_</i>) - <i>n_</i> + 1;
if (sz &lt; 0) sz = 0;
return <ins>static_cast&lt;decltype(ranges::size(<i>base_</i>))&gt;</ins><del><i>to-unsigned-like</i></del>(sz);
</pre>
</p>
</blockquote>
</blockquote>
</li>

</ol>





</body>
</html>
