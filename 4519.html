<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Issue 4519: No formal rule associates the total order of a mutex object with the rule for modification order</title>
<meta property="og:title" content="Issue 4519: No formal rule associates the total order of a mutex object with the rule for modification order">
<meta property="og:description" content="C++ library issue. Status: New">
<meta property="og:url" content="https://timsong-cpp.github.io/lwg-issues/4519.html">
<meta property="og:type" content="website">
<meta property="og:image" content="http://cplusplus.github.io/LWG/images/cpp_logo.png">
<meta property="og:image:alt" content="C++ logo">
<style>
  p {text-align:justify}
  li {text-align:justify}
  pre code.backtick::before { content: "`" }
  pre code.backtick::after { content: "`" }
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table.issues-index { border: 1px solid; border-collapse: collapse; }
  table.issues-index th { text-align: center; padding: 4px; border: 1px solid; }
  table.issues-index td { padding: 4px; border: 1px solid; }
  table.issues-index td:nth-child(1) { text-align: right; }
  table.issues-index td:nth-child(2) { text-align: left; }
  table.issues-index td:nth-child(3) { text-align: left; }
  table.issues-index td:nth-child(4) { text-align: left; }
  table.issues-index td:nth-child(5) { text-align: center; }
  table.issues-index td:nth-child(6) { text-align: center; }
  table.issues-index td:nth-child(7) { text-align: left; }
  table.issues-index td:nth-child(5) span.no-pr { color: red; }
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3 id="4519"><a href="lwg-active.html#4519">4519</a>. No formal rule associates the total order of a mutex object with the rule for modification order</h3>
<p><b>Section:</b> 32.6.4.2.1 <a href="https://timsong-cpp.github.io/cppwp/thread.mutex.requirements.mutex.general">[thread.mutex.requirements.mutex.general]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> jim x <b>Opened:</b> 2026-02-05 <b>Last modified:</b> 2026-02-11</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View other</b> <a href="lwg-index-open.html#thread.mutex.requirements.mutex.general">active issues</a> in [thread.mutex.requirements.mutex.general].</p>
<p><b>View all other</b> <a href="lwg-index.html#thread.mutex.requirements.mutex.general">issues</a> in [thread.mutex.requirements.mutex.general].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
32.6.4.2.1 <a href="https://timsong-cpp.github.io/cppwp/thread.mutex.requirements.mutex.general">[thread.mutex.requirements.mutex.general]</a> p4 says (emphasis mine):
</p>
<blockquote>
<p>
For purposes of determining the existence of a data race, these behave as <b>atomic operations</b> 
(6.10.2 <a href="https://timsong-cpp.github.io/cppwp/intro.multithread">[intro.multithread]</a>). The lock and unlock operations on a single 
mutex appears to occur in <b>a single total order</b>.
</p>
</blockquote>
<p>
The second note in 32.6.4.2.1 <a href="https://timsong-cpp.github.io/cppwp/thread.mutex.requirements.mutex.general">[thread.mutex.requirements.mutex.general]</a> p4
</p>
<blockquote><p>
[<i>Note 2</i>: This can be viewed as the modification order of the mutex. &mdash; <i>end note</i>]
</p></blockquote>
<p>
wants to inform the reader to interpret the single total order as a modification order. The review in 
LWG <a href="4475" title="The description to single total order in [thread.mutex.requirements.mutex.general] is hollow (Status: Tentatively NAD)">4475</a> says:
</p>
<blockquote><p>
For atomic objects, the modification order is already a single total order, <code class='backtick'>seq_cst</code> or not. This isn't a useful change.
</p></blockquote>
<p>
This implies that we want the single total order of a mutex object to be considered as the modification 
order of an atomic object for defining the order of the single total order by existing rules (especially, 
6.10.2.2 <a href="https://timsong-cpp.github.io/cppwp/intro.races">[intro.races]</a> p11-p14).
<p/>
However, the wording in 32.6.4.2.1 <a href="https://timsong-cpp.github.io/cppwp/thread.mutex.requirements.mutex.general">[thread.mutex.requirements.mutex.general]</a> p1 (emphasis mine)
</p>
<blockquote><p>
In this description, <code class='backtick'>m</code> denotes <b>an object of a mutex type</b>.
</p></blockquote>
<p>
strongly implies that there is a difference between atomic objects and mutex objects. 
Except for the note, there is no formal wording to state that <code class='backtick'>lock()</code> and <code class='backtick'>unlock()</code> operations are 
modifications to the mutex object as if they were modifications to an atomic object for the purpose 
of determining the total order, that is, the rules defined in 6.10.2.2 <a href="https://timsong-cpp.github.io/cppwp/intro.races">[intro.races]</a> that 
applies to an atomic object can also apply to an mutex object.
<p/>
For example:
</p>
<blockquote><pre>
#include &lt;mutex&gt;

std::mutex m;

int main(){
  m.lock(); // #1
  m.unlock(); // #2
}
</pre></blockquote>
<p>
The current formal wording only says <code class='backtick'>m</code> has a single total order. There is no formal wording 
that would associate the order of these operations in the total order of <code class='backtick'>m</code> with happens-before. 
We do want write-write coherence to apply to the total order of a mutex object. However, 
6.10.2.2 <a href="https://timsong-cpp.github.io/cppwp/intro.races">[intro.races]</a> p11 (emphasis mine),
</p>
<blockquote><p>
If an operation <code><i>A</i></code> that modifies <b>an atomic object <code><i>M</i></code></b> happens before 
an operation <code><i>B</i></code> that modifies <code><i>M</i></code>, then <code><i>A</i></code> is earlier 
than <code><i>B</i></code> in the modification order of <code><i>M</i></code>.
</p></blockquote>
<p>
only applies to <b>an atomic object</b>, as shown in the emphasized text. The definition of total order 
only says the order can be either <code>#1 &lt; #2</code> or <code>#2 &lt; #1</code>, either one of which is 
valid. Presumably, the intended meaning should be that the total order of the mutex object <code class='backtick'>m</code> in this 
program is <code>#1 &lt; #2</code> according to happens-before and 6.10.2.2 <a href="https://timsong-cpp.github.io/cppwp/intro.races">[intro.races]</a> p11. 
</p>


<p id="res-4519"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N5032" title=" Working Draft, Standard for Programming Language C++">N5032</a>.
</p>

<ol>
<li><p>Modify 32.6.4.2.1 <a href="https://timsong-cpp.github.io/cppwp/thread.mutex.requirements.mutex.general">[thread.mutex.requirements.mutex.general]</a> as indicated:</p>

<blockquote>
<p>
-4- The implementation provides lock and unlock operations, as described below. For purposes of determining
the existence of a data race, these behave as atomic operations (6.10.2 <a href="https://timsong-cpp.github.io/cppwp/intro.multithread">[intro.multithread]</a>). 
T<ins>herefore, t</ins>he lock and unlock operations on a single mutex 
appears to occur in a single total order <ins>as if they were modifications to a hypothetical atomic 
object corresponding to the mutex object</ins>.
<p/>
[<i>Note 2</i>: This can be viewed as the modification order <del>(6.10.2 <a href="https://timsong-cpp.github.io/cppwp/intro.multithread">[intro.multithread]</a>)</del> of the 
mutex. <ins>Specifically, the requirements in 6.10.2.2 <a href="https://timsong-cpp.github.io/cppwp/intro.races">[intro.races]</a> that are imposed on the 
modification order of an atomic object are also imposed on the total order of the mutex.</ins> &mdash; 
<i>end note</i>]
</p>
</blockquote>
</li>

</ol>





</body>
</html>
