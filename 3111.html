<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3111: Too strong precondition on basic_string constructor</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="3111" href="lwg-active.html#3111">3111.</a> Too strong precondition on <code>basic_string</code> constructor</h3>
<p><b>Section:</b> 24.3.2.2 <a href="https://timsong-cpp.github.io/cppwp/string.cons">[string.cons]</a> <b>Status:</b> <a href="lwg-active.html#Open">Open</a>
 <b>Submitter:</b> Andrzej Krzemienski <b>Opened:</b> 2018-05-09 <b>Last modified:</b> 2018-06-04 20:08:01 UTC</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View other</b> <a href="lwg-index-open.html#string.cons">active issues</a> in [string.cons].</p>
<p><b>View all other</b> <a href="lwg-index.html#string.cons">issues</a> in [string.cons].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Open">Open</a> status.</p>
<p><b>Discussion:</b></p>
<p>
The following is the spec for <code>basic_string</code> constructor taking a pointer and a size in 
<a href="http://wg21.link/n4741">N4741</a> ([string.cons]/12-14):
</p>
<blockquote>
<p>
<code>basic_string(const charT* s, size_type n, const Allocator&amp; a = Allocator());</code>
</p>
<p>
<sup>(12)</sup> <em>Requires:</em> <code>s</code> points to an array of at least <code>n</code> elements of <code>charT</code>.
</p>
<p>
<sup>(13)</sup> <em>Effects:</em> Constructs an object of class <code>basic_string</code> and determines its 
initial string value from the array of <code>charT</code> of length <code>n</code> whose first element is designated 
by <code>s</code>.
</p>
<p>
<sup>(14)</sup> <em>Postconditions:</em> <code>data()</code> points at the first element of an allocated copy of 
the array whose first element is pointed at by <code>s</code>, <code>size()</code> is equal to <code>n</code>, and 
<code>capacity()</code> is a value at least as large as <code>size()</code>.
</p>
</blockquote>

<p>
This implies that passing a null pointer and a zero size to this constructor is violating the precondition, as null 
pointer cannot be described as "pointing to an array of at least <code>n</code> elements of <code>charT</code>". 
On the other hand, being able to pass <code>{nullptr, 0}</code> is essential for <code>basic_string</code> to be 
able to inter-operate with other containers that are allowed to use the null pointer value to represent sequences 
of size zero:
</p>
<blockquote><pre>
std::vector&lt;char&gt; v{};
assert(v.data() == nullptr); <em>// on some implementations</em>
std::string s(v.data(), v.size()); <em>// nullptr on some implementations</em>
</pre></blockquote>

<p>
This has been already acknowledged as a defect in issue <a href="2235">2235</a> and applied, but the resolution still implies 
a too strong precondition.
</p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">
<p>
This wording is relative to <a href="http://wg21.link/n4741">N4741</a>.
</p>

<ol>
<li>
<p>Edit 24.3.2.2 <a href="https://timsong-cpp.github.io/cppwp/string.cons">[string.cons]</a> as indicated:</p>

<blockquote>
<pre>
basic_string(const charT* s, size_type n, const Allocator&amp; a = Allocator());
</pre>
<blockquote>
<p>
-12- <i>Requires:</i> <ins>Unless <tt>n == 0</tt>,</ins> <tt>s</tt> points to an array of at least <tt>n</tt> elements 
of <tt>charT</tt>.
<p/>
-13- <i>Effects:</i> Constructs an object of class <tt>basic_string</tt> and<ins>, unless <tt>n == 0</tt>,</ins> determines 
its initial string value from the array of <tt>charT</tt> of length <tt>n</tt> whose first element is designated by <tt>s</tt>.
<p/>
-14- <i>Postconditions:</i> <ins>If <tt>n != 0</tt>, then</ins> <tt>data()</tt> points at the first element of an allocated 
copy of the array whose first element is pointed at by <tt>s</tt><del>,</del><ins>;</ins> <tt>size()</tt> is equal to 
<tt>n</tt>, and <tt>capacity()</tt> is a value at least as large as <tt>size()</tt>.
</p>
</blockquote>
</blockquote>
</li>
</ol>
</blockquote>

<p><i>[
2016-06-04 Marshall provides alternate resolution
]</i></p>




<p><b>Proposed resolution:</b></p>
<p>This wording is relative to <a href="http://wg21.link/n4750">N4750</a>.</p>

<ol>
<li>
<p>Edit 24.3.2.2 <a href="https://timsong-cpp.github.io/cppwp/string.cons">[string.cons]</a> as indicated:</p>
<blockquote>
<pre>
basic_string(const charT* s, size_type n, const Allocator&amp; a = Allocator());
</pre>
<blockquote>
<p>
-12- <i>Requires:</i> <ins><tt>[s, s + n)</tt> is a valid range</ins><del><tt>s</tt> points to an array of at least <tt>n</tt> elements of <tt>charT</tt></del>.
</p>
<p>
-13- <i>Effects:</i> Constructs an object of class <tt>basic_string</tt> and determines 
its initial string value from the <ins>range <tt>[s, s + n)</tt></ins><del>array of <tt>charT</tt> of length <tt>n</tt> whose first element is designated by <tt>s</tt></del>.
</p>
-14- <i>Postconditions:</i> <del><tt>data()</tt> points at the first element of an allocated 
copy of the array whose first element is pointed at by <tt>s</tt>, </del><tt>size()</tt> is equal to 
<tt>n</tt>, <del>and </del><tt>capacity()</tt> is a value at least as large as <tt>size()</tt><ins>, and <tt>traits::compare(data(), s, n) == 0</tt></ins>.
<p>
</p>
</blockquote>
</blockquote>

</li>
</ol>






</body>
</html>
