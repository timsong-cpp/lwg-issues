<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3191: std::ranges::shuffle synopsis does not match algorithm definition</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="3191" href="lwg-active.html#3191">3191.</a> <tt>std::ranges::shuffle</tt> synopsis does not match algorithm definition</h3>
<p><b>Section:</b> 25.6.13 <a href="https://timsong-cpp.github.io/cppwp/alg.random.shuffle">[alg.random.shuffle]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Christopher Di Bella <b>Opened:</b> 2019-03-02 <b>Last modified:</b> 2019-03-05 19:25:33 UTC</p>
<p><b>Priority: </b>1
</p>
<p><b>View all other</b> <a href="lwg-index.html#alg.random.shuffle">issues</a> in [alg.random.shuffle].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
25.4 <a href="https://timsong-cpp.github.io/cppwp/algorithm.syn">[algorithm.syn]</a> declares <tt>std::ranges::shuffle</tt> like so:
</p>
<blockquote><pre>
namespace ranges {
  template&lt;RandomAccessIterator I, Sentinel&lt;I&gt; S, class Gen&gt;
    requires Permutable&lt;I&gt; &amp;&amp;
             UniformRandomBitGenerator&lt;remove_reference_t&lt;Gen&gt;&gt; &amp;&amp;
             ConvertibleTo&lt;invoke_result_t&lt;Gen&amp;&gt;, iter_difference_t&lt;I&gt;&gt;
  I shuffle(I first, S last, Gen&amp;&amp; g);

  template&lt;RandomAccessRange R, class Gen&gt;
    requires Permutable&lt;iterator_t&lt;R&gt; &amp;&amp;
             UniformRandomBitGenerator&lt;remove_reference_t&lt;Gen&gt;&gt; &amp;&amp;
             ConvertibleTo&lt;invoke_result_t&lt;Gen&amp;&gt;, iter_difference_t&lt;iterator_t&lt;R&gt;&gt;&gt;
  safe_iterator_t&lt;R&gt; shuffle(R&amp;&amp; r, Gen&amp;&amp; g);
}
</pre></blockquote>
<p>
25.6.13 <a href="https://timsong-cpp.github.io/cppwp/alg.random.shuffle">[alg.random.shuffle]</a> defines the algorithm like so:
</p>
<blockquote><pre>
namespace ranges {
  template&lt;RandomAccessIterator I, Sentinel&lt;I&gt; S, class Gen&gt;
    requires Permutable&lt;I&gt; &amp;&amp;
             UniformRandomBitGenerator&lt;remove_reference_t&lt;Gen&gt;&gt;
  I shuffle(I first, S last, Gen&amp;&amp; g);

  template&lt;RandomAccessRange R, class Gen&gt;
    requires Permutable&lt;iterator_t&lt;R&gt;&gt; &amp;&amp;
             UniformRandomBitGenerator&lt;remove_reference_t&lt;Gen&gt;&gt;
  safe_iterator_t&lt;R&gt; shuffle(R&amp;&amp; r, Gen&amp;&amp; g);
}
</pre></blockquote>
<p>
Notice the missing <tt>ConvertibleTo</tt> requirements in the latter. Looking at the 
<a href="https://wg21.link/n4685#page=157">Ranges TS</a>, [alg.random.shuffle] includes 
this requirement, albeit in the Ranges TS-format.
</p>

<p><i>[2019-03-03; Daniel comments]</i></p>

<p>
Given that the accepted proposal <a href="https://wg21.link/p0896r4">P0896R4</a> voted in San Diego 
did contain the same error I decided to open this issue instead of submitting an editorial change request.
</p>

<p><i>[2019-03-05 Priority set to 1 after reflector discussion]</i></p>

<p>
Casey: The correct fix here is to remove the <tt>ConvertibleTo</tt> requirement from the header 
synopsis. <tt>UniformRandomBitGenerator</tt>s have integral result types, and the core language guarantees 
that all integral types are convertible to all other integral types. We don't need to validate the core 
language in the associated constraints of <tt>ranges::shuffle</tt>.
</p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">
<p>This wording is relative to <a href="https://wg21.link/n4800">N4800</a>.</p>

<ol>
<li><p>Change 25.6.13 <a href="https://timsong-cpp.github.io/cppwp/alg.random.shuffle">[alg.random.shuffle]</a> as indicated:</p>

<blockquote>
<pre>
[&hellip;]
namespace ranges {
  template&lt;RandomAccessIterator I, Sentinel&lt;I&gt; S, class Gen&gt;
    requires Permutable&lt;I&gt; &amp;&amp;
             UniformRandomBitGenerator&lt;remove_reference_t&lt;Gen&gt;&gt; <ins>&amp;&amp;
             ConvertibleTo&lt;invoke_result_t&lt;Gen&amp;&gt;, iter_difference_t&lt;I&gt;&gt;</ins>
    I shuffle(I first, S last, Gen&amp;&amp; g);
  template&lt;RandomAccessRange R, class Gen&gt;
    requires Permutable&lt;iterator_t&lt;R&gt;&gt; &amp;&amp;
             UniformRandomBitGenerator&lt;remove_reference_t&lt;Gen&gt;&gt; <ins>&amp;&amp;
             ConvertibleTo&lt;invoke_result_t&lt;Gen&amp;&gt;, iter_difference_t&lt;iterator_t&lt;R&gt;&gt;&gt;</ins>
    safe_iterator_t&lt;R&gt; shuffle(R&amp;&amp; r, Gen&amp;&amp; g);
}
</pre>
</blockquote>
</li>
</ol>
</blockquote>

<p><i>[2019-03-05 Updated proposed wording according to Casey's suggestion]</i></p>



<p><b>Proposed resolution:</b></p>
<p>This wording is relative to <a href="https://wg21.link/n4800">N4800</a>.</p>

<ol>
<li><p>Change 25.4 <a href="https://timsong-cpp.github.io/cppwp/algorithm.syn">[algorithm.syn]</a> as indicated:</p>

<blockquote>
<pre>
<i>// 25.6.13 <a href="https://timsong-cpp.github.io/cppwp/alg.random.shuffle">[alg.random.shuffle]</a>, shuffle</i>
[&hellip;]
namespace ranges {
  template&lt;RandomAccessIterator I, Sentinel&lt;I&gt; S, class Gen&gt;
    requires Permutable&lt;I&gt; &amp;&amp;
             UniformRandomBitGenerator&lt;remove_reference_t&lt;Gen&gt;&gt; <del>&amp;&amp;
             ConvertibleTo&lt;invoke_result_t&lt;Gen&amp;&gt;, iter_difference_t&lt;I&gt;&gt;</del>
  I shuffle(I first, S last, Gen&amp;&amp; g);

  template&lt;RandomAccessRange R, class Gen&gt;
    requires Permutable&lt;iterator_t&lt;R&gt; &amp;&amp;
             UniformRandomBitGenerator&lt;remove_reference_t&lt;Gen&gt;&gt; <del>&amp;&amp;
             ConvertibleTo&lt;invoke_result_t&lt;Gen&amp;&gt;, iter_difference_t&lt;iterator_t&lt;R&gt;&gt;&gt;</del>
  safe_iterator_t&lt;R&gt; shuffle(R&amp;&amp; r, Gen&amp;&amp; g);
}
[&hellip;]
</pre>
</blockquote>
</li>
</ol>




</body>
</html>
