<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 2994: Needless UB for basic_string and basic_string_view</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="2994" href="lwg-active.html#2994">2994.</a> Needless UB for <tt>basic_string</tt> and <tt>basic_string_view</tt></h3>
<p><b>Section:</b> 23.2 <a href="https://timsong-cpp.github.io/cppwp/char.traits">[char.traits]</a>, 23.4.3.2 <a href="https://timsong-cpp.github.io/cppwp/string.require">[string.require]</a>, 23.3.3 <a href="https://timsong-cpp.github.io/cppwp/string.view.template">[string.view.template]</a> <b>Status:</b> <a href="lwg-active.html#Voting">Voting</a>
 <b>Submitter:</b> Gennaro Prota <b>Opened:</b> 2017-07-03 <b>Last modified:</b> 2023-06-09 14:49:37 UTC</p>
<p><b>Priority: </b>3
</p>
<p><b>View all other</b> <a href="lwg-index.html#char.traits">issues</a> in [char.traits].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Voting">Voting</a> status.</p>
<p><b>Discussion:</b></p>
<p>
<tt>basic_string</tt> and <tt>basic_string_view</tt> involve undefined behavior in a few cases where it's 
simple for the implementation to add a <tt>static_assert</tt> and make the program ill-formed.
<p/>
With regards to basic_string, 23.2 <a href="https://timsong-cpp.github.io/cppwp/char.traits">[char.traits]</a>/3 states:
</p>
<blockquote><p>
<tt>Traits::char_type</tt> shall be the same as <tt>CharT</tt>.
</p></blockquote>
<p>
Here, the implementation can add a <tt>static_assert</tt> using the <tt>is_same</tt>
type trait. Similar issues exist in 23.4.3.2 <a href="https://timsong-cpp.github.io/cppwp/string.require">[string.require]</a> and, for
<tt>basic_string_view</tt>, in 23.3.3 <a href="https://timsong-cpp.github.io/cppwp/string.view.template">[string.view.template]</a>/1. 
</p>

<p><i>[2017-07 Toronto Tuesday PM issue prioritization]</i></p>

<p>Priority 3; need to check general container requirements</p>

<p>Partially by the adoption of <a href="https://wg21.link/P1148">P1148</a> in San Diego.</p>
<p>Tim opines: "the remainder deals with allocator value type mismatch, which I think is NAD."</p>
<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">

<p>
This wording is relative to <a href="https://wg21.link/n4659">N4659</a>.
</p>

<ol>
<li><p>Edit 23.2 <a href="https://timsong-cpp.github.io/cppwp/char.traits">[char.traits]</a> as indicated:</p>

<blockquote>
<p>
-3- To specialize those templates to generate a string or iostream class to handle a particular character container
type <tt>CharT</tt>, that and its related character traits class <tt>Traits</tt> are passed as a pair of parameters to 
the string or iostream template as parameters <tt>charT</tt> and <tt>traits</tt>. <ins>If</ins> <tt>Traits::char_type</tt> 
<del>shall be the same</del> <ins>is not the same type</ins> as <tt>CharT</tt><ins>, the program is ill-formed</ins>.
</p>
</blockquote>
</li>

<li><p>Edit 23.4.3.2 <a href="https://timsong-cpp.github.io/cppwp/string.require">[string.require]</a> as indicated:</p>

<blockquote>
<p>
-3- In every specialization <tt>basic_string&lt;charT, traits, Allocator&gt;</tt>, <ins>if</ins> <del>the type</del> 
<tt>allocator_traits&lt;Allocator&gt;::value_type</tt> <del>shall name the same type</del> <ins>is not the 
same type</ins> as <tt>charT</tt><ins>, the program is ill-formed</ins>. 
Every object of type <tt>basic_string&lt;charT, traits, Allocator&gt;</tt> shall use an object of type 
<tt>Allocator</tt> to allocate and free storage for the contained <tt>charT</tt> objects as needed. The 
<tt>Allocator</tt> object used shall be obtained as described in 24.2.2.1 <a href="https://timsong-cpp.github.io/cppwp/container.requirements.general">[container.requirements.general]</a>. 
In every specialization <tt>basic_string&lt;charT, traits, Allocator&gt;</tt>, the type <tt>traits</tt> 
shall satisfy the character traits requirements (23.2 <a href="https://timsong-cpp.github.io/cppwp/char.traits">[char.traits]</a>)<ins>. If</ins><del>, and the type</del> 
<tt>traits::char_type</tt> <del>shall name the same type</del> <ins>is not the same type</ins> as <tt>charT</tt><ins>, 
the program is ill-formed</ins>.
</p>
</blockquote>
</li>

<li><p>Edit 23.3.3 <a href="https://timsong-cpp.github.io/cppwp/string.view.template">[string.view.template]</a> as indicated:</p>

<blockquote>
<p>
-1- In every specialization <tt>basic_string_view&lt;charT, traits&gt;</tt>, the type <tt>traits</tt> shall satisfy the character
traits requirements (23.2 <a href="https://timsong-cpp.github.io/cppwp/char.traits">[char.traits]</a>)<ins>. If</ins><del>, and the type</del> <tt>traits::char_type</tt> <del>shall 
name the same type</del> <ins>is not the same type</ins> as <tt>charT</tt><ins>, the program is ill-formed</ins>.
</p>
</blockquote>
</li>

</ol>
</blockquote>


<p><i>[2023-05-15; Jonathan Wakely provides improved wording]</i></p>

<p>
As noted above, most of this issue was resolved by <a href="https://wg21.link/P1148R0">P1148R0</a>.
The remainder is the change to make it ill-formed if the allocator has the wrong
<code>value_type</code>, but since <a href="https://wg21.link/P1463R1">P1463R1</a> that is already part of
the Allocator-aware container requirements, which apply to <code>basic_string</code>.
</p>


<p><i>[2023-06-01; Reflector poll]</i></p>

<p>
Set status to Tentatively Ready after eight votes in favour during reflector poll.
</p>
<p>
There was a request to editorially move the added text in <i>Note 1</i> into
<i>Note 2</i> after this is approved.
</p>



<p id="res-2994"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N4950">N4950</a>.
</p>

<ol>
<li><p>Edit 23.4.3.2 <a href="https://timsong-cpp.github.io/cppwp/string.require">[string.require]</a> as indicated:</p>

<blockquote>
<p>
-3- <del>In every specialization <tt>basic_string&lt;charT, traits, Allocator&gt;</tt>, the type
<tt>allocator_traits&lt;Allocator&gt;::value_type</tt> shall name the same type as <tt>charT</tt>.</del>
Every object of type <tt>basic_string&lt;charT, traits, Allocator&gt;</tt> shall use an object of type
<tt>Allocator</tt> to allocate and free storage for the contained <tt>charT</tt> objects as needed. The
In every specialization <tt>basic_string&lt;charT, traits, Allocator&gt;</tt>, the type <tt>traits</tt>
shall satisfy the character traits requirements (23.2 <a href="https://timsong-cpp.github.io/cppwp/char.traits">[char.traits]</a>).
</p>
<p>
[<i>Note 1</i>:
Every specialization <code>basic_string&lt;charT, traits, Allocator&gt;</code>
is an allocator-aware container, but does not use the allocatorâ€™s
<code>construct</code> and <code>destroy</code> member functions
(24.2.2.1 <a href="https://timsong-cpp.github.io/cppwp/container.requirements.general">[container.requirements.general]</a>).
<ins>
The program is ill-formed if <code>Allocator::value_type</code>
is not the same type as <code>charT</code>.
</ins>
&mdash; <i>end note</i>]
</p>
<p>
[<i>Note 2</i>:
The program is ill-formed if <code>traits::char_type</code>
is not the same type as <code>charT</code>.
&mdash; <i>end note</i>]
</p>
</blockquote>
</li>
</ol>





</body>
</html>
