<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3992: basic_stringbuf::str()&amp;&amp; should enforce &#x1d4aa;(1)</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3992" href="lwg-active.html#3992">3992.</a> <tt>basic_stringbuf::str()&amp;&amp;</tt> should enforce &#x1d4aa;(1)</h3>
<p><b>Section:</b> 31.8.2.4 <a href="https://timsong-cpp.github.io/cppwp/stringbuf.members">[stringbuf.members]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Peter Sommerlad <b>Opened:</b> 2023-10-05 <b>Last modified:</b> 2023-10-14 13:40:27 UTC</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#stringbuf.members">issues</a> in [stringbuf.members].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Recent discussions on <a href="https://github.com/llvm/llvm-project/issues/64644">llvm-64644</a>
came to the conclusion that <tt>basic_stringbuf() &amp;&amp;</tt> introduced by <a href="https://wg21.link/P0408">P0408</a>
might just copy the underlying buffer into a string object and not actually move the allocated space. 
While the wording tried to encourage that, especially with the postcondition that the buffer must 
be empty afterwards, it failed to specify that the move is never a copy.
<p/>
I suggest to amend the specification to enforce implementors to do the <tt>&#x1d4aa;(1)</tt> thing. 
There might be ABI issues for those who still copy.
<p/>
Some investigation into 24.2.2.2 <a href="https://timsong-cpp.github.io/cppwp/container.reqmts">[container.reqmts]</a> p.16 and 23.4.3.1 <a href="https://timsong-cpp.github.io/cppwp/basic.string.general">[basic.string.general]</a> 
shows that a <tt>basic_string</tt> as a standard container should move with <tt>&#x1d4aa;(1)</tt>.
<p/>
Unfortunately, we cannot say
</p>
<blockquote><p>
<ins><tt>str().data() == buf.data()</tt> before calling <tt>str()</tt></ins>
</p></blockquote>
<p>
as a postcondition due to SSO. Maybe a note could be added to eliminate the confusion.
</p>


<p id="res-3992"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N4958">N4958</a>.
</p>

<ol>

<li><p>Modify 31.8.2.4 <a href="https://timsong-cpp.github.io/cppwp/stringbuf.members">[stringbuf.members]</a> as indicated:</p>

<blockquote>
<pre>
basic_string&lt;charT, traits, Allocator&gt; str() &amp;&amp;;
</pre>
<blockquote>
<p>
-9- <i>Postconditions</i>: The underlying character sequence <tt>buf</tt> is empty and <tt>pbase()</tt>, <tt>pptr()</tt>, 
<tt>epptr()</tt>, <tt>eback()</tt>, <tt>gptr()</tt>, and <tt>egptr()</tt> are initialized as if by calling 
<tt>init_buf_ptrs()</tt> with an empty <tt>buf</tt>.
<p/>
-10- <i>Returns</i>: A <tt>basic_string&lt;charT, traits, Allocator&gt;</tt> object move constructed from the 
<tt>basic_stringbuf</tt>'s underlying character sequence in <tt>buf</tt>. This can be achieved by first adjusting <tt>buf</tt> 
to have the same content as <tt>view()</tt>.
<p/>
<ins>[<i>Note:</i> &mdash; 24.2.2.2 <a href="https://timsong-cpp.github.io/cppwp/container.reqmts">[container.reqmts]</a> require the move construction of the return
value to be <tt>&#x1d4aa;(1)</tt> <i>end note</i>]</ins>
</p>
</blockquote>
</blockquote>

</li>

</ol>





</body>
</html>
