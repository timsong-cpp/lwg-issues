<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Issue 4510: Ambiguity of std::ranges::advance and std::ranges::next when the difference type is also a sentinel type</title>
<meta property="og:title" content="Issue 4510: Ambiguity of std::ranges::advance and std::ranges::next when the difference type is also a sentinel type">
<meta property="og:description" content="C++ library issue. Status: New">
<meta property="og:url" content="https://timsong-cpp.github.io/lwg-issues/4510.html">
<meta property="og:type" content="website">
<meta property="og:image" content="http://cplusplus.github.io/LWG/images/cpp_logo.png">
<meta property="og:image:alt" content="C++ logo">
<style>
  p {text-align:justify}
  li {text-align:justify}
  pre code.backtick::before { content: "`" }
  pre code.backtick::after { content: "`" }
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table.issues-index { border: 1px solid; border-collapse: collapse; }
  table.issues-index th { text-align: center; padding: 4px; border: 1px solid; }
  table.issues-index td { padding: 4px; border: 1px solid; }
  table.issues-index td:nth-child(1) { text-align: right; }
  table.issues-index td:nth-child(2) { text-align: left; }
  table.issues-index td:nth-child(3) { text-align: left; }
  table.issues-index td:nth-child(4) { text-align: left; }
  table.issues-index td:nth-child(5) { text-align: center; }
  table.issues-index td:nth-child(6) { text-align: center; }
  table.issues-index td:nth-child(7) { text-align: left; }
  table.issues-index td:nth-child(5) span.no-pr { color: red; }
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3 id="4510"><a href="lwg-active.html#4510">4510</a>. Ambiguity of <code class='backtick'>std::ranges::advance</code> and <code class='backtick'>std::ranges::next</code> when the difference type is also a sentinel type</h3>
<p><b>Section:</b> 24.4.4.2 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.advance">[range.iter.op.advance]</a>, 24.4.4.4 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.next">[range.iter.op.next]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Jiang An <b>Opened:</b> 2026-01-09 <b>Last modified:</b> 2026-02-20</p>
<p><b>Priority: </b>3
</p>
<p><b>View all other</b> <a href="lwg-index.html#range.iter.op.advance">issues</a> in [range.iter.op.advance].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Currently, <code class='backtick'>ranges::advance</code> and <code class='backtick'>ranges::next</code> have <code class='backtick'>operator()</code> overloads that accept 
<code class='backtick'>(iterator, sentinel)</code> and <code class='backtick'>(iterator, difference)</code>. However, when the difference type 
of the iterator is also a sentinel type, there may be ambiguity in both overloads.
<p/>
E.g. the following example is rejected when compiling with libc++ or libstdc++ 
(<a href="https://godbolt.org/z/z3rPEhjjs">demo</a>):
</p>
<blockquote><pre>
#include &lt;cstddef&gt;
#include &lt;iterator&gt;
#include &lt;type_traits&gt;

template&lt;class T&gt;
struct FwdIter { // triggers ADL for T
  FwdIter();

  using value_type      = std::remove_cv_t&lt;T&gt;;
  using difference_type = int;

  T&amp; operator*() const;

  FwdIter&amp; operator++();
  FwdIter operator++(int);

  friend bool operator==(const FwdIter&amp;, const FwdIter&amp;);
};

static_assert(std::forward_iterator&lt;FwdIter&lt;int&gt;&gt;);

struct OmniConv {
  OmniConv(const auto&amp;);
  friend bool operator==(OmniConv, OmniConv); // found by ADL via things related to OmniConv
};

int main() {
  FwdIter&lt;OmniConv&gt; it{};
  std::ranges::advance(it, 0); // ambiguous
  std::ranges::next(it, 0); // ambiguous
}
</pre></blockquote>
<p>
Perhaps it would be better to ensure that calling <code class='backtick'>ranges::advance</code> or <code class='backtick'>ranges::next</code> 
with an iterator value and a value of the difference type is unambiguous. Note that 
wrapping iterators that trigger ADL for the value type like the <code class='backtick'>FwdIter</code> in this example 
are common in standard library implementations, so ambiguity can be easily raised from 
containers with such <code class='backtick'>OmniConv</code> being their element type.
</p>

<p><i>[2026-02-20; Reflector poll.]</i></p>

<p>
Set priority to 3 after reflector poll.
</p>
<p>
The type in the example is basically a <code class='backtick'>std::any</code> that additionally type-erases
equality. That causes a problem for templated iterators that have their
value type's namespace as an associated namespace for ADL.
</p>
<p>
Instead of allowing integers to be sentinels in general but just restricting
them from being used with these overloads, we could just change the concept
so that integers do not model <code class='backtick'>sentinel_for</code>.
That's similar to what we did for <code class='backtick'>span</code>'s constructor which has a similar
problem (though that one's more aggressive due to compatibility constraints).
</p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">

<p>
This wording is relative to <a href="https://wg21.link/N5032" title=" Working Draft, Standard for Programming Language C++">N5032</a>.
</p>

<ol>
<li><p>Modify 24.2 <a href="https://timsong-cpp.github.io/cppwp/iterator.synopsis">[iterator.synopsis]</a>, header <code>&lt;iterator&gt;</code> synopsis, as indicated:</p>

<blockquote>
<pre>
[&hellip;]
namespace std {
  template&lt;class T&gt; using <i>with-reference</i> = T&amp;; <i>// exposition only</i>
  template&lt;class T&gt; concept <i>can-reference</i>      <i>// exposition only</i>
    = requires { typename <i>with-reference</i>&lt;T&gt;; };
  template&lt;class T&gt; concept <i>dereferenceable</i>    <i>// exposition only</i>
    = requires(T&amp; t) {
      { *t } -&gt; <i>can-reference</i>; <i>// not required to be equality-preserving</i>
    };
  
  <ins>template&lt;class T&gt;
    constexpr bool <i>is-integer-like</i> = <i>see below</i>;           <i>// exposition only</i></ins>

  [&hellip;]
  <i>// 24.4.4 <a href="https://timsong-cpp.github.io/cppwp/range.iter.ops">[range.iter.ops]</a>, range iterator operations</i>
  namespace ranges {
    <i>// 24.4.4.2 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.advance">[range.iter.op.advance]</a>,</i> ranges::advance
    template&lt;input_or_output_iterator I&gt;
      constexpr void advance(I&amp; i, iter_difference_t&lt;I&gt; n);                <i>// freestanding</i>
    template&lt;input_or_output_iterator I, <del>sentinel_for&lt;I&gt;</del><ins>class</ins> S&gt;
      <ins>requires (!<i>is-integer-like</i>&lt;S&gt;) &amp;&amp; sentinel_for&lt;S, I&gt;</ins>
      constexpr void advance(I&amp; i, S bound);                               <i>// freestanding</i>
    template&lt;input_or_output_iterator I, sentinel_for&lt;I&gt; S&gt;
      constexpr iter_difference_t&lt;I&gt; advance(I&amp; i, iter_difference_t&lt;I&gt; n, <i>// freestanding</i>
                                             S bound);    
   [&hellip;]
    <i>// 24.4.4.4 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.next">[range.iter.op.next]</a>,</i> ranges::next
    template&lt;input_or_output_iterator I&gt;
      constexpr I next(I x);                                  <i>// freestanding</i>
    template&lt;input_or_output_iterator I&gt;
      constexpr I next(I x, iter_difference_t&lt;I&gt; n);          <i>// freestanding</i>
    template&lt;input_or_output_iterator I, <del>sentinel_for&lt;I&gt;</del><ins>class</ins> S&gt;
      <ins>requires (!<i>is-integer-like</i>&lt;S&gt;) &amp;&amp; sentinel_for&lt;S, I&gt;</ins>
      constexpr I next(I x, S bound);                         <i>// freestanding</i>
    template&lt;input_or_output_iterator I, sentinel_for&lt;I&gt; S&gt;
      constexpr I next(I x, iter_difference_t&lt;I&gt; n, S bound); <i>// freestanding</i>    
  }
  [&hellip;]
}
</pre>
</blockquote>
</li>

<li><p>Modify 24.4.4.2 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.advance">[range.iter.op.advance]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;input_or_output_iterator I, <del>sentinel_for&lt;I&gt;</del><ins>class</ins> S&gt;
  <ins>requires (!<i>is-integer-like</i>&lt;S&gt;) &amp;&amp; sentinel_for&lt;S, I&gt;</ins>
  constexpr void advance(I&amp; i, S bound);
</pre>
<blockquote>
<p>
-3- <i>Preconditions</i>: [&hellip;]
</p>
</blockquote>
</blockquote>
</li>

<li><p>Modify 24.4.4.4 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.next">[range.iter.op.next]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;input_or_output_iterator I, <del>sentinel_for&lt;I&gt;</del><ins>class</ins> S&gt;
  <ins>requires (!<i>is-integer-like</i>&lt;S&gt;) &amp;&amp; sentinel_for&lt;S, I&gt;</ins>
  constexpr I next(I x, S bound);
</pre>
<blockquote>
<p>
-3- <i>Effects</i>: [&hellip;]
</p>
</blockquote>
</blockquote>
</li>

</ol>

</blockquote>

<p><i>[2026-02-20; Jonathan provides new wording]</i></p>




<p id="res-4510"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N5032" title=" Working Draft, Standard for Programming Language C++">N5032</a>.
</p>

<ol>
<li><p>Modify 24.3.4.7 <a href="https://timsong-cpp.github.io/cppwp/iterator.concept.sentinel">[iterator.concept.sentinel]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class S, class I&gt;
  concept sentinel_for =
    semiregular&lt;S&gt; &amp;&amp;
    <ins>!<i>is-integer-like</i>&lt;S&gt; &amp;&amp;</ins>
    input_or_output_iterator&lt;I&gt; &amp;&amp;
    weakly-equality-comparable-with&lt;S, I&gt;; <i>// see 18.5.4 <a href="https://timsong-cpp.github.io/cppwp/concept.equalitycomparable">[concept.equalitycomparable]</a></i>
</pre>
</blockquote>
</li>
</ol>






</body>
</html>
