<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3924: Stop token data race avoidance requirements unclear</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3924" href="lwg-active.html#3924">3924.</a> Stop token data race avoidance requirements unclear</h3>
<p><b>Section:</b> 33.3.1 <a href="https://timsong-cpp.github.io/cppwp/thread.stoptoken.intro">[thread.stoptoken.intro]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Brian Bi <b>Opened:</b> 2023-04-16 <b>Last modified:</b> 2023-05-24 14:33:00 UTC</p>
<p><b>Priority: </b>3
</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
The first sentence of 33.3.1 <a href="https://timsong-cpp.github.io/cppwp/thread.stoptoken.intro">[thread.stoptoken.intro]</a>/5 says:
</p>
<blockquote style="border-left: 3px solid #ccc;padding-left: 15px;">
<p>
Calls to the functions <tt>request_stop</tt>, <tt>stop_requested</tt>, and <tt>stop_possible</tt> do not introduce data races.
</p>
</blockquote>
<p>
This could be read as saying that if you have a program that doesn't contain data races, 
and you change it by adding a call to any of these three functions, such a change does not 
"introduce" data races into the program. In other words, it could be read as saying that 
these three functions don't race with any other member functions on the same 
<tt>stop_token</tt> or <tt>stop_source</tt> object.
<p/>
I'm guessing the actual intended meaning is that calls to these three functions do not race
with each other, because it would be more expensive if concurrent calls with 
<tt>stop_token::operator=</tt> were also required to not race. (Also, none of these functions 
can avoid racing with the destructor.)
</p>

<p><i>[2023-05-24; Reflector poll]</i></p>

<p>
Set priority to 3 after reflector poll.
</p>
<p>
"What about <code>get_token</code>? <code>operator==</code>?"
</p>
<p>
"Other functions like <code>get_stop_token</code> can also be called
concurrently. I think the text is actually correct."
</p>



<p id="res-3924"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N4944">N4944</a>.
</p>
<ol>
<li>
<p>Modify 33.3.1 <a href="https://timsong-cpp.github.io/cppwp/thread.stoptoken.intro">[thread.stoptoken.intro]</a> as indicated:</p>

<blockquote>
<p>
-5- Calls to the functions <tt>request_stop</tt>, <tt>stop_requested</tt>, and <tt>stop_possible</tt> 
do not introduce data races <ins>with each other</ins>.
A call to <tt>request_stop</tt> that returns <tt>true</tt> synchronizes with a call to 
<tt>stop_requested</tt> on an associated <tt>stop_token</tt> or <tt>stop_source</tt> object that 
returns <tt>true</tt>. Registration of a callback synchronizes with the invocation of that callback.
</p>
</blockquote>
</li>

</ol>






</body>
</html>
