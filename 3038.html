<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3038: polymorphic_allocator::allocate should not allow integer overflow to create vulnerabilities</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3038" href="lwg-defects.html#3038">3038.</a> <tt>polymorphic_allocator::allocate</tt> should not allow integer overflow to create vulnerabilities</h3>
<p><b>Section:</b> 20.12.3.3 <a href="https://timsong-cpp.github.io/cppwp/mem.poly.allocator.mem">[mem.poly.allocator.mem]</a> <b>Status:</b> <a href="lwg-active.html#C++20">C++20</a>
 <b>Submitter:</b> Billy O'Neal III <b>Opened:</b> 2017-11-16 <b>Last modified:</b> 2021-02-25 10:48:01 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View all other</b> <a href="lwg-index.html#mem.poly.allocator.mem">issues</a> in [mem.poly.allocator.mem].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#C++20">C++20</a> status.</p>
<p><b>Discussion:</b></p>
<p>
At the moment <tt>polymorphic_allocator</tt> is specified to do <tt>sizeof(T) * n</tt> directly; this may allow an attacker 
to cause this calculation to overflow, resulting in <tt>allocate()</tt> not meeting its postcondition of returning a buffer 
suitable to store <tt>n</tt> copies of <tt>T</tt>; this is a common bug described in 
<a href="http://cwe.mitre.org/data/definitions/190.html">CWE-190</a>.
<p/>
Making this into a saturating multiply should be sufficient to avoid this problem; any <tt>memory_resource</tt> 
underneath <tt>polymorphic_allocator</tt> is going to have to throw <tt>bad_alloc</tt> (or another exception) for a request 
of <tt>SIZE_MAX</tt>.
<p/>
(There's also a minor editorial thing here that <i>Returns</i> should be <i>Effects</i>)
</p>

<p><i>[2018-06 Rapperswil Thursday issues processing]</i></p>

<p>Consensus was that the overflow should be detected and an exception thrown rather than leaving that to the 
underlying memory resource. Billy to reword, and then get feedback on the reflector. Status to Open.</p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">
<p>
Wording relative to <a href="https://wg21.link/n4700">N4700</a>.
</p>

<ol>
<li>
<p>
Edit 20.12.3.3 <a href="https://timsong-cpp.github.io/cppwp/mem.poly.allocator.mem">[mem.poly.allocator.mem]</a> as indicated:
</p>
<blockquote>
<pre>
Tp* allocate(size_t n);
</pre>
<blockquote>
<p>
-1- <i><del>Returns</del><ins>Effects</ins>:</i> Equivalent to
</p>
<blockquote>
<pre>
return static_cast&lt;Tp*&gt;(memory_rsrc-&gt;allocate(<ins>SIZE_MAX / sizeof(Tp) &lt; n ? SIZE_MAX :</ins> n * sizeof(Tp), alignof(Tp)));
</pre>
</blockquote>
</blockquote>
</blockquote>
</li>
</ol>
</blockquote>

<p><i>[2018-08-23 Batavia Issues processing]</i></p>

<p>Status to Tentatively Ready with updated wording</p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">
<p>
Wording relative to <a href="https://wg21.link/n4762">N4762</a>.
</p>

<ol>
<li>
<p>
Edit 20.12.3.3 <a href="https://timsong-cpp.github.io/cppwp/mem.poly.allocator.mem">[mem.poly.allocator.mem]</a> as indicated:
</p>
<blockquote>
<pre>
Tp* allocate(size_t n);
</pre>
<blockquote>
<p>
-1- <i>Effects: </i><ins>If <tt>SIZE_MAX / sizeof(Tp) &lt; n</tt>, throws <tt>length_error</tt>, then</ins> <del>E</del><ins>e</ins>quivalent to:
</p>
<blockquote>
<pre>
return static_cast&lt;Tp*&gt;(memory_rsrc-&gt;allocate(n * sizeof(Tp), alignof(Tp)));
</pre>
</blockquote>
</blockquote>
</blockquote>
</li>
</ol>
</blockquote>


<p><i>[2018-11, Adopted in San Diego]</i></p>



<p><b>Proposed resolution:</b></p>
<p>
Wording relative to <a href="https://wg21.link/n4762">N4762</a>.
</p>

<ol>
<li>
<p>
Edit 20.12.3.3 <a href="https://timsong-cpp.github.io/cppwp/mem.poly.allocator.mem">[mem.poly.allocator.mem]</a> as indicated:
</p>
<blockquote>
<pre>
Tp* allocate(size_t n);
</pre>
<blockquote>
<p>
-1- <i>Effects: </i><ins>If <tt>SIZE_MAX / sizeof(Tp) &lt; n</tt>, throws <tt>length_error</tt>. Otherwise</ins> <del>E</del><ins>e</ins>quivalent to:
</p>
<blockquote>
<pre>
return static_cast&lt;Tp*&gt;(memory_rsrc-&gt;allocate(n * sizeof(Tp), alignof(Tp)));
</pre>
</blockquote>
</blockquote>
</blockquote>
</li>
</ol>





</body>
</html>
