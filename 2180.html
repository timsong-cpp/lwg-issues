<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 2180: Exceptions from std::seed_seq operations</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="2180" href="2180">2180.</a> Exceptions from <tt>std::seed_seq</tt> operations</h3>
<p><b>Section:</b> 26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> <b>Status:</b> <a href="lwg-active.html#C++14">C++14</a>
 <b>Submitter:</b> Daniel Kr&uuml;gler <b>Opened:</b> 2012-08-18 <b>Last modified:</b> 2016-01-28 10:19:27 UTC</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#rand.util.seedseq">issues</a> in <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a>.</p>
<p><b>View all issues with</b> <a href="lwg-status.html#C++14">C++14</a> status.</p>
<p><b>Discussion:</b></p>

<p>
26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> p1 says upfront:
</p>
<blockquote><p>
No function described in this section 26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> throws an exception.
</p></blockquote>
<p>
This constraint seems non-implementable to me when looking especially at the members
</p>
<blockquote><pre>
template&lt;class T&gt;
seed_seq(initializer_list&lt;T&gt; il);

template&lt;class InputIterator&gt;
seed_seq(InputIterator begin, InputIterator end);
</pre></blockquote>
<p>
which have the effect of invoking <tt>v.push_back()</tt> for the exposition-only member of
type <tt>std::vector</tt> (or its equivalent) over all elements of the provided range, so
out-of-memory exceptions are always possible and the <tt>seed_seq</tt> object doesn't seem
to be constructible this way.
<p/>
In addition to the potential lack-of-resources problem, the operations of <tt>InputIterator</tt>
might also throw exceptions.
<p/>
Aside to that it should me mentioned, that a default constructor of <tt>vector&lt;uint_least32_t&gt;</tt> 
in theory can also throw exceptions, even though this seems less of a problem to me in this context, because 
such an implementation could easily use a different internal container in <tt>seed_seq</tt> that can hold 
this no-throw exception guarantee.
<p/>
Secondly, a slightly different problem category related to exceptions occurs for the member templates
</p>
<blockquote><pre>
template&lt;class RandomAccessIterator&gt;
void generate(RandomAccessIterator begin, RandomAccessIterator end);

template&lt;class OutputIterator&gt;
void param(OutputIterator dest) const;
</pre></blockquote>
<p>
where the actual operations performed by the implementation would never need to throw, but since they invoke
operations of a user-provided customization point, the overall operation, like for example
</p>
<blockquote><pre>
copy(v.begin(), v.end(), dest);
</pre></blockquote>
<p>
could also throw exceptions. In this particular example we can just think of a <tt>std::back_insert_iterator</tt>
applied to a container that needs to allocate its elements used as the type for <tt>OutputIterator</tt>.
<p/>
Even though Clause 26 <a href="https://timsong-cpp.github.io/cppwp/numerics">[numerics]</a> has mostly stronger exception constraints than other parts of the
library the here discussed are overrestrictive, especially since no operation of <tt>std::seed_seq</tt> 
except the template <tt>generate</tt> is actually needed within the library implementation, as mentioned in the 
discussion of LWG <a href="2124">2124</a>.
<p/>
I suggest to remove the general no-exception constraints for operations of <tt>std::seed_seq</tt> except for
member <tt>size()</tt> and the default constructor and to provide specific wording for <tt>generate()</tt> and
<tt>param()</tt> to ensure that the algorithm itself is a nothrow operation, which is especially for
<tt>generate()</tt> important, because the templates specified in 26.6.3 <a href="https://timsong-cpp.github.io/cppwp/rand.eng">[rand.eng]</a> and 
26.6.4 <a href="https://timsong-cpp.github.io/cppwp/rand.adapt">[rand.adapt]</a> also depend on this property indirectly, which is further discussed in LWG 
<a href="2181">2181</a>.
<p/>
<u>Howard</u>:
<p/>
I suggest to use a different form for the exception specification, something similar to 
20.14.11.3 <a href="https://timsong-cpp.github.io/cppwp/func.bind.bind">[func.bind.bind]</a> p4:
</p>
<blockquote><p>
<i>Throws</i>: Nothing unless an operation on <tt>RandomAccessIterator</tt> throws an exception.
</p></blockquote>
<p>
<u>Daniel</u>:
<p/>
The currently suggested "what and when" form seems a bit more specific and harmonizes with the form used for
function template <tt>generate_canonical</tt> from 26.6.7.2 <a href="https://timsong-cpp.github.io/cppwp/rand.util.canonical">[rand.util.canonical]</a>.
</p>

<p><i>[2013-04-20, Bristol]</i></p>


<p>
Open an editorial issue on the exception wording ("Throws: What and when"). 
<p/>
Solution: move to tentatively ready. 
</p>

<p><i>[2013-09-29, Chicago]</i></p>


<p>
Apply to Working Paper
</p>


<p><b>Proposed resolution:</b></p>
<p>This wording is relative to N3376.</p>

<ol>
<li><p>Edit 26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> p1 as indicated:</p>

<blockquote>
<p>
<del>-1- No function described in this section 26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> throws an exception.</del>
</p>
</blockquote>
</li>

<li><p>Edit 26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> around p2 as indicated:</p>

<blockquote><pre>
seed_seq();
</pre><blockquote>
<p>
-2- <i>Effects</i>: Constructs a <tt>seed_seq</tt> object as if by default-constructing its member <tt>v</tt>.
<p/>
<ins>-?- <i>Throws</i>: Nothing.</ins>
</p>
</blockquote></blockquote>
</li>

<li><p>Edit 26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> around p7 as indicated:</p>

<blockquote><pre>
template&lt;class RandomAccessIterator&gt;
  void generate(RandomAccessIterator begin, RandomAccessIterator end);
</pre><blockquote>
<p>
-7- <i>Requires</i>: <tt>RandomAccessIterator</tt> shall meet the requirements of a mutable random access iterator
(Table 111) type. Moreover, <tt>iterator_traits&lt;class RandomAccessIterator&gt;::value_type</tt> shall denote
an unsigned integer type capable of accommodating 32-bit quantities.
<p/>
-8- <i>Effects</i>: Does nothing if <tt>begin == end</tt>. Otherwise, with <tt>s = v.size()</tt> and 
<tt>n = end - begin</tt>, fills the supplied range <tt>[begin, end)</tt> according to the following algorithm [&hellip;]
<p/>
<ins>-?- <i>Throws</i>: What and when <tt>RandomAccessIterator</tt> operations of <tt>begin</tt> and <tt>end</tt> throw.</ins>
</p>
</blockquote></blockquote>
</li>

<li><p>Edit 26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> around p9 as indicated:</p>

<blockquote><pre>
size_t size() const;
</pre><blockquote>
<p>
-9- <i>Returns</i>: The number of 32-bit units that would be returned by a call to <tt>param()</tt>.
<p/>
<ins>-??- <i>Throws</i>: Nothing.</ins>
<p/>
-10- <i>Complexity</i>: constant time.
</p>
</blockquote></blockquote>
</li>

<li><p>Edit 26.6.7.1 <a href="https://timsong-cpp.github.io/cppwp/rand.util.seedseq">[rand.util.seedseq]</a> around p11 as indicated:</p>

<blockquote><pre>
template&lt;class OutputIterator&gt;
  void param(OutputIterator dest) const;
</pre><blockquote>
<p>
-11- <i>Requires</i>: <tt>OutputIterator</tt> shall satisfy the requirements of an output iterator (Table 108) type. 
Moreover, the expression <tt>*dest = rt</tt> shall be valid for a value <tt>rt</tt> of type <tt>result_type</tt>.
<p/>
-12- <i>Effects</i>: Copies the sequence of prepared 32-bit units to the given destination, as if by executing the
following statement:
</p>
<blockquote><pre>
copy(v.begin(), v.end(), dest);
</pre></blockquote>
<p>
<ins>-??- <i>Throws</i>: What and when <tt>OutputIterator</tt> operations of <tt>dest</tt> throw.</ins>
</p>
</blockquote></blockquote>
</li>

</ol>






</body>
</html>
