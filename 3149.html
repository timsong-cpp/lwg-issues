<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3149: DefaultConstructible should require default initialization</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="3149" href="lwg-active.html#3149">3149.</a> <tt>DefaultConstructible</tt> should require default initialization</h3>
<p><b>Section:</b> 17.4.12 <a href="https://timsong-cpp.github.io/cppwp/concept.defaultconstructible">[concept.defaultconstructible]</a> <b>Status:</b> <a href="lwg-active.html#Open">Open</a>
 <b>Submitter:</b> Casey Carter <b>Opened:</b> 2018-08-09 <b>Last modified:</b> 2018-10-29 01:55:13 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Open">Open</a> status.</p>
<p><b>Discussion:</b></p>
<p>
<tt>DefaultConstructible&lt;T&gt;</tt> is equivalent to
<tt>Constructible&lt;T&gt;</tt> (17.4.11 <a href="https://timsong-cpp.github.io/cppwp/concept.constructible">[concept.constructible]</a>), which
is equivalent to <tt>is_constructible_v&lt;T&gt;</tt>
(19.15.4.3 <a href="https://timsong-cpp.github.io/cppwp/meta.unary.prop">[meta.unary.prop]</a>). Per 19.15.4.3 <a href="https://timsong-cpp.github.io/cppwp/meta.unary.prop">[meta.unary.prop]</a>
<a href="https://wg21.link/meta.unary.prop#8">paragraph 8</a>:
<blockquote>
<p>The predicate condition for a template specialization
<tt>is_Â­constructible&lt;T, Args...&gt;</tt> shall be satisfied if and only if
the following variable definition would be well-formed for some invented
variable <tt>t</tt>:</p>
<blockquote>
<pre>
T t(declval&lt;Args&gt;()...);
</pre>
</blockquote>
</blockquote>
<tt>DefaultConstructible&lt;T&gt;</tt> requires that objects of type <tt>T</tt>
can be
<a href="https://wg21.link/dcl.init#8"><i>value-initialized</i></a>,
rather than
<a href="https://wg21.link/dcl.init#7"><i>default-initialized</i></a>
as intended.
</p>
<p>
The library needs a constraint that requires object types to be
default-initializable: the "rangified" versions of the algorithms in
19.10.11.2 <a href="https://timsong-cpp.github.io/cppwp/uninitialized.construct.default">[uninitialized.construct.default]</a> proposed in
<a href="https://wg21.link/p0896">P0896 "The One Ranges Proposal"</a>, for
example. Users will also want a mechanism to provide such a constraint, and
they're likely to choose <tt>DefaultConstructible</tt> despite its subtle
unsuitability.
</p>
<p>
There are two alternative solutions: (1) change <tt>DefaultConstructible</tt>
to require <i>default-initialization</i>, (2) change
<tt>is_default_constructible_v</tt> to require default-initializaton and specify
the concept in terms of the trait. (2) is probably too breaking a change to be
feasible.
</p>

<p><i>[2018-08-20 Priority set to 2 after reflector discussion]</i></p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">
<ul>
<li><p>Modify 17.4.12 <a href="https://timsong-cpp.github.io/cppwp/concept.defaultconstructible">[concept.defaultconstructible]</a> as follows:</p>

<blockquote>
<pre>
template&lt;class T&gt;
  concept DefaultConstructible = Constructible&lt;T&gt; <ins>&amp;&amp; see below</ins>;
</pre>
<p>
<ins>-?- Type <tt>T</tt> models <tt>DefaultConstructible</tt> only if the variable
definition</ins>
<blockquote>
<pre>
<ins>T t;</ins>
</pre>
</blockquote>
<ins>is well-formed for some invented variable <tt>t</tt>. Access checking is
performed as if in a context unrelated to <tt>T</tt>. Only the validity of the
immediate context of the variable initialization is considered.</ins>
</p>
</blockquote>
</li>
</ul>
</blockquote>

<p><i>[2018-08-23 Tim provides updated P/R based on Batavia discussion]</i></p>


<p><i>[2018-10-28 Casey expands the problem statement and the P/R]</i></p>

<p>
During Batavia review of <a href="https://wg21.link/p0896r3">P0896R3</a>, Tim
Song noted that <tt>{}</tt> is not necessarily a valid initializer for a
<tt>DefaultConstructible</tt> type. In this sample program
(see <a href="https://godbolt.org/z/I64p_E">Compiler Explorer</a>):
<blockquote>
<pre>
struct S0 { explicit S0() = default; };
struct S1 { S0 x; }; // Note: aggregate
S1 x;   // Ok
S1 y{}; // ill-formed; copy-list-initializes x from {}
</pre>
</blockquote>
<tt>S1</tt> can be default-initialized, but not list-initialized from an empty
<i>braced-init-list</i>. The consensus among those present was that
<tt>DefaultConstructible</tt> should prohibit this class of pathological types
by requiring that initialization form to be valid.
</p>



<p><b>Proposed resolution:</b></p>
<p>This wording is relative to <a href="https://wg21.link/n4762">N4762</a>.</p>
<ul>
<li><p>Modify 17.4.12 <a href="https://timsong-cpp.github.io/cppwp/concept.defaultconstructible">[concept.defaultconstructible]</a> as follows:</p>

<blockquote>
<pre>
<ins>template&lt;class T&gt;
  inline constexpr bool <i>is-default-initializable</i> = <i>see below</i>; // <i>exposition only</i></ins>

template&lt;class T&gt;
  concept DefaultConstructible = Constructible&lt;T&gt; <ins>&amp;&amp; requires { T{}; } &amp;&amp; <i>is-default-initializable</i>&lt;T&gt;</ins>;
</pre>
<p>
<ins>-?- For a type <tt>T</tt>, <tt><i>is-default-initializable</i>&lt;T&gt;</tt> is <tt>true</tt>
if and only if the variable definition</ins>
<blockquote>
<pre>
<ins>T t;</ins>
</pre>
</blockquote>
<ins>is well-formed for some invented variable <tt>t</tt>; otherwise it is <tt>false</tt>. Access checking is
performed as if in a context unrelated to <tt>T</tt>. Only the validity of the
immediate context of the variable initialization is considered.</ins>
</p>
</blockquote>
</li>
</ul>





</body>
</html>
