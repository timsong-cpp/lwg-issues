<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Issue 1147: Non-volatile atomic functions</title>
<meta property="og:title" content="Issue 1147: Non-volatile atomic functions">
<meta property="og:description" content="C++ library issue. Status: Resolved">
<meta property="og:url" content="https://timsong-cpp.github.io/lwg-issues/1147.html">
<meta property="og:type" content="website">
<meta property="og:image" content="http://cplusplus.github.io/LWG/images/cpp_logo.png">
<meta property="og:image:alt" content="C++ logo">
<style>
  p {text-align:justify}
  li {text-align:justify}
  pre code.backtick::before { content: "`" }
  pre code.backtick::after { content: "`" }
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table.issues-index { border: 1px solid; border-collapse: collapse; }
  table.issues-index th { text-align: center; padding: 4px; border: 1px solid; }
  table.issues-index td { padding: 4px; border: 1px solid; }
  table.issues-index td:nth-child(1) { text-align: right; }
  table.issues-index td:nth-child(2) { text-align: left; }
  table.issues-index td:nth-child(3) { text-align: left; }
  table.issues-index td:nth-child(4) { text-align: left; }
  table.issues-index td:nth-child(5) { text-align: center; }
  table.issues-index td:nth-child(6) { text-align: center; }
  table.issues-index td:nth-child(7) { text-align: left; }
  table.issues-index td:nth-child(5) span.no-pr { color: red; }
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3 id="1147"><a href="lwg-defects.html#1147">1147</a>. Non-volatile atomic functions</h3>
<p><b>Section:</b> 32.5.8.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.types.operations">[atomics.types.operations]</a> <b>Status:</b> <a href="lwg-active.html#Resolved">Resolved</a>
 <b>Submitter:</b> Jeffrey Yasskin <b>Opened:</b> 2009-06-16 <b>Last modified:</b> 2016-01-28</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View other</b> <a href="lwg-index-open.html#atomics.types.operations">active issues</a> in [atomics.types.operations].</p>
<p><b>View all other</b> <a href="lwg-index.html#atomics.types.operations">issues</a> in [atomics.types.operations].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Resolved">Resolved</a> status.</p>
<p><b>Discussion:</b></p>

<p><b>Addresses US 90</b></p>

<p>
The C++0X draft declares all of the functions dealing with atomics 
(section 32.5.8.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.types.operations">[atomics.types.operations]</a>) to take volatile 
arguments. Yet it also says (29.4-3),
</p>

<blockquote>
<p>
[ Note: Many operations are volatile-qualified.
The "volatile as device register" semantics have not changed in the standard.
This qualification means that volatility is preserved
when applying these operations to volatile objects.
It does not mean that operations on non-volatile objects become volatile.
Thus, volatile qualified operations on non-volatile objects
may be merged under some conditions. &mdash; end note ]
</p>
</blockquote>

<p>
I was thinking about how to implement this in gcc,
and I believe that we'll want to overload most of the functions
on volatile and non-volatile.
Here's why:
</p>

<p>
To let the compiler take advantage of the permission
to merge non-volatile atomic operations and reorder atomics in certain,
we'll need to tell the compiler backend
about exactly which atomic operation was used.
So I expect most of the functions of the form <code>atomic_&lt;op&gt;_explicit()</code>
(e.g. <code>atomic_load_explicit</code>, <code>atomic_exchange_explicit</code>,
<code>atomic_fetch_add_explicit</code>, etc.)
to become compiler builtins.
A builtin can tell whether its argument was volatile or not,
so those functions don't really need extra explicit overloads.
However, I don't expect that we'll want to add builtins
for every function in chapter 29,
since most can be implemented in terms of the <code>_explicit</code> free functions:
</p>

<pre><code>class atomic_int {
  __atomic_int_storage value;
 public:
  int fetch_add(int increment, memory_order order = memory_order_seq_cst) volatile {
    // &amp;value has type "volatile __atomic_int_storage*".
    atomic_fetch_add_explicit(&amp;value, increment, order);
  }
  ...
};
</code></pre>

<p>
But now this <em>always</em> calls
the volatile builtin version of <code>atomic_fetch_add_explicit()</code>,
even if the <code>atomic_int</code> wasn't declared volatile.
To preserve volatility and the compiler's permission to optimize,
I'd need to write:
</p>

<pre><code>class atomic_int {
  __atomic_int_storage value;
 public:
  int fetch_add(int increment, memory_order order = memory_order_seq_cst) volatile {
    atomic_fetch_add_explicit(&amp;value, increment, order);
  }
  int fetch_add(int increment, memory_order order = memory_order_seq_cst) {
    atomic_fetch_add_explicit(&amp;value, increment, order);
  }
  ...
};
</code></pre>

<p>
But this is visibly different from the declarations in the standard
because it's now overloaded.
(Consider passing <code>&amp;atomic_int::fetch_add</code> as a template parameter.)
</p>

<p>
The implementation may already have permission to add overloads
to the member functions:
</p>

<blockquote>
<p>
16.4.6.5 <a href="https://timsong-cpp.github.io/cppwp/member.functions">[member.functions]</a> An implementation may declare additional non-virtual
member function signatures within a class:<br/>
...
</p>
<ul>
<li>by adding a member function signature for a member function name.</li>
</ul>
</blockquote>

<p>
but I don't see an equivalent permission to add overloads to the free functions.
</p>

<p><i>[
2009-06-16 Lawrence adds:
]</i></p>


<blockquote>
<p>
I recommend allowing non-volatile overloads.
</p>
</blockquote>

<p><i>[
2009-10 Santa Cruz:
]</i></p>


<blockquote><p>
<del>NAD Editorial</del><ins>Resolved</ins>.  Addressed by
<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2009/n2992.htm">N2992</a>.
</p></blockquote>



<p id="res-1147"><b>Proposed resolution:</b></p>





</body>
</html>
