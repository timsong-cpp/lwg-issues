<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3409: Too lax description of atomic_ref&lt;T&gt;::required_alignment</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3409" href="lwg-active.html#3409">3409.</a> Too lax description of <tt>atomic_ref&lt;T&gt;::required_alignment</tt></h3>
<p><b>Section:</b> 31.7.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.ref.ops">[atomics.ref.ops]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Andrey Semashev <b>Opened:</b> 2020-02-27 <b>Last modified:</b> 2020-09-06 13:52:31 UTC</p>
<p><b>Priority: </b>3
</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
<a href="https://wg21.link/n4849">N4849</a> 31.7.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.ref.ops">[atomics.ref.ops]</a>/1 
describes <tt>atomic_ref&lt;T&gt;::required_alignment</tt> constant as follows:
</p>
<blockquote><p>
The alignment required for an object to be referenced by an atomic
reference, which is at least <tt>alignof(T)</tt>.
</p></blockquote>
<p>
This wording allows for an implementation to always define <tt>required_alignment</tt> 
to be equal to <tt>alignof(T)</tt> and implement atomic operations using locking, 
even if a lock-free implementation is possible at a higher alignment. For example, 
on x86-64, <tt>atomic_ref&lt;complex&lt;double&gt;&gt;</tt> could be lock-free 
only when the referred object is aligned to 16 bytes, but the above definition 
allows an implementation to define <tt>required_alignment</tt> to 8 and use locking.
<p/>
The note in 31.7.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.ref.ops">[atomics.ref.ops]</a>/2 does mention that lock-free operations
may require higher alignment, but it does not provide guidance to the implementations 
so that <tt>required_alignment</tt> reflects alignment required for lock-free 
operations, if possible, and not just minimum alignment required for any kind of 
implementation.
<p/>
The suggested resolution is to change the wording so that it is clear
that <tt>required_alignment</tt> indicates the alignment required for lock-free
implementation, if one is possible, or <tt>alignof(T)</tt> otherwise.
<p/>
Further, the note in 31.7.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.ref.ops">[atomics.ref.ops]</a>/2 contains this sentence:
</p>
<blockquote><p>
Further, whether operations on an <tt>atomic_ref</tt> are lock-free could
depend on the alignment of the referenced object.
</p></blockquote>
<p>
This sentence is misleading, because according to <tt>is_lock_free()</tt>
definition in 31.7.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.ref.ops">[atomics.ref.ops]</a>/4, the lock-free property is not 
allowed to depend on the alignment of a particular referenced object
(<tt>is_lock_free()</tt> must return <tt>true</tt> or <tt>false</tt> if 
operations on <em>all</em> objects of the given type <tt>T</tt> are lock-free or 
not). In other words, <tt>atomic_ref</tt> can only refer to an object aligned at 
least to <tt>required_alignment</tt> and its lock-free capability cannot depend 
on the actual runtime alignment of the object.
<p/>
To avoid the confusion, I propose to remove the sentence. The rest of
the note can stay intact. However, this second edit is less important
than the first one and can be omitted in case of disagreement.
</p>

<p><i>[2020-04-04 Issue Prioritization]</i></p>

<p>Priority to 3 after reflector discussion.</p>


<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/n4849">N4849</a>.
</p>

<ol>
<li><p>Modify 31.7.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.ref.ops">[atomics.ref.ops]</a> as indicated:</p>

<blockquote>
<pre>
static constexpr size_t required_alignment;
</pre>
<blockquote>
<p>
-1- <ins>Let <tt>A</tt> be t</ins><del>T</del>he alignment required for an object to be referenced by 
an atomic reference, <del>which is at least <tt>alignof(T)</tt></del><ins>so that 
<tt>is_always_lock_free</tt> is <tt>true</tt>. If there is no such alignment or <tt>A</tt> is less 
than <tt>alignof(T)</tt>, <tt>required_alignment</tt> equals <tt>alignof(T)</tt>. Otherwise, 
<tt>required_alignment</tt> equals <tt>A</tt></ins>.
<p/>
-2- [<i>Note:</i> Hardware could require an object referenced by an <tt>atomic_ref</tt> to have 
stricter alignment (6.7.6 <a href="https://timsong-cpp.github.io/cppwp/basic.align">[basic.align]</a>) than other objects of type <tt>T</tt>. <del>Further, 
whether operations on an <tt>atomic_ref</tt> are lock-free could depend on the alignment of the 
referenced object.</del> For example, lock-free operations on <tt>std::complex&lt;double&gt;</tt>
could be supported only if aligned to <tt>2*alignof(double)</tt>. &mdash; <i>end note</i>]
</p>
</blockquote>
</blockquote>
</li>
</ol>




</body>
</html>
