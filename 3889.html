<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3889: std::(ranges::)destroy_at should destroy array elements in the decreasing index order</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3889" href="lwg-active.html#3889">3889.</a> <tt>std::(ranges::)destroy_at</tt> should destroy array elements in the decreasing index order</h3>
<p><b>Section:</b> 27.11.9 <a href="https://timsong-cpp.github.io/cppwp/specialized.destroy">[specialized.destroy]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Jiang An <b>Opened:</b> 2023-02-17 <b>Last modified:</b> 2023-03-22 22:36:03 UTC</p>
<p><b>Priority: </b>3
</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Currently, <tt>std::(ranges::)destroy_at</tt> is specified to destroy array elements in the increasing index order 
(27.11.9 <a href="https://timsong-cpp.github.io/cppwp/specialized.destroy">[specialized.destroy]</a>/1.1), which is inconsistent with the decreasing order specified in the core language 
(11.4.7 <a href="https://timsong-cpp.github.io/cppwp/class.dtor">[class.dtor]</a>/13) and the order for arrays created by <tt>std::make_shared</tt> and 
<tt>std::allocate_shared</tt> (mandated by LWG <a href="3005">3005</a>).
</p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">

<p>
This wording is relative to <a href="https://wg21.link/N4928">N4928</a>.
</p>

<ol>

<li><p>Modify 27.11.9 <a href="https://timsong-cpp.github.io/cppwp/specialized.destroy">[specialized.destroy]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class T&gt;
  constexpr void destroy_at(T* location);

namespace ranges {
  template&lt;destructible T&gt;
    constexpr void destroy_at(T* location) noexcept;
}
</pre>
<blockquote>
<p>
-1- <i>Effects:</i>
</p>
<ol style="list-style-type: none">
<li><p>(1.1) &mdash; If <tt>T</tt> is an array type, equivalent to <tt>destroy(<ins>rbegin</ins><del>begin</del>(*location), <ins>rend</ins><del>end</del>(*location))</tt>.</p></li>
<li><p>(1.2) &mdash; Otherwise, equivalent to <tt>location-&gt;~T()</tt>.</p></li>
</ol>
</blockquote>
</blockquote>

</li>

</ol>
</blockquote>


<p><i>[2023-02-26; Daniel comments and provides alternative wording]</i></p>

<p>
The suggested fix indeed corrects an inconsistency, but also implies a silent behaviour change at runtime, since at least MSVC STL and
libstdc++ implement the array destruction order as specified (others not tested). 
The below wording therefore suggests to introduce a specific feature macro for this, so that user code can potentially react on this,
regardless of potential vendor API breakage hesitations. 
The natural feature macro to increase would be that which introduced the specific array destruction behavior of <tt>destroy_at</tt>, 
which was <a href="https://wg21.link/P0896R4">P0896R4</a>, and which introduced <tt>__cpp_lib_ranges</tt>, on the other hand the specification change affects 
both the <tt>std::ranges</tt> and the <tt>std</tt> forms of <tt>destroy_at</tt>, so it seems plausible to suggest a new, specific feature 
macro for both <tt>destroy_at</tt> function templates. This is what the proposed wording does.
<p/>
LWG should clarify whether an entry to C.1 <a href="https://timsong-cpp.github.io/cppwp/diff.cpp20">[diff.cpp20]</a> should be added as well.
</p>

<p><i>[2023-03-22; Reflector poll]</i></p>

<p>
Set priority to 3 after reflector poll.
</p>



<p id="res-3889"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N4928">N4928</a>.
</p>

<ol>

<li><p>Modify 17.3.2 <a href="https://timsong-cpp.github.io/cppwp/version.syn">[version.syn]</a>, header <tt>&lt;version&gt;</tt> synopsis, as indicated and replace
the placeholder <tt>YYYYMML</tt> by the year and month of adoption of this issue:</p>

<blockquote>
<pre>
[&hellip;]
#define __cpp_lib_coroutine         201902L  // <i>also in &lt;coroutine&gt;</i>
<ins>#define __cpp_lib_destroy_at        YYYYMML  // <i>also in &lt;memory&gt;</i></ins>
#define __cpp_lib_destroying_delete 201806L  // <i>also in &lt;new&gt;</i>
[&hellip;]
</pre>
</blockquote>

</li>



<li><p>Modify 27.11.9 <a href="https://timsong-cpp.github.io/cppwp/specialized.destroy">[specialized.destroy]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class T&gt;
  constexpr void destroy_at(T* location);

namespace ranges {
  template&lt;destructible T&gt;
    constexpr void destroy_at(T* location) noexcept;
}
</pre>
<blockquote>
<p>
-1- <i>Effects:</i>
</p>
<ol style="list-style-type: none">
<li><p>(1.1) &mdash; If <tt>T</tt> is an array type, equivalent to <tt>destroy(<ins>rbegin</ins><del>begin</del>(*location), <ins>rend</ins><del>end</del>(*location))</tt>.</p></li>
<li><p>(1.2) &mdash; Otherwise, equivalent to <tt>location-&gt;~T()</tt>.</p></li>
</ol>
</blockquote>
</blockquote>

</li>

</ol>





</body>
</html>
