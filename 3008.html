<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3008: make_shared (sub)object destruction semantics are not specified</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="3008" href="lwg-active.html#3008">3008.</a> <tt>make_shared</tt> (sub)object destruction semantics are not specified</h3>
<p><b>Section:</b> 19.11.3.6 <a href="https://timsong-cpp.github.io/cppwp/util.smartptr.shared.create">[util.smartptr.shared.create]</a> <b>Status:</b> <a href="lwg-active.html#Open">Open</a>
 <b>Submitter:</b> Glen Joseph Fernandes <b>Opened:</b> 2017-08-06 <b>Last modified:</b> 2018-08-20 12:41:52 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View all other</b> <a href="lwg-index.html#util.smartptr.shared.create">issues</a> in [util.smartptr.shared.create].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Open">Open</a> status.</p>
<p><b>Discussion:</b></p>
<p>
The remarks for the <tt>make_shared</tt> and <tt>allocate_shared</tt> functions 
do not specify how the objects managed by the returned <tt>shared_ptr</tt> are 
destroyed. It is implied that when objects are constructed via a placement new 
expression, they are destroyed by calling the destructor, and that when objects 
are constructed via an allocator, they are destroyed using that allocator. This 
should be explicitly specified.
</p>

<p><i>[2017-11 Albuquerque Wednesday night issues processing]</i></p>

<p>Priority set to 2</p>

<p><strong>Previous resolution [SUPERSEDED]:</strong></p>
<blockquote class="note">
<p>This resolution is relative to <a href="http://wg21.link/n4687">N4687</a>.</p>

<ol>
<li><p>Edit 19.11.3.6 <a href="https://timsong-cpp.github.io/cppwp/util.smartptr.shared.create">[util.smartptr.shared.create]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class T, ...&gt;
shared_ptr&lt;T&gt; make_shared(<i>args</i>);
template&lt;class T, class A, ...&gt;
shared_ptr&lt;T&gt; allocate_shared(const A&amp; a, <i>args</i>);
</pre>
<blockquote>
<p>
[&hellip;]
<p/>
-7- <i>Remarks:</i>
</p>
<ol style="list-style-type: none">
<li><p>[&hellip;]</p></li>
<li><p>(7.9) &mdash; When the lifetime of the object managed by the return value ends, or when the initialization of
an array element throws an exception, the initialized elements should be destroyed in the reverse
order of their construction.</p></li>
<li><p><ins>(7.?) &mdash; When a (sub)object of a non-array type <tt>U</tt> that was initialized by
<tt>make_shared</tt> is to be destroyed, it shall be destroyed via the expression <tt>pv-&gt;~U()</tt> 
where <tt>pv</tt> points to that object of type <tt>U</tt>.</ins></p></li>
<li><p><ins>(7.?) &mdash; When a (sub)object of a non-array type <tt>U</tt> that was initialized by
<tt>allocate_shared</tt> is to be destroyed, it shall be destroyed via the expression 
<tt>allocator_traits&lt;A2&gt;::destroy(a2, pv)</tt> where <tt>pv</tt> points to that object of type 
<i>cv</i>-unqualified <tt>U</tt> and <tt>a2</tt> of type <tt>A2</tt> is a rebound copy of the allocator
<tt>a</tt> passed to <tt>allocate_shared</tt> such that its <tt>value_type</tt> is 
<tt>remove_cv_t&lt;U&gt;</tt>.</ins></p></li>
</ol>
</blockquote>
</blockquote>
</li>

</ol></blockquote>

<p><i>[2018-06 Rapperswil Wednesday night issues processing]</i></p>

<p>
CC: what is "of type <i>cv</i>-unqualified <tt>U</tt>" and "<tt>remove_cv_T&lt;U&gt;</tt>" about?<br/>
DK: again, it isn't new wording; it is in p 7.5.2<br/>
JW: but none of the words use "of type <i>cv</i>-unqualified <tt>U</tt>"<br/>
CT: so we should also used <tt>remove_cv_T&lt;U&gt;</tt> instead?<br/>
JW: I would like to talk to Glen<br/>
FB: does anybody know how it works for an array of arrays? It seems to cover the case<br/>
JW: we could leave it vague as it is now or specify it to exactly what it does<br/>
DK: I think we should split the thing into two parts and start with definitions<br/>
DK: ACTION I can refactor the wording<br/>
MC: there was a fairly long message thread when we talked about this 
<p/>
Daniel comments and improves wording:
<p/>
The currently allocator requirements support only the construction of <i>cv</i>-unqualified
object types (See Table 30 type <tt>C</tt> and pointer variable <tt>c</tt> as well as
Table 31 expressions "<tt>a.construct(c, args)</tt>" and "<tt>a.destroy(c)</tt>"), therefore a 
conforming implementation needs to effectively construct an object pointer that holds an object of type 
<tt>remove_cv_T&lt;U&gt;</tt> and similarly destroy such an object. Albeit it seems to be an artificial 
restriction to construct and destroy only non-<i>cv</i>-qualified object types, this is, if any, 
a different issue. But given this current state, the wording for <tt>allocate_shared</tt> needs 
to make a special wording dance via <tt>remove_cv_T&lt;U&gt;</tt>.
For <tt>construct</tt> the existing wording prevents to speak about that detail by using the more indirect
phrase "where <tt>pv</tt> points to storage suitable to hold an object of type <tt>U</tt>", but since
object types <tt>U</tt> and <tt>const U</tt> have exactly the same storage and alignment requirements,
this sentence is correct for <tt>remove_cv_T&lt;U&gt;</tt> as well.
</p>


<p><b>Proposed resolution:</b></p>
<p>This resolution is relative to <a href="http://wg21.link/n4750">N4750</a>.</p>

<ol>
<li><p>Edit 19.11.3.6 <a href="https://timsong-cpp.github.io/cppwp/util.smartptr.shared.create">[util.smartptr.shared.create]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class T, ...&gt;
shared_ptr&lt;T&gt; make_shared(<i>args</i>);
template&lt;class T, class A, ...&gt;
shared_ptr&lt;T&gt; allocate_shared(const A&amp; a, <i>args</i>);
</pre>
<blockquote>
<p>
[&hellip;]
<p/>
-7- <i>Remarks:</i>
</p>
<ol style="list-style-type: none">
<li><p>[&hellip;]</p></li>
<li><p>(7.9) &mdash; When the lifetime of the object managed by the return value ends, or when the initialization of
an array element throws an exception, the initialized elements are destroyed in the reverse
order of their original construction.</p></li>
<li><p><ins>(7.?) &mdash; When a (sub)object of a non-array type <tt>U</tt> that was initialized by
<tt>make_shared</tt> is to be destroyed, it is destroyed via the expression <tt>pv-&gt;~U()</tt> 
where <tt>pv</tt> points to that object of type <tt>U</tt>.</ins></p></li>
<li><p><ins>(7.?) &mdash; When a (sub)object of a non-array type <tt>U</tt> that was initialized by
<tt>allocate_shared</tt> is to be destroyed, it is destroyed via the expression 
<tt>allocator_traits&lt;A2&gt;::destroy(a2, pv)</tt> where <tt>pv</tt> points to that object of type 
<tt>remove_cv_t&lt;U&gt;</tt> and <tt>a2</tt> of type <tt>A2</tt> is a rebound copy of the allocator
<tt>a</tt> passed to <tt>allocate_shared</tt> such that its <tt>value_type</tt> is 
<tt>remove_cv_t&lt;U&gt;</tt>.</ins></p></li>
</ol>
</blockquote>
</blockquote>
</li>

</ol>




</body>
</html>
