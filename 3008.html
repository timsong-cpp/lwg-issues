<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3008: make_shared (sub)object destruction semantics are not specified</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="3008" href="lwg-active.html#3008">3008.</a> <tt>make_shared</tt> (sub)object destruction semantics are not specified</h3>
<p><b>Section:</b> 23.11.2.2.6 <a href="https://timsong-cpp.github.io/cppwp/util.smartptr.shared.create">[util.smartptr.shared.create]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Glen Joseph Fernandes <b>Opened:</b> 2017-08-06 <b>Last modified:</b> 2017-08-06 17:51:16 UTC</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View other</b> <a href="lwg-index-open.html#util.smartptr.shared.create">active issues</a> in <a href="https://timsong-cpp.github.io/cppwp/util.smartptr.shared.create">[util.smartptr.shared.create]</a>.</p>
<p><b>View all other</b> <a href="lwg-index.html#util.smartptr.shared.create">issues</a> in <a href="https://timsong-cpp.github.io/cppwp/util.smartptr.shared.create">[util.smartptr.shared.create]</a>.</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
The remarks for the <tt>make_shared</tt> and <tt>allocate_shared</tt> functions 
do not specify how the objects managed by the returned <tt>shared_ptr</tt> are 
destroyed. It is implied that when objects are constructed via a placement new 
expression, they are destroyed by calling the destructor, and that when objects 
are constructed via an allocator, they are destroyed using that allocator. This 
should be explicitly specified.
</p>


<p><b>Proposed resolution:</b></p>
<p>This resolution is relative to <a href="http://wg21.link/n4687">N4687</a>.</p>

<ol>
<li><p>Edit 23.11.2.2.6 <a href="https://timsong-cpp.github.io/cppwp/util.smartptr.shared.create">[util.smartptr.shared.create]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class T, ...&gt;
shared_ptr&lt;T&gt; make_shared(<i>args</i>);
template&lt;class T, class A, ...&gt;
shared_ptr&lt;T&gt; allocate_shared(const A&amp; a, <i>args</i>);
</pre>
<blockquote>
<p>
[&hellip;]
<p/>
-7- <i>Remarks:</i>
</p>
<ol style="list-style-type: none">
<li><p>[&hellip;]</p></li>
<li><p>(7.9) &mdash; When the lifetime of the object managed by the return value ends, or when the initialization of
an array element throws an exception, the initialized elements should be destroyed in the reverse
order of their construction.</p></li>
<li><p><ins>(7.?) &mdash; When a (sub)object of a non-array type <tt>U</tt> is
to be destroyed, <tt>make_shared</tt> shall destroy this (sub)object via
the expression <tt>pv-&gt;~U()</tt> where <tt>pv</tt> points to an object
of type <tt>U</tt>.</ins></p></li>
<li><p><ins>(7.?) &mdash; When a (sub)object of a non-array type <tt>U</tt> is
to be destroyed, <tt>allocate_shared</tt> shall destroy this (sub)object
via the expression <tt>allocator_traits&lt;A2&gt;::destroy(a2, pv)</tt>
where <tt>pv</tt> points to an object of type <tt>U</tt> and
<tt>a2</tt> of type <tt>A2</tt> is a rebound copy of the allocator
<tt>a</tt> passed to <tt>allocate_shared</tt> such that its
<tt>value_type</tt> is <tt>remove_cv_t&lt;U&gt;</tt>.</ins></p></li>
</ol>
</blockquote>
</blockquote>
</li>

</ol>




</body>
</html>
