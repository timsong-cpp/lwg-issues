<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Issue 4188: ostream::sentry destructor should handle exceptions</title>
<meta property="og:title" content="Issue 4188: ostream::sentry destructor should handle exceptions">
<meta property="og:description" content="C++ library issue. Status: Tentatively Ready">
<meta property="og:url" content="https://timsong-cpp.github.io/lwg-issues/4188.html">
<meta property="og:type" content="website">
<meta property="og:image" content="http://cplusplus.github.io/LWG/images/cpp_logo.png">
<meta property="og:image:alt" content="C++ logo">
<style>
  p {text-align:justify}
  li {text-align:justify}
  pre code.backtick::before { content: "`" }
  pre code.backtick::after { content: "`" }
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table.issues-index { border: 1px solid; border-collapse: collapse; }
  table.issues-index th { text-align: center; padding: 4px; border: 1px solid; }
  table.issues-index td { padding: 4px; border: 1px solid; }
  table.issues-index td:nth-child(1) { text-align: right; }
  table.issues-index td:nth-child(2) { text-align: left; }
  table.issues-index td:nth-child(3) { text-align: left; }
  table.issues-index td:nth-child(4) { text-align: left; }
  table.issues-index td:nth-child(5) { text-align: center; }
  table.issues-index td:nth-child(6) { text-align: center; }
  table.issues-index td:nth-child(7) { text-align: left; }
  table.issues-index td:nth-child(5) span.no-pr { color: red; }
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3 id="4188"><a href="lwg-active.html#4188">4188</a>. <code>ostream::sentry</code> destructor should handle exceptions</h3>
<p><b>Section:</b> 31.7.6.2.4 <a href="https://timsong-cpp.github.io/cppwp/ostream.sentry">[ostream.sentry]</a> <b>Status:</b> <a href="lwg-active.html#Ready">Tentatively Ready</a>
 <b>Submitter:</b> Jonathan Wakely <b>Opened:</b> 2025-01-14 <b>Last modified:</b> 2025-02-07</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View other</b> <a href="lwg-index-open.html#ostream.sentry">active issues</a> in [ostream.sentry].</p>
<p><b>View all other</b> <a href="lwg-index.html#ostream.sentry">issues</a> in [ostream.sentry].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Tentatively Ready">Tentatively Ready</a> status.</p>
<p><b>Discussion:</b></p>
<p>
LWG <a href="397" title="ostream::sentry dtor throws exceptions (Status: NAD Editorial)">397</a> suggested changing 31.7.6.2.4 <a href="https://timsong-cpp.github.io/cppwp/ostream.sentry">[ostream.sentry]</a> to
say that the <code class='backtick'>ostream::sentry</code> destructor doesn't throw any exceptions.
That issue was closed as resolved by LWG <a href="835" title="Tying two streams together (correction to DR 581) (Status: C++11)">835</a> which included
the "Throws: Nothing" change to the <code class='backtick'>sentry</code> destructor.
However, that part of the resolution never seems to have been applied to
the working draft. <a href="https://wg21.link/N3091" title=" Editor's Report">N3091</a> mentions applying LWG 835 for
<a href="https://wg21.link/N3090" title=" Working Draft, Standard for Programming Language C++">N3090</a> but the destructor change is missing, maybe because
the paragraph for the sentry destructor had been renumbered from p17 to p4
and LWG 835 didn't show sufficient context to indicate the intended location.
</p>

<p>
The problem described in LWG <a href="397" title="ostream::sentry dtor throws exceptions (Status: NAD Editorial)">397</a> is still present:
the streambuf operations can fail, and the sentry needs to handle that.
The changes for LWG <a href="835" title="Tying two streams together (correction to DR 581) (Status: C++11)">835</a> ensure no exception is thrown if
<code>rdbuf()-&gt;pubsync()</code> returns -1 on failure, but do nothing for
the case where it throws an exception (the original topic of LWG 397!).
Because C++11 made <code class='backtick'>~sentry</code> implicitly <code class='backtick'>noexcept</code>,
an exception from <code class='backtick'>rdbuf()-&gt;pubsync()</code> will terminate the process.
That needs to be fixed.
</p>

<p>
Libstdc++ does terminate if <code class='backtick'>pubsync()</code> throws when called by <code class='backtick'>~sentry</code>.
Both MSVC and Libc++ silently swallow exceptions.
It seems preferable to handle the exception and report an error,
just as we do when <code class='backtick'>pubsync()</code> returns -1.
</p>


<p><i>[2025-02-07; Reflector poll]</i></p>

<p>
Set status to Tentatively Ready after six votes in favour during reflector poll.
</p>



<p id="res-4188"><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/N5001" title=" Working Draft, Programming Languages — C++">N5001</a>.
</p>

<ol>
<li><p>Modify 31.7.6.2.4 <a href="https://timsong-cpp.github.io/cppwp/ostream.sentry">[ostream.sentry]</a> as indicated:</p>

<blockquote>
<pre><code>~sentry();</code></pre>
<blockquote>
-4- If
<code>(os.flags() &amp; ios_base::unitbuf) &amp;&amp; !uncaught_exceptions() &amp;&amp; os.good()</code> is <code class='backtick'>true</code>, calls <code>os.rdbuf()-&gt;pubsync()</code>.
If that function returns −1
<ins> or exits via an exception</ins>,
sets <code class='backtick'>badbit</code> in <code class='backtick'>os.rdstate()</code> without propagating an exception.
</blockquote>
</blockquote>
</li>
</ol>






</body>
</html>
