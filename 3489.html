<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3489: Improve istream_view wording</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3489" href="lwg-active.html#3489">3489.</a> Improve <tt>istream_view</tt> wording</h3>
<p><b>Section:</b> 26.6.6.3 <a href="https://timsong-cpp.github.io/cppwp/range.istream.iterator">[range.istream.iterator]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Michael Schellenberger Costa <b>Opened:</b> 2020-10-09 <b>Last modified:</b> 2021-09-02 14:25:32 UTC</p>
<p><b>Priority: </b>3
</p>
<p><b>View all other</b> <a href="lwg-index.html#range.istream.iterator">issues</a> in [range.istream.iterator].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
While implementing <tt>iranges::stream_view</tt> we found some issues with the <i>Preconditions</i> 
on the member functions of <tt>istream_view::iterator</tt>, which are superfluous or incorrect.
</p>

<ol>
<li>
<p>
26.6.6.3 <a href="https://timsong-cpp.github.io/cppwp/range.istream.iterator">[range.istream.iterator]</a> p2 reads as:
</p>
<blockquote><p>
<i>Preconditions:</i> <tt><i>parent_</i>-&gt;<i>stream_</i> != nullptr</tt> is <tt>true</tt>.
</p></blockquote>
<p>
However in the <i>Effects</i> element 26.6.6.3 <a href="https://timsong-cpp.github.io/cppwp/range.istream.iterator">[range.istream.iterator]</a> p3 it reads:
</p>
<blockquote>
<p>
<i>Effects:</i> Equivalent to:
</p>
<blockquote><pre>
*<i>parent_</i>-&gt;<i>stream_</i> &gt;&gt; <i>parent_</i>-&gt;<i>object_</i>;
return *this;
</pre></blockquote>
</blockquote>
<p>
For the <i>Effects</i> element to be valid, we implicitly require that <tt><i>parent_</i> != nullptr</tt>, 
<tt><i>parent_</i>-&gt;<i>stream_</i> != nullptr</tt> and &mdash; because we are reading from the underlying 
stream &mdash; <tt>!*x.<i>parent_</i>-&gt;<i>stream_</i></tt>.
<p/>
Given that the <i>Preconditions</i> element only mentions one of the three preconditions and essentially 
means that we are not at the end of the stream, we should replace 26.6.6.3 <a href="https://timsong-cpp.github.io/cppwp/range.istream.iterator">[range.istream.iterator]</a> p2 
by:
</p>
<blockquote><p>
<i>Preconditions:</i> <tt>*this != default_sentinel</tt>.
</p></blockquote>
</li>
<li>
<p>
We should use the same precondition for 26.6.6.3 <a href="https://timsong-cpp.github.io/cppwp/range.istream.iterator">[range.istream.iterator]</a> p4, even if it is implicit 
via the <i>Effects</i> element in 26.6.6.3 <a href="https://timsong-cpp.github.io/cppwp/range.istream.iterator">[range.istream.iterator]</a> p5, as that requires experts knowledge 
of the standard.
</p>
</li>
<li>
<p>
The Precondition in 26.6.6.3 <a href="https://timsong-cpp.github.io/cppwp/range.istream.iterator">[range.istream.iterator]</a> p6 is completely bogus, as accessing the 
cached object has no dependency on the stream. We assume it is meant that we are not at the end of the stream. 
Again we should change this to:
</p>
<blockquote><p>
<i>Preconditions:</i> <tt>*this != default_sentinel</tt>.
</p></blockquote>
</li>
</ol>

<p><i>[2020-10-14; Priority to P3 after reflector discusssion]</i></p>


<p><i>[2021-09-02; Jonathan comments:]</i></p>

<p>
The preconditions were removed by <a href="https://wg21.link/P2325R3">P2325R3</a> approved in June 2021.
Although the pointers now cannot be null, it's unclear if we want to require
<code>fail()</code> to be false for the stream.
</p>



<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/n4861">N4861</a>. 
</p>

<ol>
<li>
<p>
Modify 26.6.6.3 <a href="https://timsong-cpp.github.io/cppwp/range.istream.iterator">[range.istream.iterator]</a> as indicated:
</p>
<blockquote>
<pre>
<i>iterator</i>&amp; operator++();
</pre>
<blockquote>
<p>
-2- <i>Preconditions:</i> <tt><del><i>parent_</i>-&gt;<i>stream_</i> != nullptr</del><ins>*this != default_sentinel</ins></tt> 
is <tt>true</tt>.
<p/>
-3- <i>Effects:</i> Equivalent to:
</p>
<blockquote><pre>
*<i>parent_</i>-&gt;<i>stream_</i> &gt;&gt; <i>parent_</i>-&gt;<i>object_</i>;
return *this;
</pre></blockquote>
</blockquote>
<pre>
void operator++(int);
</pre>
<blockquote>
<p>
-4- <i>Preconditions:</i> <tt><del><i>parent_</i>-&gt;<i>stream_</i> != nullptr</del><ins>*this != default_sentinel</ins></tt> 
is <tt>true</tt>.
<p/>
-5- <i>Effects:</i> Equivalent to <tt>++*this</tt>.
</p>
</blockquote>
<pre>
Val&amp; operator*() const;
</pre>
<blockquote>
<p>
-6- <i>Preconditions:</i> <tt><del><i>parent_</i>-&gt;<i>stream_</i> != nullptr</del><ins>*this != default_sentinel</ins></tt> 
is <tt>true</tt>.
<p/>
-7- <i>Effects:</i> Equivalent to: <tt>return <i>parent_</i>-&gt;<i>object_</i>;</tt>
</p>
</blockquote>
<pre>
friend bool operator==(const <i>iterator</i>&amp; x, default_sentinel_t);
</pre>
<blockquote>
<p>
-8- <i>Effects:</i> Equivalent to: <tt>return x.<i>parent_</i> == nullptr || !*x.<i>parent_</i>-&gt;<i>stream_</i>;</tt>
</p>
</blockquote>
</blockquote>
</li>
</ol>





</body>
</html>
