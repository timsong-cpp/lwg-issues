<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3057: Correct copy_options handling</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="3057" href="lwg-active.html#3057">3057.</a> Correct <tt>copy_options</tt> handling</h3>
<p><b>Section:</b> 29.11.13.4 <a href="https://timsong-cpp.github.io/cppwp/fs.op.copy">[fs.op.copy]</a> <b>Status:</b> <a href="lwg-active.html#Open">Open</a>
 <b>Submitter:</b> Davis Herring <b>Opened:</b> 2018-01-29 <b>Last modified:</b> 2020-09-06 13:52:31 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View all other</b> <a href="lwg-index.html#fs.op.copy">issues</a> in [fs.op.copy].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Open">Open</a> status.</p>
<p><b>Discussion:</b></p>
<p>
(The resolution of #3 resolves part of <a href="https://wg21.link/p0488r0#page=10">C++17 NB comment US 36</a>.) 
<p/>
The handling of several options for <tt>filesystem::copy()</tt> is wrong:
</p>
<ol>
<li><p>Single-level directory copying is silently suppressed by any flag other than 
<tt>copy_options::recursive</tt> (even <tt>copy_options::directories_only</tt>). Single-level 
directory copying operates via using some unspecified flag to trigger this misfeature.</p></li>
<li><p><tt>copy_options::create_symlinks</tt> and <tt>copy_options::skip_symlinks</tt> affect 
the interpretation of the destination name; the latter shouldn't ever, and the former should 
affect only broken symlinks (since it would want to replace them).</p></li>
<li><p>The <tt>copy_options</tt> groups for existing target files and the form of copying are 
consulted only for creating regular files.</p></li>
<li><p><tt>copy("file", "dir")</tt> creates dir/file, but <tt>copy("symlink", "dir", 
copy_options::copy_symlinks)</tt> fails.</p></li>
<li><p>If a symlink is encountered with <tt>copy_options::copy_symlinks</tt> and 
<tt>copy_options::create_symlinks</tt>, the latter flag is ignored (but its otherwise sensible 
restriction to absolute paths applies) rather than the former.</p></li>
<li><p><tt>copy_options::create_symlinks</tt> without <tt>copy_options::copy_symlinks</tt> 
fails if it encounters a symlink. (This is particularly damaging for recursive operation.)</p></li>
</ol>
<p>
This issue, since it replaces so much text, also addresses two error-handling concerns in passing:
</p>
<ol>
<li><p>The significance of <tt>equivalent(from, to)</tt> failing is unspecified. (Ignoring such 
failures entirely would make dangerous those operations that replace the target with a link.)</p></li>
<li><p>Copying a directory involves several operations. When an <tt>error_code</tt> is being used, 
the process continues past errors and (because successful functions call <tt>ec.clear()</tt>) 
may suppress them.</p></li>
</ol>
<p>
This expands on the resolution for LWG <a href="2681">2681</a>.
<p/>
This also addresses the same issue as LWG <a href="2682">2682</a>, but has a different result 
(based on the fact that the Example successfully copies directories to new, non-existent names).
</p>

<p><i>[2018-06; Rapperswil Wednesday evening, discussing LWG <a href="2682">2682</a>]</i></p>

<p>
JW: can we use the words we are shipping already since two years?<br/>
BO: what we got is better than what we had before<br/>
no objection to moving to Ready<br/>
ACTION move to Ready<br/>
ACTION link LWG <a href="2682">2682</a> and LWG 3057 and set a priority 2 and look at 3057 in San Diego 
</p>

<p><i>[2018-11 San Diego Thursday night issue processing]</i></p>

<p>Need to gather implementation experience; revisit in Kona. Status to Open.</p>

<p><i>[2018-11-13; Billy O'Neal comments]</i></p>

<p>
I (Billy O'Neal) prefer Davis' solution to LWG 3057, as I think the wording follows the meaning of the individual 
enum values more closely, and enables more scenarios to function correctly instead of reporting such cases as errors.
<p/>
However, I don't want to adopt that wording as is because it requires my implementation to detect errors in places 
that force us to do a bunch of extra system calls, and I don't believe those specific ways error handling happens 
is relevant to what the copy API wants to do.
<p/>
Ideally, the wording would be structured such that it said "here's a list of error conditions, if they happen we 
aren't going to tell you when exactly they are detected" and then listed the behavior irrespective of when errors 
happen. That way implementations can do the error checks when it makes sense according to what their system APIs 
report. For example, anything that requires symlink resolution is very expensive on my platform so I'd want to 
be able to defer anything related to status (rather than <tt>symlink_status</tt>) to after I've detected that 
there's actually a symlink (or junction) involved.
</p>


<p><b>Proposed resolution:</b></p>
<p>This wording is relative to <a href="https://wg21.link/n4750">N4750</a>.</p>

<ol>
<li><p>Modify Table 115 &mdash; "Enum class <tt>copy_options</tt>" as indicated:</p>

<blockquote>
 <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse">
  <tr>
    <th colspan="2">Option group controlling <ins><tt>copy</tt> and</ins> <tt>copy_file</tt> 
    function effects for existing target files</th>
  </tr>
    <tr>
      <td><b>Constant</b></td>
      <td><b>Meaning</b></td>
    </tr>
    <tr>
      <td>[&hellip;]</td>
      <td>[&hellip;]</td>
    </tr>
  </table>
</blockquote>

</li>

<li><p>Modify 29.11.13.4 <a href="https://timsong-cpp.github.io/cppwp/fs.op.copy">[fs.op.copy]</a> as indicated:</p>

<blockquote class="note">
<p>
<b>Rationale:</b>
<p/>
POSIX.1-2008 allows the implementation to create hard links "to" symbolic links, and provides 
<tt>linkat()</tt> to choose between the symlink and its target.
<p/>
29.11.13.4 <a href="https://timsong-cpp.github.io/cppwp/fs.op.copy">[fs.op.copy]</a>/4.9 is redundant given 29.11.5 <a href="https://timsong-cpp.github.io/cppwp/fs.err.report">[fs.err.report]</a>/3.1.
</p>
</blockquote>

<blockquote>
<pre>
void copy(const path&amp; from, const path&amp; to, copy_options options);
void copy(const path&amp; from, const path&amp; to, copy_options options,
          error_code&amp; ec) noexcept;
</pre>
<blockquote>
<p>
-3- <i>Requires:</i> At most one element from each option group (29.11.8.3 <a href="https://timsong-cpp.github.io/cppwp/fs.enum.copy.opts">[fs.enum.copy.opts]</a>) 
is set in <tt>options</tt>.
<p/>
-4- <i>Effects:</i> <del>Before the first use of <tt>f</tt> and <tt>t</tt>:</del>
<ol style="list-style-type: none">
<li><p><del>(4.1) &mdash; If [&hellip;]</del></p></li>
<li><p><del>[&hellip;]</del></p></li>
<li><p><del>(4.10) &mdash; Otherwise, no effects.</del></p></li>
</ol>
<ins>If each is needed below,</ins>
<blockquote><pre>
<ins>auto linkf = (options &amp; (copy_options::copy_symlinks |
                         copy_options::skip_symlinks)) != copy_options::none;
auto f = linkf ? symlink_status(from) : status(from), t = status(to);
auto to2 = !is_directory(f) &amp;&amp; is_directory(t) ? to/from.filename() : to.
bool linkt = (options &amp; (copy_options::create_symlinks |
                         copy_options::create_hard_links)) != copy_options::none ||
            is_symlink(f);
auto t2 = linkt ? symlink_status(to2) : status(to2);</ins>
</pre></blockquote>

<blockquote class="note">
<p>
[<i>Drafting note:</i> <tt>copy_options::create_symlinks</tt> is intentionally omitted for linkf; 
it may simply have been a typo for <tt>copy_options::copy_symlinks</tt> (which was added by LWG 
<a href="2681">2681</a>) since at least <a href="https://wg21.link/n3940">N3940</a>.]
</p>
</blockquote>

<ins>Effects are then as follows:</ins>
<ol style="list-style-type: none">
<li><p><ins>(?.?) &mdash; If <tt>f.type()</tt> or <tt>t.type()</tt> is an implementation-defined 
file type 99 [fs.enum.file_type], then the effects are implementation-defined.</ins></p>
<blockquote class="note">
<p>
[<i>Drafting note:</i> the text between the previous drafting note and this one is the only unchanged 
text under /4.]
</p>
</blockquote>
</li>
<li><p><ins>(?.?) &mdash; Otherwise, if <tt>exists(f)</tt> is <tt>false</tt>, report an error as 
specified in 29.11.5 <a href="https://timsong-cpp.github.io/cppwp/fs.err.report">[fs.err.report]</a>.</ins></p></li>
<li><p><ins>(?.?) &mdash; Otherwise, do nothing if</ins></p>
<ol style="list-style-type: none">
<li><p><ins>(?.?.?) &mdash; <tt>(options &amp; copy_options::directories_only) != copy_options::none</tt> 
and <tt>is_directory(f)</tt> is <tt>false</tt>, or</ins></p></li>
<li><p><ins>(?.?.?) &mdash; <tt>(options &amp; copy_options::skip_symlinks) != copy_options::none</tt> 
and <tt>is_symlink(f)</tt> is <tt>true</tt>, or</ins></p></li>
<li><p><ins>(?.?.?) &mdash; <tt>(options &amp; copy_options::skip_existing) != copy_options::none</tt> 
and <tt>exists(t2)</tt> is <tt>true</tt>.</ins></p></li>
</ol>
</li>
<li><p><ins>(?.?) &mdash; Otherwise, report an error as specified in 29.11.5 <a href="https://timsong-cpp.github.io/cppwp/fs.err.report">[fs.err.report]</a> 
if:</ins></p>
<ol style="list-style-type: none">
<li><p><ins>(?.?.?) &mdash; <tt>is_other(f) || is_other(t2)</tt> is <tt>true</tt>, or</ins></p></li>
<li><p><ins>(?.?.?) &mdash; <tt>exists(t2) &amp;&amp; exists(from) == exists(to2) &amp;&amp; 
equivalent(from, to)</tt> is <tt>true</tt>.</ins></p></li>
</ol>
</li>
<li><p><ins>(?.?) &mdash; Otherwise, if <tt>is_directory(f)</tt> is <tt>true</tt>, then:</ins></p>
<ol style="list-style-type: none">
<li><p><ins>(?.?.?) &mdash; <tt>create_directory(to, from)</tt>.</ins></p></li>
<li><p><ins>(?.?.?) &mdash; If <tt>(options &amp; copy_options::recursive) != copy_options::none</tt> 
or if <tt>(options &amp; copy_options::directories_only) == copy_options::none</tt>, iterate over 
the files in <tt>from</tt>, as if by</ins></p>
<blockquote><pre>
<ins>for (const directory_entry&amp; x : directory_iterator(from))
  if ((options &amp; copy_options::recursive) != copy_options::none ||
     !is_directory(linkf ? symlink_status(x.path()) : status(x.path())))
       copy(x.path(), to/x.path().filename(), options);</ins>
</pre></blockquote>
</li>
</ol>
</li>
<li><p><ins>(?.?) &mdash; Otherwise, do nothing if <tt>(options &amp; copy_options::update_existing) 
!= copy_options::none, exists(to2)</tt> is <tt>true</tt>, and <tt>from</tt> is not more recent than 
<tt>to2</tt>, determined as if by use of the <tt>last_write_time</tt> function 
( [fs.op.last_write_time]).</ins></p></li>
<li><p><ins>(?.?) &mdash; Otherwise, report an error as specified in 29.11.5 <a href="https://timsong-cpp.github.io/cppwp/fs.err.report">[fs.err.report]</a> 
if:</ins></p>
<ol style="list-style-type: none">
<li><p><ins>(?.?.?) &mdash; <tt>is_directory(t2)</tt> is <tt>true</tt>, or</ins></p></li>
<li><p><ins>(?.?.?) &mdash; <tt>(options &amp; (copy_options::overwrite_existing |
copy_options::update_existing)) == copy_options::none</tt> and <tt>exists(t2)</tt> is <tt>true</tt>.</ins></p></li>
</ol>
</li>
<li><p><ins>(?.?) &mdash; Otherwise, if <tt>linkt</tt> is <tt>true</tt>, then:</ins></p>
<ol style="list-style-type: none">
<li><p><ins>(?.?.?) &mdash; <tt>remove(to2)</tt> if an existing <tt>to2</tt> would prevent the 
following link creation.</ins></p></li>
<li><p><ins>(?.?.?) &mdash; If <tt>(options &amp; copy_options::create_symlinks) 
!= copy_options::none</tt>, <tt>create_symlink(from, to2)</tt>. [<i>Note:</i> If <tt>from</tt> 
is a symbolic link, it is not followed. &mdash; <i>end note</i>]</ins></p></li>
<li><p><ins>(?.?.?) &mdash; Otherwise, if <tt>(options &amp; copy_options::create_hard_links) 
!= copy_options::none</tt>, then create a hard link to <tt>from</tt>, if <tt>linkf</tt> is <tt>true</tt>, 
or else to the file that <tt>from</tt> resolves to. [<i>Note:</i> Not all file systems that support 
hard links and symbolic links support creating hard links to symbolic links. &mdash; <i>end note</i>]</ins></p></li>
<li><p><ins>(?.?.?) &mdash; Otherwise, <tt>copy_symlink(from, to2)</tt>.</ins></p></li>
</ol>
</li>
<li><p><ins>(?.?) &mdash; Otherwise, <tt>copy_file(from, to2, options)</tt>.</ins></p></li>
</ol>
<p/>
-5- <i>Throws:</i> As specified in 29.11.5 <a href="https://timsong-cpp.github.io/cppwp/fs.err.report">[fs.err.report]</a>.
<p/>
-6- <i>Remarks:</i> For the signature with argument <tt>ec</tt>, any library functions called by the 
implementation shall have an <tt>error_code</tt> argument if applicable. <ins>If any such function fails, 
<tt>copy</tt> returns immediately without (further) modifying <tt>ec</tt>.</ins>
</p>
</blockquote>
</blockquote>
</li>
</ol>





</body>
</html>
