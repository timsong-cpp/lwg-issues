<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3415: back_insert_iterator fails when a container is also its value type</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="3415" href="lwg-closed.html#3415">3415.</a> <tt>back_insert_iterator</tt> fails when a container is also its value type</h3>
<p><b>Section:</b> 23.5.2.2 <a href="https://timsong-cpp.github.io/cppwp/back.insert.iterator">[back.insert.iterator]</a> <b>Status:</b> <a href="lwg-active.html#NAD">NAD</a>
 <b>Submitter:</b> Billy O'Neal III <b>Opened:</b> 2020-03-03 <b>Last modified:</b> 2020-07-17 22:37:26 UTC</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#back.insert.iterator">issues</a> in [back.insert.iterator].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#NAD">NAD</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Consider the following:
</p>
<blockquote><pre>
#include &lt;algorithm&gt;
#include &lt;iterator&gt;
#include &lt;vector&gt;

struct example_container 
{
  using value_type = std::back_insert_iterator&lt;example_container&gt;;
  void push_back(const value_type&amp;) {}
};

int main() 
{
  std::vector&lt;std::back_insert_iterator&lt;example_container&gt;&gt; v;
  example_container ex;
  std::copy(v.begin(), v.end(), std::back_inserter(ex));
}
</pre></blockquote>
<p>
This example is out-of-contract in the current standard because it creates 
<tt>back_insert_iterator&lt;<em>incomplete</em>&gt;</tt>, as per 16.4.5.8 <a href="https://timsong-cpp.github.io/cppwp/res.on.functions">[res.on.functions]</a>/2. 
However, it might be something we are considering for future iterators and proxy reference types. 
In practice, the "Ill-formed, no diagnostic required" the user is likely to get is an ambiguity between 
what <tt>back_insert_iterator</tt>'s copy assignment operator, and its "push back assigning operator". 
We could resolve this by changing the return type of <tt>operator*</tt> to a proxy in the same way 
<tt>istream_iterator</tt> does, though that might be ABI breaking for some implementations.
<p/>
We should consider having a standing LWG/LEWG policy that iterators are not their own proxy 
<tt>operator*</tt> type if we intend to leave the door open to more incomplete type support in 
the standard library.
</p>

<p><i>[2020-07-17; Status changed to NAD in telecon]</i></p>

<p>
We reviewed the reflector discussion and were not motivated to support this.
There were concerns that adding incomplete type support elsewhere in containers
has caused us regrettable problems, and we're not sure we could get this right
even if we wanted to support it.
</p>


<p><b>Proposed resolution:</b></p>




</body>
</html>
