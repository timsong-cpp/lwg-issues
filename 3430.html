<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3430: std::fstream &amp; co. should be constructible from string_view</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3430" href="lwg-defects.html#3430">3430.</a> <tt>std::fstream</tt> &amp; co. should be constructible from <tt>string_view</tt></h3>
<p><b>Section:</b> 29.10.1 <a href="https://timsong-cpp.github.io/cppwp/fstream.syn">[fstream.syn]</a> <b>Status:</b> <a href="lwg-active.html#WP">WP</a>
 <b>Submitter:</b> Jonathan Wakely <b>Opened:</b> 2020-04-15 <b>Last modified:</b> 2021-06-07 16:58:04 UTC</p>
<p><b>Priority: </b>3
</p>
<p><b>View all issues with</b> <a href="lwg-status.html#WP">WP</a> status.</p>
<p><b>Discussion:</b></p>
<p>
We have:
</p>
<blockquote><pre>
basic_fstream(const char*, openmode);
basic_fstream(const filesystem::path::value_type*, openmode); // wide systems only
basic_fstream(const string&amp;, openmode);
basic_fstream(const filesystem::path&amp;, openmode);
</pre></blockquote>
<p>
I think the omission of a <tt>string_view</tt> overload was intentional, because the underlying OS call 
(such as <tt>fopen</tt>) needs a NTBS. We wanted the allocation required to turn a <tt>string_view</tt> 
into an NTBS to be explicitly requested by the user. But then we added the <tt>path</tt> overload, 
which is callable with a <tt>string_view</tt>. Converting to a <tt>path</tt> is more expensive than 
converting to <tt>std::string</tt>, because a path has to <em>at least</em> construct a <tt>basic_string</tt>, 
and potentially also does an encoding conversion, parses the path, and potentially allocates a sequence 
of <tt>path</tt> objects for the path components.
<p/>
This means the simpler, more obvious code is slower and uses more memory:
</p>
<blockquote><pre>
string_view sv = "foo.txt";
fstream f1(sv); // bad
fstream f2(string(sv)); // good
</pre></blockquote>
<p>
We should just allow passing a <tt>string_view</tt> directly, since it already compiles but 
doesn't do what anybody expects or wants.
<p/>
Even with a <tt>string_view</tt> overload, passing types like <tt>const char16_t*</tt> or <tt>u32string_view</tt> 
will still implicitly convert to <tt>filesystem::path</tt>, but that seems reasonable. In those cases the 
encoding conversion is necessary. For Windows we support construction from <tt>const wchar_t*</tt> but not 
from <tt>wstring</tt> or <tt>wstring_view</tt>, which means those types will convert to <tt>filesystem::path</tt>. 
That seems suboptimal, so we might also want to add <tt>wstring</tt> and <tt>wstring_view</tt> overloads for 
"wide systems only", as per 29.10.1 <a href="https://timsong-cpp.github.io/cppwp/fstream.syn">[fstream.syn]</a> p3.
<p/>
Daniel:
<p/>
LWG <a href="2883">2883</a> has a more general view on that but does not consider potential cost differences 
in the presence of <tt>path</tt> overloads (Which didn't exist at this point yet).
</p>

<p><i>[2020-05-09; Reflector prioritization]</i></p>

<p>
Set priority to 3 after reflector discussions.
</p>

<p><i>[2020-08-10; Jonathan comments]</i></p>

<p>
An alternative fix would be to retain the original design and not allow
construction from a <tt>string_view</tt>. The <tt>path</tt> parameters
could be changed to template parameters which are constrained to be exactly
<tt>path</tt>, and not things like <tt>string_view</tt> which can convert
to <tt>path</tt>.
</p>

<p><i>[2020-08-21; Issue processing telecon: send to LEWG]</i></p>

<p>
Just adding support for <tt>string_view</tt> doesn't prevent expensive
conversions from other types that convert to <tt>path</tt>.
Preference for avoiding all expensive implicit conversions to <tt>path</tt>,
maybe via abbreviated function templates:
<pre>
basic_fstream(same_as&lt;filesystem::path&gt; auto const&amp;, openmode);
</pre>
</p>
<p>
It's possible <tt>path_view</tt> will provide a better option at some point.
</p>
<p>
It was noted that <a href="2676">2676</a> did intentionally allow conversions
from "strings of character types <code>wchar_t</code>, <code>char16_t</code>,
and <code>char32_t</code>". Those conversions don't need to be implicit
for that to be supported.
</p>

<p><i>[2020-09-11; Tomasz comments and provides wording]</i></p>

<p>
During the <a href="https://wiki.edg.com/bin/view/Wg21summer2020/LWG3430">LEWG 2020-08-24 telecon</a> 
the LEWG provided following guidance on the issue:
</p>
<blockquote style="border-left: 3px solid #ccc;padding-left: 15px;">
<p>
We took one poll (exact wording in the notes) to constrain the constructor which takes 
<tt>filesystem::path</tt> to only take <tt>filesystem::path</tt> and not things convertible to it, 
but only 9 out of 26 people present actually voted. Our interpretation: LWG should go ahead with 
making this change. There is still plenty of time for someone who hasn't yet commented on this to 
bring it up even if it is in a tentatively ready state. It would be nice to see a paper to address 
the problem of the templated path constructor, but no one has yet volunteered to do so. 
Note: the issue description is now a misnomer, as adding a <tt>string_view</tt> constructor 
is no longer being considered at this time.
</p>
</blockquote>
<p>
The proposed P/R  follows original LWG proposal and makes the <tt>path</tt> constructor of the 
<tt>basic_*fstreams</tt> "<tt>explicit</tt>". To adhere to current policy, we refrain from use of 
requires clauses and abbreviated function syntax, and introduce a <i>Constraints</i> element.
</p>

<p><i>[2021-05-21; Reflector poll]</i></p>

<p>
Set status to Tentatively Ready after seven votes in favour during reflector poll.
</p>

<p><i>[2021-06-07 Approved at June 2021 virtual plenary. Status changed: Voting &rarr; WP.]</i></p>



<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/n4861">N4861</a>.
</p>

<ol>
<li><p>Modify 29.10.3 <a href="https://timsong-cpp.github.io/cppwp/ifstream">[ifstream]</a>, class template <tt>basic_ifstream</tt> synopsis, as indicated:</p>

<blockquote>
<pre>
[&hellip;]
explicit basic_ifstream(const string&amp; s,
                        ios_base::openmode mode = ios_base::in);
<ins>template&lt;class T&gt;</ins>
explicit basic_ifstream(const <del>filesystem::path</del><ins>T</ins>&amp; s,
                        ios_base::openmode mode = ios_base::in);
[&hellip;]
</pre>
</blockquote>
</li>

<li><p>Modify 29.10.3.2 <a href="https://timsong-cpp.github.io/cppwp/ifstream.cons">[ifstream.cons]</a> as indicated:</p>

<blockquote>
<pre>
explicit basic_ifstream(const string&amp; s,
                        ios_base::openmode mode = ios_base::in);
</pre>
<blockquote>
<p>
<ins>-?- <i>Effects:</i> Equivalent to: <tt>basic_ifstream(s.c_str(), mode)</tt>.</ins>
</p>
</blockquote>
<pre>
<ins>template&lt;class T&gt;</ins>
explicit basic_ifstream(const <del>filesystem::path</del><ins>T</ins>&amp; s,
                        ios_base::openmode mode = ios_base::in);
</pre>
<blockquote>
<p>
<ins>-?- <i>Constraints:</i> <tt>is_same_v&lt;T, filesystem::path&gt;</tt> is <tt>true</tt>.</ins>
<p/>
-3- <i>Effects:</i> Equivalent to: <tt>basic_ifstream(s.c_str(), mode)</tt>.
</p>
</blockquote>
</blockquote>
</li>

<li><p>Modify 29.10.4 <a href="https://timsong-cpp.github.io/cppwp/ofstream">[ofstream]</a>, class template <tt>basic_ofstream</tt> synopsis, as indicated:</p>

<blockquote>
<pre>
[&hellip;]
explicit basic_ofstream(const string&amp; s,
                        ios_base::openmode mode = ios_base::out);
<ins>template&lt;class T&gt;</ins>
explicit basic_ofstream(const <del>filesystem::path</del><ins>T</ins>&amp; s,
                        ios_base::openmode mode = ios_base::out);
[&hellip;]
</pre>
</blockquote>
</li>

<li><p>Modify 29.10.4.2 <a href="https://timsong-cpp.github.io/cppwp/ofstream.cons">[ofstream.cons]</a> as indicated:</p>

<blockquote>
<pre>
explicit basic_ofstream(const string&amp; s,
                        ios_base::openmode mode = ios_base::out);
</pre>
<blockquote>
<p>
<ins>-?- <i>Effects:</i> Equivalent to: <tt>basic_ofstream(s.c_str(), mode)</tt>.</ins>
</p>
</blockquote>
<pre>
<ins>template&lt;class T&gt;</ins>
explicit basic_ofstream(const <del>filesystem::path</del><ins>T</ins>&amp; s,
                        ios_base::openmode mode = ios_base::out);
</pre>
<blockquote>
<p>
<ins>-?- <i>Constraints:</i> <tt>is_same_v&lt;T, filesystem::path&gt;</tt> is <tt>true</tt>.</ins>
<p/>
-3- <i>Effects:</i> Equivalent to: <tt>basic_ofstream(s.c_str(), mode)</tt>.
</p>
</blockquote>
</blockquote>
</li>

<li><p>Modify 29.10.5 <a href="https://timsong-cpp.github.io/cppwp/fstream">[fstream]</a>, class template <tt>basic_fstream</tt> synopsis, as indicated:</p>

<blockquote>
<pre>
[&hellip;]
explicit basic_fstream(
  const string&amp; s,
  ios_base::openmode mode = ios_base::in | ios_base::out);
<ins>template&lt;class T&gt;</ins>
explicit basic_fstream(
  const <del>filesystem::path</del><ins>T</ins>&amp; s,
  ios_base::openmode mode = ios_base::in | ios_base::out);
[&hellip;]
</pre>
</blockquote>
</li>

<li><p>Modify 29.10.5.2 <a href="https://timsong-cpp.github.io/cppwp/fstream.cons">[fstream.cons]</a> as indicated:</p>

<blockquote>
<pre>
explicit basic_fstream(
  const string&amp; s,
  ios_base::openmode mode = ios_base::in | ios_base::out);
</pre>
<blockquote>
<p>
<ins>-?- <i>Effects:</i> Equivalent to: <tt>basic_fstream(s.c_str(), mode)</tt>.</ins>
</p>
</blockquote>
<pre>
<ins>template&lt;class T&gt;</ins>
explicit basic_fstream(
  const <del>filesystem::path</del><ins>T</ins>&amp; s,
  ios_base::openmode mode = ios_base::in | ios_base::out);
</pre>
<blockquote>
<p>
<ins>-?- <i>Constraints:</i> <tt>is_same_v&lt;T, filesystem::path&gt;</tt> is <tt>true</tt>.</ins>
<p/>
-3- <i>Effects:</i> Equivalent to: <tt>basic_fstream(s.c_str(), mode)</tt>.
</p>
</blockquote>
</blockquote>
</li>

</ol>




</body>
</html>
