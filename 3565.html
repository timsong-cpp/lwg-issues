<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3565: Handling of encodings in localized formatting of chrono types is underspecified</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3565" href="lwg-active.html#3565">3565.</a> Handling of encodings in localized formatting of <tt>chrono</tt> types is underspecified</h3>
<p><b>Section:</b> 29.12 <a href="https://timsong-cpp.github.io/cppwp/time.format">[time.format]</a> <b>Status:</b> <a href="lwg-active.html#SG16">SG16</a>
 <b>Submitter:</b> Victor Zverovich <b>Opened:</b> 2021-05-31 <b>Last modified:</b> 2021-06-14 14:05:22 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View all other</b> <a href="lwg-index.html#time.format">issues</a> in [time.format].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#SG16">SG16</a> status.</p>
<p><b>Discussion:</b></p>
<p>
When formatting chrono types using a locale the result is underspecified, possibly a mix of the literal and locale encodings. For example:
</p>
<blockquote><pre>
std::locale::global(std::locale("Russian.1251"));
auto s = std::format("&Dcy;&iecy;&ncy;&softcy; &ncy;&iecy;&dcy;&iecy;&lcy;&icy;: {}", std::chrono::Monday);
</pre></blockquote>
<p>
(Note that "<tt>{}</tt>" should be replaced with "<tt>{:L}</tt>" if <a href="https://wg21.link/P2372">P2372</a> is adopted but that's non-essential.)
<p/>
If the literal encoding is UTF-8 and the <tt>"Russian.1251"</tt> locale exists we have a mismatch between encodings. 
As far as I can see the standard doesn't specify what happens in this case.
<p/>
One possible and undesirable result is
</p>
<blockquote><pre>
"&Dcy;&iecy;&ncy;&softcy; &ncy;&iecy;&dcy;&iecy;&lcy;&icy;: \xcf\xed"
</pre></blockquote>
<p>
where <tt>"\xcf\xed"</tt> is <tt>"&Pcy;&ncy;"</tt> (Mon in Russian) in CP1251 and is not valid UTF-8.
<p/>
Another possible and desirable result is
</p>
<blockquote><pre>
"&Dcy;&iecy;&ncy;&softcy; &ncy;&iecy;&dcy;&iecy;&lcy;&icy;: &Pcy;&ncy;"
</pre></blockquote>
<p>
where everything is in one encoding (UTF-8).
<p/>
This issue is not resolved by LWG <a href="3547">3547</a> / <a href="https://wg21.link/P2372">P2372</a> but the resolution proposed here is 
compatible with P2372 and can be rebased onto its wording if the paper is adopted.
</p>

<p><i>[2021-06-14; Reflector poll]</i></p>

<p>
Set priority to 2 after reflector poll. Send to SG16.
</p>



<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/n4885">N4885</a>.
</p>

<ol>
<li><p>Modify 29.12 <a href="https://timsong-cpp.github.io/cppwp/time.format">[time.format]</a> as indicated:</p>

<blockquote>
<p>
-2- Each conversion specifier <i>conversion-spec</i> is replaced by appropriate characters as described in Table 
[tab:time.format.spec]; the formats specified in ISO 8601:2004 shall be used where so described. Some of the 
conversion specifiers depend on the locale that is passed to the formatting function if the latter takes one, 
or the global locale otherwise. <ins>If the string literal encoding is UTF-8 the replacement of a conversion 
specifier that depends on the locale is transcoded to UTF-8 for narrow strings, otherwise the replacement is 
taken as is.</ins> If the formatted object does not contain the information the conversion specifier refers to, 
an exception of type <tt>format_error</tt> is thrown.
</p>
</blockquote>
</li>

</ol>




</body>
</html>
