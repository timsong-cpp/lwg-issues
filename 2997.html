<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 2997: LWG 491 and the specification of {forward_,}list::unique</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="2997" href="lwg-active.html#2997">2997.</a> LWG 491 and the specification of <tt>{forward_,}list::unique</tt></h3>
<p><b>Section:</b> 22.3.10.5 <a href="https://timsong-cpp.github.io/cppwp/list.ops">[list.ops]</a>, 22.3.9.6 <a href="https://timsong-cpp.github.io/cppwp/forwardlist.ops">[forwardlist.ops]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Tim Song <b>Opened:</b> 2017-07-07 <b>Last modified:</b> 2017-07-12 03:44:21 UTC</p>
<p><b>Priority: </b>3
</p>
<p><b>View all other</b> <a href="lwg-index.html#list.ops">issues</a> in [list.ops].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
There are various problems with the specification of <tt>list::unique</tt> and its <tt>forward_list</tt> counterpart, some of which are obvious even on cursory inspection:
<ul>
<li>It refers to the identifiers <tt>first</tt> and <tt>last</tt>, which aren't even defined.</li>
<li>It uses <tt>i - 1</tt> on non-random-access iterators - in the case of <tt>forward_list</tt>, on forward-only iterators.</li>
<li>The resolution of LWG <a href="202">202</a>, changing the specification of <tt>std::unique</tt> to require an equivalence relation 
    and adjusting the order of comparison, weren't applied to these member functions.</li>
</ul>
<p/>
LWG <a href="491">491</a>, which pointed out many of those problems with the specification of <tt>list::unique</tt>, was closed as NAD with the rationale that
<blockquote>
"All implementations known to the author of this Defect Report comply with these assumption", and "no impact on current code is expected", i.e. there is no evidence of real-world confusion or harm.
</blockquote>
That implementations somehow managed to do the right thing in spite of obviously defective standardese doesn't seem like a good reason to not fix the defects.
</p>

<p><i>[2017-07 Toronto Tuesday PM issue prioritization]</i></p>

<p>Priority 3; by the way, there's general wording in 25.2 <a href="https://timsong-cpp.github.io/cppwp/algorithms.requirements">[algorithms.requirements]</a> p10 that lets us specify iterator arithmetic as if we were using random access iterators.</p>
    
<p><i>[2017-07-11 Tim comments]</i></p>

<p>I drafted the P/R fully aware of the general wording in 25.2 <a href="https://timsong-cpp.github.io/cppwp/algorithms.requirements">[algorithms.requirements]</a> p10. However, that general wording is limited to Clause 28, so to make use of the shorthand permitted
by that wording, we would need additional wording importing it to these subclauses.
<p/>
Moreover, that general wording only defines <tt>a+n</tt> and <tt>b-a</tt>; it notably doesn't define <tt>a-n</tt>, which is needed here. And one cannot merely define <tt>a-n</tt> as
<tt>a+(-n)</tt> since that has undefined behavior for forward iterators.
</p>


<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to <a href="https://wg21.link/n4659">N4659</a>.
</p>

<ol>
<li><p>Edit 22.3.10.5 <a href="https://timsong-cpp.github.io/cppwp/list.ops">[list.ops]</a> as indicated:</p>
<blockquote>
<pre>
void unique();
template &lt;class BinaryPredicate&gt; void unique(BinaryPredicate binary_pred);
</pre>
<blockquote><p>
<ins>-?- <i>Requires:</i> The comparison function shall be an equivalence relation. </ins>
<p/>
-19- <i>Effects:</i> <ins>If <tt>empty()</tt>, has no effects. Otherwise, e</ins><del>E</del>rases all but the first element from every consecutive 
group of <del>equal</del><ins>equivalent</ins> elements referred to by the iterator <tt>i</tt> in the range <tt><del>[first + 1, last)</del><ins>[next(begin()), end())</ins></tt>
for which <tt><del>*i == *(i-1)</del><ins>*j == *i</ins></tt> (for the version of <tt>unique</tt> with no arguments) or
<tt><del>pred(*i, *(i - 1))</del><ins>pred(*j, *i)</ins></tt> (for the version of <tt>unique</tt> with a predicate argument) holds<ins>,
where <tt>j</tt> is an iterator in <tt>[begin(), end())</tt> such that <tt>next(j) == i</tt></ins>. Invalidates only the iterators and references to the erased elements.
<p/>
-20- <i>Throws:</i> Nothing unless an exception is thrown by <del><tt>*i == *(i-1)</tt> or <tt>pred(*i, *(i - 1))</tt></del><ins> the equality comparison or the predicate</ins>.
<p/>
-21- <i>Complexity:</i> If <del>the range <tt>[first, last)</tt> is not empty</del><ins><tt>!empty()</tt></ins>, exactly <tt><del>(last - first) - 1</del><ins>size() - 1</ins></tt>
applications of the corresponding predicate, otherwise no applications of the predicate.
</p>
</blockquote>
</blockquote>
</li>

<li><p>Edit 22.3.9.6 <a href="https://timsong-cpp.github.io/cppwp/forwardlist.ops">[forwardlist.ops]</a> as indicated:</p>
<blockquote>
<pre>
void unique();
template &lt;class BinaryPredicate&gt; void unique(BinaryPredicate binary_pred);
</pre>
<blockquote><p>
<ins>-?- <i>Requires:</i> The comparison function shall be an equivalence relation. </ins>
<p/>
-16- <i>Effects:</i> <ins>If <tt>empty()</tt>, has no effects. Otherwise, e</ins><del>E</del>rases all but the first element from every consecutive 
group of <del>equal</del><ins>equivalent</ins> elements referred to by the iterator <tt>i</tt> in the range <tt><del>[first + 1, last)</del><ins>[next(begin()), end())</ins></tt>
for which <tt><del>*i == *(i-1)</del><ins>*j == *i</ins></tt> (for the version with no arguments) or 
<tt><del>pred(*i, *(i - 1))</del><ins>pred(*j, *i)</ins></tt> (for the version with a predicate argument) holds<ins>,
where <tt>j</tt> is an iterator in <tt>[begin(), end())</tt> such that <tt>next(j) == i</tt></ins>. Invalidates only the iterators and references to the erased elements.
<p/>
-17- <i>Throws:</i> Nothing unless an exception is thrown by the equality comparison or the predicate.
<p/>
-18- <i>Complexity:</i> If <del>the range <tt>[first, last)</tt> is not empty</del><ins><tt>!empty()</tt></ins>, exactly 
<tt><del>(last - first) - 1</del><ins>distance(begin(), end()) - 1</ins></tt> applications of the corresponding predicate,
 otherwise no applications of the predicate.
</p>
</blockquote>
</blockquote>
</li>
</ol>




</body>
</html>
