<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 2687: {inclusive,exclusive}_scan misspecified</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<p>Revised 2016-11-16 at 09:11:03 UTC</p>
<hr>
<h3><a name="2687" href="2687">2687.</a> <tt>{inclusive,exclusive}_scan</tt> misspecified</h3>
<p><b>Section:</b> 26.8.7 [exclusive.scan], 26.8.8 [inclusive.scan], 26.8.9 [transform.exclusive.scan], 26.8.10 [transform.inclusive.scan] <b>Status:</b> <a href="lwg-active.html#WP">WP</a>
 <b>Submitter:</b> Tim Song <b>Opened:</b> 2016-03-21 <b>Last modified:</b> 2016-11-16</p>
<p><b>Priority: </b>1
</p>
<p><b>View all issues with</b> <a href="lwg-status.html#WP">WP</a> status.</p>
<p><b>Discussion:</b></p>
<p>
When P0024R2 changed the description of <tt>{inclusive,exclusive}_scan</tt> (and the <tt>transform_</tt> version), 
it seems to have introduced an off-by-one error. Consider what N4582 26.8.8 [inclusive.scan]/2 says of 
<tt>inclusive_scan</tt>:
</p>
<blockquote>
<p>
Effects: Assigns through each iterator <tt>i</tt> in <tt>[result, result + (last - first))</tt> the value of
</p>
<ul>
<li><p>
<tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init, *j, ...)</tt> for every <tt>j</tt> in <tt>[first, first
+ (i - result))</tt> if <tt>init</tt> is provided, or
</p></li>
<li><p>
<tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, *j, ...)</tt> for every <tt>j</tt> in <tt>[first, first + (i
- result))</tt> otherwise.
</p></li>
</ul>
</blockquote>
<p>
When <tt>i == result</tt>, <tt>i - result = 0</tt>, so the range <tt>[first, first + (i - result))</tt> is 
<tt>[first, first)</tt> &mdash; which is empty. Thus according to the specification, we should assign 
<tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init)</tt> if <tt>init</tt> is provided, or 
<tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op)</tt> otherwise, which doesn't seem "inclusive" &mdash; and isn't 
even defined in the second case.
<p/>
The parallelism TS's version uses <tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, *first, ..., *(first + (i - result)))</tt> &mdash; 
which is a closed range, not a half-open one.
<p/>
Similar issues affect <tt>exclusive_scan</tt>, <tt>transform_inclusive_scan</tt>, and <tt>transform_exclusive_scan</tt>. 
</p>
<p><i>[2016-06 Oulu]</i></p>

<p>Voted to Ready 11-0 Tuesday evening in Oulu</p>


<p><b>Proposed resolution:</b></p>
<p>
This wording is relative to N4582.
</p>
<ol>
<li><p>Edit 26.8.7 [exclusive.scan]/2 as indicated:</p>
<blockquote class="note">
<p>
[<i>Drafting note</i>: when <tt>i</tt> is <tt>result</tt>, <tt>[first, first + (i - result))</tt> is an empty range, 
so the value to be assigned reduces to <tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init)</tt>, which is 
<tt>init</tt>, so there's no need to special case this.]
</p>
</blockquote>

<blockquote><pre>
template&lt;class InputIterator, class OutputIterator, class T, class BinaryOperation&gt;
  OutputIterator exclusive_scan(InputIterator first, InputIterator last,
                                OutputIterator result,
                                T init, BinaryOperation binary_op);
</pre>
<blockquote>
<p>
-2- <i>Effects</i>: Assigns through each iterator <tt>i</tt> in <tt>[result, result + (last - first))</tt> the value of
<ins><tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init, *j, ...)</tt> for every <tt>j</tt> in 
<tt>[first, first + (i - result))</tt>.</ins></p>
<ul>
<li><p>
<del><tt>init</tt>, if <tt>i</tt> is <tt>result</tt>, otherwise</del>
</p></li>
<li><p>
<del><tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init, *j, ...)</tt> for every <tt>j</tt> in <tt>[first, first
+ (i - result) - 1)</tt>.</del>
</p></li>
</ul>
</blockquote>
</blockquote>
</li>

<li><p>Edit 26.8.8 [inclusive.scan]/2 as indicated:</p>

<blockquote><pre>
template&lt;class InputIterator, class OutputIterator, class BinaryOperation&gt;
  OutputIterator inclusive_scan(InputIterator first, InputIterator last,
                                OutputIterator result,
                                BinaryOperation binary_op);
template&lt;class InputIterator, class OutputIterator, class BinaryOperation&gt;
  OutputIterator inclusive_scan(InputIterator first, InputIterator last,
                                OutputIterator result,
                                BinaryOperation binary_op, T init);
</pre>
<blockquote>
<p>
-2- <i>Effects</i>: Assigns through each iterator <tt>i</tt> in <tt>[result, result + (last - first))</tt> the value of
</p>
<ul>
<li><p>
<tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init, *j, ...)</tt> for every <tt>j</tt> in <tt>[first, first
+ (i - result <ins>+ 1</ins>))</tt> if <tt>init</tt> is provided, or
</p></li>
<li><p>
<tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, *j, ...)</tt> for every <tt>j</tt> in <tt>[first, first
+ (i - result <ins>+ 1</ins>))</tt> otherwise.
</p></li>
</ul>
</blockquote>
</blockquote>
</li>

<li><p>Edit 26.8.9 [transform.exclusive.scan]/1 as indicated:</p>

<blockquote><pre>
template&lt;class InputIterator, class OutputIterator,
         class UnaryOperation,
         class T, class BinaryOperation&gt;
  OutputIterator transform_exclusive_scan(InputIterator first, InputIterator last,
                                          OutputIterator result,
                                          UnaryOperation unary_op,
                                          T init, BinaryOperation binary_op);
</pre>
<blockquote>
<p>
-1- <i>Effects</i>: Assigns through each iterator <tt>i</tt> in <tt>[result, result + (last - first))</tt> the value of
<ins><tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init, unary_op(*j), ...)</tt> for every <tt>j</tt> in 
<tt>[first, first + (i - result))</tt>.</ins></p>
<ul>
<li><p>
<del><tt>init</tt>, if <tt>i</tt> is <tt>result</tt>, otherwise</del>
</p></li>
<li><p>
<del><tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init, unary_op(*j), ...)</tt> for every <tt>j</tt> in 
<tt>[first, first + (i - result) - 1)</tt>.</del>
</p></li>
</ul>
</blockquote>
</blockquote>
</li>

<li><p>Edit 26.8.10 [transform.inclusive.scan]/1 as indicated:</p>

<blockquote><pre>
template&lt;class InputIterator, class OutputIterator,
         class UnaryOperation,
         class BinaryOperation&gt;
  OutputIterator transform_inclusive_scan(InputIterator first, InputIterator last,
                                          OutputIterator result,
                                          UnaryOperation unary_op,
                                          BinaryOperation binary_op);
template&lt;class InputIterator, class OutputIterator,
         class UnaryOperation,
         class BinaryOperation, class T&gt;
  OutputIterator transform_inclusive_scan(InputIterator first, InputIterator last,
                                          OutputIterator result,
                                          UnaryOperation unary_op,
                                          BinaryOperation binary_op, T init);
</pre>
<blockquote>
<p>
-1- <i>Effects</i>: Assigns through each iterator <tt>i</tt> in <tt>[result, result + (last - first))</tt> the value of
</p>
<ul>
<li><p>
<tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, init, unary_op(*j), ...)</tt> for every <tt>j</tt> in <tt>[first, first
+ (i - result <ins>+ 1</ins>))</tt> if <tt>init</tt> is provided, or
</p></li>
<li><p>
<tt><i>GENERALIZED_NONCOMMUTATIVE_SUM</i>(binary_op, unary_op(*j), ...)</tt> for every <tt>j</tt> in <tt>[first, first
+ (i - result <ins>+ 1</ins>))</tt> otherwise.
</p></li>
</ul>
</blockquote>
</blockquote>
</li>
</ol>





</body>
</html>
