<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3344: advance(i, most-negative) and prev(i, most-negative)</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<hr>
<h3><a name="3344" href="lwg-active.html#3344">3344.</a> <tt>advance(i, <i>most-negative</i>)</tt> and <tt>prev(i, <i>most-negative</i>)</tt></h3>
<p><b>Section:</b> 23.4.2 <a href="https://timsong-cpp.github.io/cppwp/iterator.operations">[iterator.operations]</a>, 23.4.3.1 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.advance">[range.iter.op.advance]</a> <b>Status:</b> <a href="lwg-active.html#New">New</a>
 <b>Submitter:</b> Casey Carter <b>Opened:</b> 2019-11-22 <b>Last modified:</b> 2019-12-07 13:45:41 UTC</p>
<p><b>Priority: </b>3
</p>
<p><b>View other</b> <a href="lwg-index-open.html#iterator.operations">active issues</a> in [iterator.operations].</p>
<p><b>View all other</b> <a href="lwg-index.html#iterator.operations">issues</a> in [iterator.operations].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#New">New</a> status.</p>
<p><b>Discussion:</b></p>
<p>
<tt>ranges::advance</tt> (23.4.3.1 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.advance">[range.iter.op.advance]</a>) and <tt>std::advance</tt> 
(23.4.2 <a href="https://timsong-cpp.github.io/cppwp/iterator.operations">[iterator.operations]</a>) can be called with a negative count <tt>n</tt> when the 
iterator argument <tt>i</tt> models <tt>bidirectional_iterator</tt> (respectively, meets the 
<i>Cpp17BidirectionalIterator</i> requirements). In this case, they are specified to "decrement <tt>i</tt> 
by <tt>-n</tt>". If <tt>n</tt> is the most-negative value of a signed integral type, the expression <tt>-n</tt> 
has undefined behavior. This UB is unfortunate given that typical implementations never actually 
form the expression <tt>-n</tt>. It's nonsensical to describe the effects of a function in terms 
of an expression with undefined behavior, so we should either define the behavior or exclude 
this case via precondition.
<p/>
<tt>ranges::prev()</tt> and <tt>std::prev</tt> (23.4.2 <a href="https://timsong-cpp.github.io/cppwp/iterator.operations">[iterator.operations]</a>) have a similar problem: 
<tt>prev(i, n)</tt> is equivalent to:
</p>
<blockquote><pre>
advance(i, -n); 
return i;
</pre></blockquote>
<p>
which has undefined behavior when <tt>n</tt> is <tt>numeric_limits&lt;T&gt;::min()</tt> where <tt>T</tt> 
is <tt>iter_difference_t&lt;decltype(i)&gt;</tt> (for <tt>ranges::prev</tt>) or some signed integral type 
(for <tt>std::prev</tt>). There <em>is</em> an implicit precondition here thanks to "<i>Effects:</i> Equivalent 
to" since the equivalent code has a precondition that <tt>n</tt> is not a most-negative value, so 
this wording is not defective. We could, however, define behavior for <tt>prev</tt> regardless of the 
value of <tt>n</tt> by duplicating the specification of advance and inverting the "direction" of the 
operations. We should consider doing so.
</p>

<p><i>[2019-12-07 Issue Prioritization]</i></p>

<p>Priority to 3 after reflector discussion.</p>


<p><b>Proposed resolution:</b></p>
<p>This wording is relative to <a href="https://wg21.link/n4835">N4835</a>.</p>

<blockquote class="note">
<p>
[<i>Drafting note:</i> I've chosen to provide wording for the conservative "define behavior for 
<tt>advance</tt> and leave <tt>prev</tt> as status quo" middle ground.
<p/>
The occurrences of "|" in the below are math-font vertical bars (indicating absolute value). I've 
changed both positive and negative cases for consistency of presentation.
]
</p>
</blockquote>

<ol>
<li><p>Modify 23.4.2 <a href="https://timsong-cpp.github.io/cppwp/iterator.operations">[iterator.operations]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;class InputIterator, class Distance&gt;
  constexpr void advance(InputIterator&amp; i, Distance n);
</pre>
<blockquote>
<p>
-2- <i>Expects:</i> <tt>n</tt> is negative only for bidirectional iterators.
<p/>
-3- <i>Effects:</i> Increments <tt>i</tt> by <tt><ins>|</ins>n<ins>|</ins></tt> if <tt>n</tt> is 
non-negative, and decrements <tt>i</tt> by <tt><del>-</del><ins>|</ins>n<ins>|</ins></tt> otherwise.
</p>
</blockquote>
</blockquote>
</li>

<li><p>Modify 23.4.3.1 <a href="https://timsong-cpp.github.io/cppwp/range.iter.op.advance">[range.iter.op.advance]</a> as indicated:</p>

<blockquote>
<pre>
template&lt;input_or_output_iterator I&gt;
  constexpr void ranges::advance(I&amp; i, iter_difference_t&lt;I&gt; n);
</pre>
<blockquote>
<p>
-1- <i>Expects:</i> If <tt>I</tt> does not model <tt>bidirectional_iterator</tt>, <tt>n</tt> is not negative.
<p/>
-2- <i>Effects:</i>
<ol style="list-style-type: none">
<li><p>(2.1) &mdash; If <tt>I</tt> models <tt>random_access_iterator</tt>, 
equivalent to <tt>i += n</tt>.</p></li>
<li><p>(2.2) &mdash; Otherwise, if <tt>n</tt> is non-negative, increments <tt>i</tt> by 
<tt><ins>|</ins>n<ins>|</ins></tt>.</p></li>
<li><p>(2.3) &mdash; Otherwise, decrements <tt>i</tt> by <tt><del>-</del><ins>|</ins>n<ins>|</ins></tt>.</p></li>
</ol>
</p>
</blockquote>
[&hellip;]
<pre>
template&lt;input_or_output_iterator I, sentinel_for&lt;I&gt; S&gt;
  constexpr iter_difference_t&lt;I&gt; ranges::advance(I&amp; i, iter_difference_t&lt;I&gt; n, S bound);
</pre>
<blockquote>
<p>
-5- <i>Expects:</i> [&hellip;]
<p/>
-6- <i>Effects:</i>
<ol style="list-style-type: none">
<li><p>(6.1) &mdash; If <tt>S</tt> and <tt>I</tt> model 
<tt>sized_sentinel_for&lt;S, I&gt;</tt>:</p>
<ol style="list-style-type: none">
<li><p>(6.1.1) &mdash; If <tt>|n| &ge; |bound - i|</tt>, equivalent to <tt>ranges::advance(i, bound)</tt>.:</p>
</li>
<li><p>(6.1.2) &mdash; Otherwise, equivalent to <tt>ranges::advance(i, n)</tt>.</p></li>
</ol>
</li>
<li><p>(6.2) &mdash; Otherwise,</p>
<ol style="list-style-type: none">
<li><p>(6.2.1) &mdash; if <tt>n</tt> is non-negative, while <tt>bool(i != bound)</tt> is <tt>true</tt>, 
increments <tt>i</tt> but at most <tt><ins>|</ins>n<ins>|</ins></tt> times.:</p>
</li>
<li><p>(6.2.2) &mdash; Otherwise, while <tt>bool(i != bound)</tt> is <tt>true</tt>, decrements <tt>i</tt> 
but at most <tt><del>-</del><ins>|</ins>n<ins>|</ins></tt> times.</p></li>
</ol>
</li>
</ol>
</p>
</blockquote>
</blockquote>
</li>
</ol>




</body>
</html>
