<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 3611: Should compare_exchange be allowed to modify the expected value on success?</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
  @media (prefers-color-scheme: dark) {
     html {
        color: #ddd;
        background-color: black;
     }
     ins {
        background-color: #225522
     }
     del {
        background-color: #662222
     }
     a {
        color: #6af
     }
     a:visited {
        color: #6af
     }
     blockquote.note
     {
        background-color: rgba(255, 255, 255, .10)
     }
  }
</style>
</head>
<body>
<hr>
<h3><a name="3611" href="lwg-active.html#3611">3611.</a> Should <tt>compare_exchange</tt> be allowed to modify the <tt>expected</tt> value on success?</h3>
<p><b>Section:</b> 33.5.8.2 <a href="https://timsong-cpp.github.io/cppwp/atomics.types.operations">[atomics.types.operations]</a> <b>Status:</b> <a href="lwg-active.html#Open">Open</a>
 <b>Submitter:</b> Jonathan Wakely <b>Opened:</b> 2021-09-29 <b>Last modified:</b> 2022-07-07 09:14:03 UTC</p>
<p><b>Priority: </b>2
</p>
<p><b>View other</b> <a href="lwg-index-open.html#atomics.types.operations">active issues</a> in [atomics.types.operations].</p>
<p><b>View all other</b> <a href="lwg-index.html#atomics.types.operations">issues</a> in [atomics.types.operations].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#Open">Open</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Currently a <tt>compare_exchange</tt> will only update the <tt>expected</tt> parameter if the
<tt>compare_exchange</tt> fails. This precludes unconditionally clearing the padding bits of the
<tt>expected</tt> object prior to doing the <tt>compare_exchange</tt>, which complicates the
implementation by requiring additional work (e.g. making a copy of the <tt>expected</tt> value
and clearing the copy's padding, then copying it back to expected only if the <tt>compare_exchange</tt> fails).
<p/>
We should consider whether we want to allow modifications to <tt>expected</tt> in the success case,
if such modifications only affect padding bits (i.e. do not alter the value). If we want to allow it,
we need to say so explicitly. The current wording does not permit modifications in the success case,
and any such modification could create a data race if another thread is reading the same memory location
(if it knows a priori that a <tt>compare_exchange_strong</tt> would succeed and so not write to that location).
</p>

<p><i>[2021-10-14; Reflector poll]</i></p>

<p>
Set priority to 2 after reflector poll. Send to SG1.
</p>
<p>
This is <a href="2426">2426</a> again,
but the new requirement to clear padding bits changes things.
</p>

<p><i>[2022-07-06; Move to "Open" following SG1 feedback]</i></p>

<p>
Allow compare_exchange to modify the expected value on success?
<table>
<tr><td>SF</td><td>F</td><td>N</td><td>A</td><td>SA</td></tr>
<tr><td>0</td><td>0</td><td>0</td><td>5</td><td>4</td></tr>
</table>
</p>



<p><b>Proposed resolution:</b></p>





</body>
</html>
