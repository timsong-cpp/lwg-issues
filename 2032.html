<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta charset="utf-8">
<title>Issue 2032: Incorrect synchronization clause of async function</title>
<style type="text/css">
  p {text-align:justify}
  li {text-align:justify}
  blockquote.note
  {
    background-color:#E0E0E0;
    padding-left: 15px;
    padding-right: 15px;
    padding-top: 1px;
    padding-bottom: 1px;
  }
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
  table {border-collapse: collapse;}
</style>
</head>
<body>
<p>Revised 2016-11-16 at 09:11:03 UTC</p>
<hr>
<h3><a name="2032" href="2032">2032.</a> Incorrect synchronization clause of <tt>async</tt> function</h3>
<p><b>Section:</b> 30.6.8 [futures.async] <b>Status:</b> <a href="lwg-active.html#C++11">C++11</a>
 <b>Submitter:</b> Alberto Ganesh Barbati <b>Opened:</b> 2011-02-17 <b>Last modified:</b> 2016-11-16</p>
<p><b>Priority: </b>Not Prioritized
</p>
<p><b>View all other</b> <a href="lwg-index.html#futures.async">issues</a> in [futures.async].</p>
<p><b>View all issues with</b> <a href="lwg-status.html#C++11">C++11</a> status.</p>
<p><b>Discussion:</b></p>
<p>
Clause 30.6.8 [futures.async] has undergone significant rewording
in Batavia. Due to co-presence of at least three different sources
of modification there is a part where changes have overlapped
(marked by an Editor's note), which should be reconciled. Moreover,
I believe that a few non-overlapping sentences are now incorrect
and should be fixed, so the problem cannot be handled editorially.
(See c++std-lib-29667.)
</p>

<p><i>[Adopted in Madrid, 2011-03]</i></p>




<p><b>Proposed resolution:</b></p>
<ol>
<li>
<p> 
Edit 30.6.4 [futures.state], paragraph 3 as follows.
</p>

<blockquote>
<p>
An <dfn>asynchronous return object</dfn>
is an object that reads results from an associated asynchronous state.
A <dfn>waiting function</dfn> of an asynchronous return object
is one that potentially blocks
to wait for the associated asynchronous state to be made ready.
<ins>If a waiting function can return
before the state is made ready because of a timeout (30.2.5),
then it is a <dfn>timed waiting function</dfn>,
otherwise it is a <dfn>non-timed waiting function</dfn>.</ins>
</p>
</blockquote>
</li>

<li>
<p>
Edit within 30.6.8 [futures.async] paragraph 3 bullet 2 as follows.
</p>

<blockquote>
<p>
<i>Effects:</i>
[...]
</p>
<ul><li>if <code>policy &amp; launch::deferred</code> is non-zero &mdash; [...]
The associated asynchronous state is not made ready
until the function has completed.
The first call to a <ins>non-timed waiting</ins> function
<ins>(30.6.4 [futures.state])</ins>
<del>requiring a non-timed wait</del>
on an asynchronous return object
referring to <del>the</del> <ins>this</ins>
associated asynchronous state
<del>created by this <code>async</code> call to become ready</del>
shall invoke the deferred function
in the thread that called the waiting function<del>;</del><ins>.</ins>
<del>once</del> <ins>Once</ins> evaluation of
<code><var>INVOKE</var>(g, xyz)</code> begins,
the function is no longer considered deferred.
[...]
</li></ul>
</blockquote>
</li>

<li>
<p>
Edit 30.6.8 [futures.async] paragraph 5 as follows.
</p>

<blockquote>
<p>
<i>Synchronization:</i>
Regardless of the provided <code>policy</code> argument,
</p>
<ul>
<li>
the invocation of <code>async</code> synchronizes with (1.10)
the invocation of <code>f</code>.
[<i>Note:</i>
this statement applies even when the corresponding future object
is moved to another thread.
&mdash;<i>end note</i>];
and
</li>
<li>
the completion of the function <code>f</code>
is sequenced before (1.10) the associated asynchronous state is made ready.
[<i>Note:</i>
<code>f</code> might not be called at all,
so its completion might never happen.
&mdash;<i>end note</i>]
</li>
</ul>

<p>
<del>If <code>policy &amp; launch::async</code> is non-zero,</del>
<ins>If the implementation chooses the <code>launch::async</code> policy,</ins>
</p>
<ul>
<li>
a call to a waiting function on an asynchronous return object
that shares the associated asynchronous state
created by this <code>async</code> call
shall block until the associated thread has completed,
as if joined (30.3.1.5);
</li>
<li>
<del>the <code>join()</code> on the created thread object</del>
<ins>the associated thread completion</ins>
synchronizes with (1.10)
the return from the first function
that successfully detects the ready status of the associated asynchronous state
or with the return from the last function that 
releases the associated asynchronous state <del>returns</del>,
whichever happens first.
<del><b>[Editor's note:
N3196 changes the following sentence as indicated.
N3188 removes the sentence.
Please pick one.]</b>
If the invocation is deferred,
the completion of the invocation of the deferred function
synchronizes with the successful return
from a call to a waiting function on the associated asynchronous state.</del>
</li>
</ul>
</blockquote>

</li>
</ol>






</body>
</html>
